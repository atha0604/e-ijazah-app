function updateHeaderSchoolName(){try{if(!window.currentUser||!window.currentUser.schoolData)return;const e=window.currentUser.schoolData[4]||window.currentUser.schoolData[5];if(!e)return;const t=document.querySelector("#adminDashboard .dashboard-header .user-profile .user-info h3");t&&(t.textContent=e,t.title=e);const a=document.querySelector("#sekolahDashboard .dashboard-header .user-profile .user-info h3");a&&(a.textContent=e,a.title=e)}catch(e){}}const loginPage=document.getElementById("loginPage"),adminDashboard=document.getElementById("adminDashboard"),sekolahDashboard=document.getElementById("sekolahDashboard"),appCodeInput=document.getElementById("appCode"),editModal=document.getElementById("editModal"),transkripModal=document.getElementById("transkripModal"),sklModal=document.getElementById("sklModal"),skkbModal=document.getElementById("skkbModal"),editSiswaForm=document.getElementById("editSiswaForm"),loginInfoModal=document.getElementById("loginInfoModal"),versionInfoBadge=document.getElementById("version-info-badge"),loadingOverlay=document.getElementById("loadingOverlay");function initializeModals(){[editModal,transkripModal,sklModal,skkbModal,loginInfoModal].forEach(e=>{e&&(e.style.display="none")})}initializeModals(),window.loginInfoModalShown=!1;let database={sekolah:[],siswa:[],nilai:{},settings:{},sklPhotos:{}},paginationState={sekolah:{currentPage:1,rowsPerPage:10},siswa:{currentPage:1,rowsPerPage:10},sekolahSiswa:{currentPage:1,rowsPerPage:10},isiNilai:{currentPage:1,rowsPerPage:10,currentSemester:null,currentSemesterName:null},transkripNilai:{currentPage:1,rowsPerPage:10},skl:{currentPage:1,rowsPerPage:10},skkb:{currentPage:1,rowsPerPage:10},cetakGabungan:{currentPage:1,rowsPerPage:10},rekapNilai:{currentPage:1,rowsPerPage:10},rekapNilaiAdmin:{currentPage:1,rowsPerPage:10}},tableDataCache={sekolah:{filteredData:null,lastSearchTerm:"",lastSortKey:"",lastSortDirection:"asc",lastTimestamp:0},siswa:{filteredData:null,lastSearchTerm:"",lastSortKey:"",lastSortDirection:"asc",lastTimestamp:0},sekolahSiswa:{filteredData:null,lastSearchTerm:"",lastSortKey:"",lastSortDirection:"asc",lastTimestamp:0},isiNilai:{filteredData:null,lastSearchTerm:"",lastSortKey:"",lastSortDirection:"asc",lastTimestamp:0},transkripNilai:{filteredData:null,lastSearchTerm:"",lastSortKey:"",lastSortDirection:"asc",lastTimestamp:0},cetakGabungan:{filteredData:null,lastSearchTerm:"",lastSortKey:"",lastSortDirection:"asc",lastTimestamp:0},rekapNilai:{filteredData:null,lastSearchTerm:"",lastSortKey:"",lastSortDirection:"asc",lastTimestamp:0},rekapNilaiAdmin:{filteredData:null,lastSearchTerm:"",lastSortKey:"",lastSortDirection:"asc",lastTimestamp:0}};function invalidateTableCache(e){tableDataCache[e]&&(tableDataCache[e].filteredData=null,tableDataCache[e].lastTimestamp=0)}function getFilteredAndSortedData(e,t,a,n,o){const i=tableDataCache[e];if(!i)return t;const s=Date.now();if(null!==i.filteredData&&i.lastSearchTerm===a&&i.lastSortKey===n&&i.lastSortDirection===o&&s-i.lastTimestamp<3e4)return i.filteredData;let r=t;if(a&&""!==a.trim()){const e=a.toLowerCase();r=t.filter(t=>t.some(t=>String(t||"").toLowerCase().includes(e)))}return n&&""!==n.trim()&&(r=[...r].sort((e,t)=>{let a=e[n]||"",i=t[n]||"";const s=parseFloat(a),r=parseFloat(i);return isNaN(s)||isNaN(r)?(a=String(a).toLowerCase(),i=String(i).toLowerCase(),a<i?"asc"===o?-1:1:a>i?"asc"===o?1:-1:0):"asc"===o?s-r:r-s})),i.filteredData=r,i.lastSearchTerm=a,i.lastSortKey=n,i.lastSortDirection=o,i.lastTimestamp=s,r}function optimizedUpdatePaginationControls(e,t){requestAnimationFrame(()=>{const a=document.querySelector(`.pagination-controls[data-table-id="${e}"]`);if(!a)return;const n=paginationState[e];if(!n)return;const o="all"===n.rowsPerPage?t:parseInt(n.rowsPerPage,10),i=o>0?Math.ceil(t/o):1,s=a.querySelector(".pagination-info"),r=a.querySelector(".prev-page"),l=a.querySelector(".next-page"),d=(n.currentPage-1)*o+1,c=Math.min(n.currentPage*o,t);s&&(s.textContent=t>0?`${d}-${c} dari ${t} item`:"0 item");const u=a.querySelector(".rows-per-page");u&&u.value!==n.rowsPerPage&&(u.value=n.rowsPerPage),r&&(r.disabled=n.currentPage<=1),l&&(l.disabled=n.currentPage>=i)})}let searchDebounceTimers={};function debouncedSearch(e,t,a=300){searchDebounceTimers[e]&&clearTimeout(searchDebounceTimers[e]),searchDebounceTimers[e]=setTimeout(()=>{searchState[e]=t,paginationState[e].currentPage=1,rerenderActiveTable(e)},a)}let searchState={siswa:"",sekolahSiswa:"",isiNilai:"",transkripNilai:"",skl:"",skkb:"",cetakGabungan:"",rekapNilai:""},sortState={sekolah:{keyIndex:8,direction:"asc",type:"string"},siswa:{keyIndex:8,direction:"asc",type:"string"},sekolahSiswa:{keyIndex:8,direction:"asc",type:"string"},isiNilai:{keyIndex:8,direction:"asc",type:"string"},transkripNilai:{keyIndex:8,direction:"asc",type:"string"},skl:{keyIndex:8,direction:"asc",type:"string"},skkb:{keyIndex:8,direction:"asc",type:"string"},cetakGabungan:{keyIndex:8,direction:"asc",type:"string"},rekapNilai:{keyIndex:8,direction:"asc",keyType:"string"},rekapNilaiAdmin:{keyIndex:8,direction:"asc",keyType:"string"}};window.currentUser={isLoggedIn:!1,role:null,schoolData:null,loginType:null,kurikulum:null};let autosaveTimer=null,charts={completionChart:null,averageGradeChart:null};const subjects={K13:["AGAMA","PKN","B.INDO","MTK","IPA","IPS","SBDP","PJOK","MULOK1","MULOK2","MULOK3"],Merdeka:["AGAMA","PKN","B.INDO","MTK","IPAS","B.ING","SBDP","PJOK","MULOK1","MULOK2","MULOK3"]},transcriptSubjects={K13:[{display:"Pendidikan Agama dan Budi Pekerti",key:"AGAMA"},{display:"Pendidikan Pancasila dan Kewarganegaraan",key:"PKN"},{display:"Bahasa Indonesia",key:"B.INDO"},{display:"Matematika",key:"MTK"},{display:"Ilmu Pengetahuan Alam",key:"IPA"},{display:"Ilmu Pengetahuan Sosial",key:"IPS"},{display:"Seni Budaya dan Prakarya",key:"SBDP"},{display:"Pendidikan Jasmani, Olahraga dan Kesehatan",key:"PJOK"}],Merdeka:[{display:"Pendidikan Agama dan Budi Pekerti",key:"AGAMA"},{display:"Pendidikan Pancasila",key:"PKN"},{display:"Bahasa Indonesia",key:"B.INDO"},{display:"Matematika",key:"MTK"},{display:"Ilmu Pengetahuan Alam dan Sosial",key:"IPAS"},{display:"Bahasa Inggris",key:"B.ING"},{display:"Seni Budaya dan Prakarya",key:"SBDP"},{display:"Pendidikan Jasmani, Olahraga dan Kesehatan",key:"PJOK"}]},semesterMap={9:"KELAS 5 SEMESTER 1",10:"KELAS 5 SEMESTER 2",11:"KELAS 6 SEMESTER 1",12:"KELAS 6 SEMESTER 2"},semesterIds=Object.keys(semesterMap);function showButtonLoading(e,t){if(!e)return t;const a=e.textContent;return e.dataset.originalText=a,e.disabled=!0,e.style.opacity="0.7",e.textContent="Loading...",a}function hideButtonLoading(e,t){if(!e)return;e.disabled=!1,e.style.opacity="1";const a=t||e.dataset.originalText||"Masuk";e.textContent=a,e.dataset.originalText&&delete e.dataset.originalText}function showTableLoading(e,t="Memuat data..."){if(!e)return;const a=document.createElement("div");a.className="table-loading-overlay",a.innerHTML=`\n                <div class="table-loading-content">\n                    <div class="loading-message">${t}</div>\n                </div>\n            `,e.style.position="relative",e.appendChild(a)}function hideTableLoading(e){if(!e)return;const t=e.querySelector(".table-loading-overlay");t&&t.remove()}function getErrorMessage(e,t="operasi"){const a={"Network Error":"Koneksi internet bermasalah. Periksa koneksi Anda dan coba lagi.","Failed to fetch":"Tidak dapat terhubung ke server. Periksa koneksi internet Anda.",ECONNRESET:"Koneksi ke server terputus. Silakan coba lagi.",timeout:"Permintaan memakan waktu terlalu lama. Coba lagi dalam beberapa saat.",ENOTFOUND:"Server tidak dapat dijangkau. Periksa koneksi internet Anda.",Unauthorized:"Sesi Anda telah berakhir. Silakan login kembali.",401:"Sesi Anda telah berakhir. Silakan login kembali.",403:"Anda tidak memiliki izin untuk melakukan operasi ini.",404:"Data tidak ditemukan atau URL tidak valid.",500:"Terjadi kesalahan pada server. Silakan hubungi administrator.",502:"Server sedang bermasalah. Coba lagi dalam beberapa menit.",503:"Server sedang dalam pemeliharaan. Coba lagi nanti.",SQLITE_CONSTRAINT:"Data yang Anda masukkan melanggar aturan database.",duplicate:"Data sudah ada sebelumnya. Silakan gunakan data yang berbeda.",invalid:"Format data tidak valid. Periksa kembali input Anda.",missing:"Data yang diperlukan tidak lengkap. Pastikan semua field terisi."};if(!e)return`Gagal melakukan ${t}. Silakan coba lagi.`;const n=e.toString?e.toString():String(e),o=e.message||n;for(const[e,t]of Object.entries(a))if(o.toLowerCase().includes(e.toLowerCase()))return t;return o.length<100&&!o.includes("Error:")&&!o.includes("at ")?o:`Gagal melakukan ${t}. ${o.split(".")[0]}. Silakan coba lagi.`}function showSmartNotification(e,t="success",a="operasi"){let n;n="error"===t?getErrorMessage(e,a):e,showNotification(n,t)}function showAutosaveStatus(e){const t=document.getElementById("autosaveIndicator");t&&("saving"===e?(t.textContent="Menyimpan...",t.className="autosave-indicator saving"):"saved"===e?(t.textContent="✔ Tersimpan",t.className="autosave-indicator saved",setTimeout(()=>{t.className="autosave-indicator"},2e3)):t.className="autosave-indicator")}async function fetchWithAuth(e,t={}){const a=localStorage.getItem("jwtToken");if(!a)throw handleLogout?.(),new Error("Sesi tidak ditemukan. Silakan login kembali.");const n=/^https?:\/\//i.test(e)?e:apiUrl(e),o={"Content-Type":"application/json",...t.headers,Authorization:`Bearer ${a}`};try{const e=await fetch(n,{...t,headers:o});if(401===e.status||403===e.status)throw handleLogout?.(),new Error("Sesi Anda telah berakhir. Silakan login kembali.");const a=await e.json().catch(()=>({}));if(!e.ok)throw new Error(a.message||`HTTP ${e.status}: ${e.statusText}`);return a}catch(e){if(console.error("fetchWithAuth error:",{url:n,method:t.method||"GET",error:e.message,stack:e.stack}),e.message.includes("Failed to fetch")||"TypeError"===e.name)throw new Error("Koneksi ke server terputus. Periksa koneksi internet Anda dan coba lagi.");throw e}}function migrateLegacyProFlag(e,t){const a=localStorage.getItem("kodeProActivated"),n=(localStorage.getItem("kodeProValue")||"").toString().trim().toUpperCase(),o=(t||"").toString().trim().toUpperCase();"true"===a&&n&&o&&n===o&&e&&(localStorage.setItem(`kodeProActivated:${e}`,"true"),localStorage.setItem(`kodeProValue:${e}`,n)),localStorage.removeItem("kodeProActivated"),localStorage.removeItem("kodeProValue")}async function handleLogin(e){e.preventDefault();const t=e.target.querySelector('button[type="submit"]');if(!t)return void console.error("Login button not found");const a=showButtonLoading(t),n=appCodeInput.value.trim(),o=document.querySelector('input[name="kurikulum"]:checked').value;if(!n)return showSmartNotification("Silakan masukkan Kode Aplikasi.","warning","login"),void hideButtonLoading(t,a);try{const e=await fetch(apiUrl("/api/auth/login"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({appCode:n,kurikulum:o})}),i=await e.json();if(!i.success)throw new Error(i.message);localStorage.setItem("jwtToken",i.token),migrateLegacyProFlag(i?.schoolData?.[0],i?.schoolData?.[1]),window.currentUser={isLoggedIn:!0,role:i.role,schoolData:i.schoolData,loginType:i.loginType,kurikulum:i.kurikulum,token:i.token},localStorage.setItem("currentUserSession",JSON.stringify(window.currentUser)),await fetchDataFromServer(),hideButtonLoading(t,a),showDashboard(window.currentUser.role),"sekolah"===window.currentUser.role&&showLoginInfoModal()}catch(e){"Kode Aplikasi tidak ditemukan."!==e.message&&console.error("Login error:",e),showSmartNotification(e,"error","login"),hideButtonLoading(t,a)}finally{t&&t.disabled&&hideButtonLoading(t,a)}}async function fetchDataFromServer(e=!1){try{"function"!=typeof showLoader||e||showLoader("Memuat data dari server...");const t=await fetchWithAuth(apiUrl("/api/data/all"));if(!t?.success)throw new Error(t?.message||"Gagal memuat data dari server.");database=t.data,updateAdminCounters(),updateLogoPreviewUI(),Object.keys(tableDataCache).forEach(e=>{invalidateTableCache(e)});const a=document.querySelector("#adminDashboard .content-section.active");a&&"function"==typeof renderAdminTable&&renderAdminTable(a.id);const n=document.querySelector("#sekolahDashboard .content-section.active");if(n){const e=n.dataset.tableId||n.id;["sekolahSiswa","sekolahNilai","sekolahTranskripNilai","sekolahSKL","sekolahSKKB","sekolahCetak"].includes(e)?"function"==typeof rerenderActiveTable&&rerenderActiveTable(e):"function"==typeof switchSekolahContent&&switchSekolahContent(n.id)}return window.currentUser&&"sekolah"===window.currentUser.role&&n&&"dashboardSection"===n.id&&updateRankingWidget(),!0}catch(t){throw console.error("Fetch error:",t),"function"!=typeof showNotification||e||showNotification(t.message||"Gagal memuat data dari server.","error"),t}finally{"function"!=typeof hideLoader||e||hideLoader()}}function showDashboard(e){const t=document.getElementById("loginPage"),a=document.getElementById("adminDashboard"),n=document.getElementById("sekolahDashboard");if(t&&(t.style.display="none"),a&&(a.style.display="none"),n&&(n.style.display="none"),"admin"===e&&a)a.style.display="flex",a.classList.add("css-loaded"),updateAdminCounters(),"function"==typeof switchContent&&switchContent("dashboardContent");else if("sekolah"===e&&n){n.style.display="flex",n.classList.add("css-loaded"),updateHeaderSchoolName();const e="infoTerbaruSection";document.querySelectorAll("#sekolahDashboard .menu-item").forEach(e=>e.classList.remove("active"));const t=document.querySelector(`.menu-item[data-target="${e}"]`);t&&t.classList.add("active"),"function"==typeof switchSekolahContent&&switchSekolahContent(e),renderVersionBadge();const a=window.currentUser?.schoolData?.[0],o=!!a&&"true"===localStorage.getItem(`kodeProActivated:${a}`);"pro"===window.currentUser?.loginType||o?disableAktivasiMenu():"biasa"!==window.currentUser?.loginType||o||enableAktivasiMenu()}setTimeout(()=>{updateLogoPreviewUI()},500)}function renderVersionBadge(){const e=document.getElementById("version-info-badge");if(!e)return;if("sekolah"!==window.currentUser?.role)return void(e.innerHTML="");const t=window.currentUser.loginType;e.innerHTML="pro"===t?'<span class="version-badge pro">VERSI PRO <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="gold" stroke="gold" stroke-width="1"><path d="m12 2 3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"></path></svg></span>':'<span class="version-badge biasa">VERSI BIASA</span>'}function switchSekolahContent(e){document.querySelectorAll("#sekolahDashboard .content-section").forEach(e=>{e.classList.remove("active")});const t=document.getElementById(e);t&&(t.classList.add("active"),"notificationCenterSection"===e&&(t.style.display="flex",t.style.flexDirection="column",t.style.visibility="visible",t.style.opacity="1",t.style.minHeight="400px")),updateHeaderSchoolName(),document.querySelectorAll("#sekolahDashboard .sidebar-menu a").forEach(e=>e.classList.remove("active"));const a=document.querySelector(`#sekolahDashboard .sidebar-menu a[data-target="${e}"]`);if(a&&!a.classList.contains("has-submenu")&&a.classList.add("active"),"dashboardSection"===e)renderDashboardStats();else if("profilSiswaSection"===e)paginationState.sekolahSiswa={currentPage:1,rowsPerPage:10},renderProfilSiswa();else if("transkripNilaiSection"===e)renderTranskripSiswaTable();else if("settingSection"===e)renderSettingsPage();else if("sklSection"===e)renderSklSiswaTable();else if("skkbSection"===e)renderSkkbSiswaTable();else if("cetakGabunganSection"===e)renderCetakGabunganPage();else if("rekapNilaiSection"===e)renderRekapNilai();else if("infoTerbaruSection"===e)"function"==typeof renderInfoTerbaru&&setTimeout(()=>{renderInfoTerbaru()},100);else if("aktivasiKodeProSection"===e)initAktivasiKodePro();else if("notificationCenterSection"===e){const e=document.getElementById("sekolahNotificationCenterContent");e&&(e.innerHTML='\n                <div style="padding: 0; margin: 0;">\n                    \x3c!-- Header dengan icon dan tombol refresh --\x3e\n                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 20px; border-bottom: 1px solid #e5e7eb;">\n                        <div style="display: flex; align-items: center; gap: 8px;">\n                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="color: #374151;">\n                                <path d="M8 2v4"></path>\n                                <path d="M16 2v4"></path>\n                                <rect width="18" height="18" x="3" y="4" rx="2"></rect>\n                                <path d="M3 10h18"></path>\n                            </svg>\n                            <h2 style="margin: 0; font-size: 18px; font-weight: 600; color: #374151;">Pengumuman</h2>\n                        </div>\n                        <button onclick="fetchNotifications()" style="display: flex; align-items: center; gap: 6px; padding: 8px 12px; background: #0891b2; color: white; border: none; border-radius: 6px; font-size: 14px; cursor: pointer; font-weight: 500;">\n                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">\n                                <path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"></path>\n                                <path d="M21 3v5h-5"></path>\n                                <path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"></path>\n                                <path d="M3 21v-5h5"></path>\n                            </svg>\n                            Refresh\n                        </button>\n                    </div>\n\n                    \x3c!-- Content area untuk pengumuman --\x3e\n                    <div id="pengumumanFeedList" style="padding: 0;">\n                        \x3c!-- Loading state --\x3e\n                        <div style="padding: 40px; text-align: center; color: #6b7280;">\n                            <div style="margin-bottom: 12px;">📄</div>\n                            <p style="margin: 0;">Memuat pengumuman...</p>\n                        </div>\n                    </div>\n                </div>\n            '),fetchNotifications()}}function renderDashboardStats(){if("sekolah"!==window.currentUser.role||!window.currentUser.schoolData)return;const e=String(window.currentUser.schoolData[0]),t=database.siswa.filter(t=>String(t[0])===e),a=t.length,n=document.getElementById("dashboardSchoolName");n&&(n.textContent=window.currentUser.schoolData[4]||"Dasbor Statistik");const o=document.getElementById("statTotalSiswa");o&&(o.textContent=`${a} Siswa`);const i=document.getElementById("statKurikulum");i&&(i.textContent=window.currentUser.kurikulum);const s=t.filter(e=>{const t=e[6]&&""!==String(e[6]).trim(),a=e[12]&&""!==String(e[12]).trim();return t&&a}).length,r=document.getElementById("statDataCompletion");r&&(r.textContent=`${s}/${a}`);const l=t.filter(e=>checkNilaiLengkap(e[6],!1)).length,d=document.getElementById("statNilaiProgress");d&&(d.textContent=`${l}/${a}`);try{charts.completionChart&&(charts.completionChart.destroy(),charts.completionChart=null),charts.averageGradeChart&&(charts.averageGradeChart.destroy(),charts.averageGradeChart=null)}catch(e){}if(a>0){const e=document.getElementById("completionChart");if(e)try{let n=0,o=0;t.forEach(e=>{checkNilaiLengkap(e[6],!1)&&n++,e[12]&&""!==String(e[12]).trim()&&o++}),charts.completionChart=new Chart(e.getContext("2d"),{type:"doughnut",data:{labels:["Nilai Lengkap","Nilai Belum Lengkap","No. Ijazah Terisi","No. Ijazah Kosong"],datasets:[{label:"Kelengkapan Data",data:[n,a-n,o,a-o],backgroundColor:["rgba(75, 192, 192, 0.7)","rgba(75, 192, 192, 0.2)","rgba(54, 162, 235, 0.7)","rgba(54, 162, 235, 0.2)"]}]},options:{responsive:!0,maintainAspectRatio:!1,aspectRatio:1,plugins:{legend:{position:"bottom"}}}})}catch(e){console.error("Error creating completion chart:",e)}}const c=document.getElementById("averageGradeChart");if(c&&a>0)try{const e=window.currentUser.kurikulum,a=String(window.currentUser.schoolData[0]),n=database.settings?.[a]?.subjectVisibility||{},o=database.nilai?._mulokNames?.[a]||{},i=subjects[e].filter(e=>e.startsWith("MULOK")?o[e]&&""!==o[e].trim():!1!==n[e]),s=i.map(e=>e.startsWith("MULOK")&&o[e]||e),r=i.map(e=>{let a=0,n=0;return t.forEach(t=>{const o=calculateAverageForSubject(t[7],e);null===o||Number.isNaN(o)||(a+=o,n++)}),n?+(a/n).toFixed(2):0});charts.averageGradeChart=new Chart(c.getContext("2d"),{type:"bar",data:{labels:s,datasets:[{label:"Rata-rata",data:r,backgroundColor:"rgba(78, 115, 223, 0.75)",borderColor:"rgba(78, 115, 223, 1)",borderWidth:1,borderRadius:6}]},options:{responsive:!0,maintainAspectRatio:!1,plugins:{legend:{display:!1},tooltip:{callbacks:{label:e=>`${e.parsed.y}`}}},scales:{y:{beginAtZero:!0,suggestedMax:100,ticks:{stepSize:10}}}}}),setTimeout(()=>{charts.averageGradeChart&&charts.averageGradeChart.resize()},100)}catch(e){console.error("Error creating average grade chart:",e)}renderQuickProgress(t),renderActionItems(t),updateRankingWidget()}function renderQuickProgress(e){const t=document.getElementById("quickProgressContainer");t.innerHTML="";const a=e.length;0!==a?semesterIds.forEach(n=>{const o=semesterMap[n];let i=0;e.forEach(e=>{checkNilaiLengkapForSemester(e[6],n)&&i++});const s=a>0?i/a*100:0,r=document.createElement("div");r.className="progress-item",r.innerHTML=`\n                    <div class="progress-label">\n                        <span>${o}</span>\n                        <strong>${Math.round(s)}%</strong>\n                    </div>\n                    <div class="progress-bar-container">\n                        <div class="progress-bar" style="width: ${s}%;"></div>\n                    </div>\n                    ${s<100?`<button class="btn btn-action btn-login" onclick="navigateToIsiNilai('${n}', '${o}')">Lanjutkan</button>`:""}\n                `,t.appendChild(r)}):t.innerHTML='<p style="text-align: center; color: #777;">Tidak ada siswa untuk ditampilkan.</p>'}function navigateToIsiNilai(e,t){const a=document.getElementById("isiNilaiMenu"),n=a.previousElementSibling;a.classList.contains("open")||(a.classList.add("open"),n.classList.add("open")),renderIsiNilaiPage(e,t)}function renderActionItems(e){const t=document.getElementById("actionItemsContainer");t.innerHTML="";let a=!1;const n=e.filter(e=>!e[7]||""===String(e[7]).trim());if(n.length>0){a=!0;const e=document.createElement("li");e.className="action-item",e.innerHTML=`\n                    <span class="icon">⚠️</span>\n                    <span class="text">${n.length} siswa belum memiliki NISN.</span>\n                    <button class="btn btn-action btn-view" onclick="switchSekolahContent('profilSiswaSection')">Lihat Daftar</button>\n                `,t.appendChild(e)}const o=e.filter(e=>!checkNilaiLengkap(e[7],!1));if(o.length>0){a=!0;const e=document.createElement("li");e.className="action-item",e.innerHTML=`\n                    <span class="icon">📝</span>\n                    <span class="text">${o.length} siswa nilainya belum lengkap untuk semua semester.</span>\n                     <button class="btn btn-action btn-view" onclick="switchSekolahContent('profilSiswaSection')">Lihat Daftar</button>\n                `,t.appendChild(e)}a||(t.innerHTML='<p style="text-align: center; color: #777;">👍 Semua data penting sudah lengkap. Kerja bagus!</p>')}function filterSiswaData(e,t){if(!t)return e;const a=t.toLowerCase();return e.filter(e=>{const t=String(e[7]||"").toLowerCase(),n=String(e[5]||"").toLowerCase(),o=String(e[6]||"").toLowerCase();return t.includes(a)||n.includes(a)||o.includes(a)})}function updateDashboardComplete(){updateRankingWidget()}function handleSort(e,t,a){const n=sortState[e];n.keyIndex===t?n.direction="asc"===n.direction?"desc":"asc":(n.keyIndex=t,n.direction="asc",n.type=a),paginationState[e].currentPage=1,rerenderActiveTable(e)}function applySort(e,t){sortState[t]||(sortState[t]={keyIndex:0,direction:"asc",type:"string"});const{keyIndex:a,direction:n,type:o}=sortState[t],i=Array.isArray(e)?[...e]:[],s="desc"===n?-1:1;return i.sort((e,n)=>{if("sekolahSiswa"===t&&4===a){if(void 0!==e.originalOrder&&void 0!==n.originalOrder){return(e.originalOrder-n.originalOrder)*s}{const t=database?.siswa||[],a=t.findIndex(t=>t[6]===e[6]),o=t.findIndex(e=>e[6]===n[6]);return((-1!==a?a:e[4]||0)-(-1!==o?o:n[4]||0))*s}}let i=e?.[a],r=n?.[a];return"number"===o?(i=Number.parseFloat(i),r=Number.parseFloat(r),i=Number.isFinite(i)?i:-1/0,r=Number.isFinite(r)?r:-1/0,(i-r)*s):(i=String(i??"").toLowerCase(),r=String(r??"").toLowerCase(),i.localeCompare(r,"id")*s)})}function updateSortHeaders(e){const{keyIndex:t,direction:a}=sortState[e];document.querySelectorAll(`th.sortable[data-table-id="${e}"]`).forEach(e=>{e.classList.remove("sort-asc","sort-desc"),parseInt(e.dataset.keyIndex)===t&&e.classList.add("asc"===a?"sort-asc":"sort-desc")})}function renderProfilSiswa(){if("sekolah"!==window.currentUser.role||!window.currentUser.schoolData)return;paginationState.sekolahSiswa||(paginationState.sekolahSiswa={currentPage:1,rowsPerPage:10});const e=window.currentUser.schoolData,t=String(e[0]),a=database.siswa.filter(e=>String(e[0])===t),n=searchState.sekolahSiswa;let o=filterSiswaData(a,n),i=new Map;a.forEach((e,t)=>{i.set(e[6],t)}),o=applySort(o,"sekolahSiswa"),o=o.map((e,t)=>{const a=[...e];return a[4]=t+1,a.originalOrder=void 0!==i.get(e[6])?i.get(e[6]):t,a});const s=document.getElementById("sekolahInfoKecamatan");s&&(s.textContent=e[2]||"NANGA PINOH");const r=document.getElementById("sekolahInfoKodeBiasa");r&&(r.textContent=e[0]||"-");const l=document.getElementById("namaSekolahHeader");l&&(l.textContent=e[4]||e[5]||"SEKOLAH DASAR");const d=document.getElementById("sekolahInfoNpsn");if(d){const a=(e[3]??"").toString().trim();if(d.textContent=""!==a?a:"Belum diisi",d.classList&&d.classList.toggle("is-missing",""===a),!a&&Array.isArray(database.sekolah)){const e=database.sekolah.find(e=>String(e[0])===t),a=(e?.[3]??"").toString().trim();a&&(d.textContent=a,d.classList&&d.classList.toggle("is-missing",!1))}}const c=document.getElementById("sekolahInfoNama");c&&(c.textContent=e[4]||e[5]||"-");const u=document.getElementById("sekolahInfoTotalSiswa");u&&(u.textContent=a.length);const g=document.getElementById("sekolahSiswaTableBody");if(!g)return;g.innerHTML="";const m=document.querySelector("#profilSiswaSection thead tr"),p=document.querySelector("#profilSiswaSection table"),h=!!t&&"true"===localStorage.getItem(`kodeProActivated:${t}`),k="pro"===window.currentUser.loginType||h;p&&(p.classList.add("has-photo-col"),p.classList.add("has-action-col")),n!==searchState.sekolahSiswa&&(paginationState.sekolahSiswa.currentPage=1),m.innerHTML='\n            <th class="sortable" data-table-id="sekolahSiswa" data-key-index="4" data-key-type="number">NO</th>\n            <th class="sortable" data-table-id="sekolahSiswa" data-key-index="5" data-key-type="string">NO INDUK</th>\n            <th class="sortable" data-table-id="sekolahSiswa" data-key-index="6" data-key-type="string">NISN</th>\n            <th class="sortable" data-table-id="sekolahSiswa" data-key-index="7" data-key-type="string">NAMA PESERTA</th>\n            <th class="sortable" data-table-id="sekolahSiswa" data-key-index="8" data-key-type="string">TEMPAT DAN TANGGAL LAHIR</th>\n            <th class="sortable" data-table-id="sekolahSiswa" data-key-index="9" data-key-type="string">NAMA ORANG TUA</th>\n            <th class="photo-column">FOTO</th>\n            <th class="col-ijazah">NO IJAZAH</th>\n            <th class="action-column col-aksi">AKSI</th>\n        ';const f=paginationState.sekolahSiswa,b="all"===f.rowsPerPage?o.length:parseInt(f.rowsPerPage),w=b>0?Math.ceil(o.length/b):1;f.currentPage=Math.max(1,Math.min(f.currentPage,w));const y=(f.currentPage-1)*b,S="all"===f.rowsPerPage?o.length:y+b;o.slice(y,S).forEach((e,t)=>{const a=e[6],n=database.siswa.findIndex(e=>e[6]===a),o=g.insertRow();let i="";if(k){i=database.sklPhotos&&database.sklPhotos[a]?`<div class="photo-thumbnail-container" onclick="openPhotoModal('${a}', '${e[7]||"Tidak diketahui"}')">\n                     <img src="${database.sklPhotos[a]}" class="photo-thumbnail" title="Klik untuk memperbesar foto">\n                   </div>`:'<span class="no-photo-placeholder">❌</span>'}let s="";if(k){const e=database.sklPhotos&&database.sklPhotos[a];s=`\n                <div class="action-dropdown">\n                    <button class="btn btn-small action-dropdown-btn" onclick="toggleActionDropdown(event, '${a}')">\n                        Aksi\n                    </button>\n                    <div class="action-dropdown-content" id="dropdown-${a}">\n                        <a href="#" onclick="openEditModalByNisn('${a}'); closeAllDropdowns();">\n                            <span class="dropdown-icon">✏️</span> Edit Data\n                        </a>\n                        <a href="#" onclick="document.getElementById('profil-photo-input-${a}').click(); closeAllDropdowns();">\n                            <span class="dropdown-icon">${e?"🔄":"📷"}</span> ${e?"Ubah Foto":"Unggah Foto"}\n                        </a>\n                        ${e?`<a href="#" onclick="deleteSklPhoto('${a}'); closeAllDropdowns();"><span class="dropdown-icon">🗑️</span> Hapus Foto</a>`:""}\n                    </div>\n                    <input type="file" id="profil-photo-input-${a}" class="file-input" accept="image/*" onchange="handleSklPhotoUpload(event, '${a}')">\n                </div>\n            `}else s=`\n                <div class="action-dropdown">\n                    <button class="btn btn-small action-dropdown-btn" onclick="toggleActionDropdown(event, '${a}')">\n                        Aksi\n                    </button>\n                    <div class="action-dropdown-content" id="dropdown-${a}">\n                        <a href="#" onclick="showUpgradePrompt('Edit Data'); closeAllDropdowns(); return false;">\n                            <span class="dropdown-icon">✏️</span> Edit Data <span style="color: #ff9800; font-size: 10px;">🔒 PRO</span>\n                        </a>\n                        <a href="#" onclick="showUpgradePrompt('Upload Foto'); closeAllDropdowns(); return false;">\n                            <span class="dropdown-icon">📷</span> Upload Foto <span style="color: #ff9800; font-size: 10px;">🔒 PRO</span>\n                        </a>\n                    </div>\n                </div>\n            `;const r=`<input type="text" class="editable-ijazah" value="${e[10]||""}" data-index="${n}" onchange="saveIjazahNumber(this)" oninput="validateIjazahInput(this)" onblur="validateIjazahOnBlur(this)" maxlength="15">`,l=sortState.sekolahSiswa&&4===sortState.sekolahSiswa.keyIndex&&void 0!==e.originalOrder?e.originalOrder+1:e[4]||y+t+1,d=(e[7]||"[Nama Tidak Tersedia]").toUpperCase(),c=formatToProperCase(e[8]||""),u=formatToProperCase(e[9]||"[Nama Orang Tua Tidak Tersedia]");o.innerHTML=k?`\n                <td>${l}</td>\n                <td>${e[5]||""}</td>\n                <td>${e[6]||""}</td>\n                <td>${d}</td>\n                <td>${c}</td>\n                <td>${u}</td>\n                <td class="photo-cell">${i}</td>\n                <td class="col-ijazah">${r}</td>\n                <td class="action-cell col-aksi">${s}</td>\n            `:`\n                <td>${l}</td>\n                <td>${e[5]||""}</td>\n                <td>${e[6]||""}</td>\n                <td>${d}</td>\n                <td>${c}</td>\n                <td>${u}</td>\n                <td class="photo-cell">❌</td>\n                <td class="col-ijazah">${r}</td>\n                <td class="action-cell col-aksi">${s}</td>\n            `}),optimizedUpdatePaginationControls("sekolahSiswa",o.length),updateSortHeaders("sekolahSiswa")}function renderIsiNilaiPage(e,t){switchSekolahContent("isiNilaiSection"),document.getElementById("isiNilaiTitle").textContent=`Nilai - ${t}`,paginationState.isiNilai.currentSemester=e,paginationState.isiNilai.currentSemesterName=t,document.getElementById("deleteAllGradesBtn").style.display="inline-flex",showAutosaveStatus("idle");const a=document.getElementById("isiNilaiTableContainer");a.innerHTML="";const n=document.createElement("table");n.id="isiNilaiTable";const o=document.createElement("thead"),i=document.createElement("tbody"),s=String(window.currentUser.schoolData[0]),r=database.nilai._mulokNames?.[s]||{};if("K13"===window.currentUser.kurikulum){const e=subjects.K13.filter(e=>!e.startsWith("MULOK")),t=document.createElement("tr");t.innerHTML='<th rowspan="2">NO</th><th rowspan="2" class="sortable" data-table-id="isiNilai" data-key-index="7" data-key-type="string">NAMA</th>',e.forEach(e=>{t.innerHTML+=`<th colspan="3">${e}</th>`}),t.innerHTML+=`<th colspan="3">${r.MULOK1||"MULOK 1"}</th>`,t.innerHTML+=`<th colspan="3">${r.MULOK2||"MULOK 2"}</th>`,t.innerHTML+=`<th colspan="3">${r.MULOK3||"MULOK 3"}</th>`;const a=document.createElement("tr");[...e,"MULOK1","MULOK2","MULOK3"].forEach(()=>{a.innerHTML+="<th>KI.3</th><th>KI.4</th><th>RT</th>"}),o.appendChild(t),o.appendChild(a)}else{const e=subjects.Merdeka.filter(e=>!e.startsWith("MULOK")),t=document.createElement("tr");t.innerHTML='<th>NO</th><th class="sortable" data-table-id="isiNilai" data-key-index="7" data-key-type="string">NAMA</th>',e.forEach(e=>{t.innerHTML+=`<th>${e}</th>`}),t.innerHTML+=`<th>${r.MULOK1||"MULOK 1"}</th>`,t.innerHTML+=`<th>${r.MULOK2||"MULOK 2"}</th>`,t.innerHTML+=`<th>${r.MULOK3||"MULOK 3"}</th>`,o.appendChild(t)}n.appendChild(o);let l=filterSiswaData(database.siswa.filter(e=>String(e[0])===s),searchState.isiNilai);l=applySort(l,"isiNilai");const d=paginationState.isiNilai;optimizedUpdatePaginationControls("isiNilai",l.length);const c="all"===d.rowsPerPage?l.length:parseInt(d.rowsPerPage),u=c>0?Math.ceil(l.length/c):1;d.currentPage=Math.max(1,Math.min(d.currentPage,u));const g=(d.currentPage-1)*c,m="all"===d.rowsPerPage?l.length:g+c,p=l.slice(g,m);optimizedUpdatePaginationControls("isiNilai",p.length);const h=(database.settings[s]||{}).subjectVisibility||{};p.forEach((t,a)=>{const n=t[6],o=n&&""!==String(n).trim(),s=document.createElement("tr");o||(s.classList.add("row-disabled"),s.title="Input dinonaktifkan karena NISN siswa kosong. Harap lengkapi di menu Profil Siswa."),s.innerHTML=`<td>${g+a+1}</td><td>${t[7]||""}</td>`;let r="";subjects[window.currentUser.kurikulum].forEach(t=>{const a=!1!==h[t]&&o?"":"disabled";if("K13"===window.currentUser.kurikulum){const i=o&&database.nilai[n]?.[e]?.[t]?.KI3||"",s=o&&database.nilai[n]?.[e]?.[t]?.KI4||"";let l=""!==i&&""!==s?Math.round((parseFloat(i)+parseFloat(s))/2):"";r+=`\n                    <td><input type="number" min="0" max="100" value="${i}" data-nisn="${n}" data-semester="${e}" data-subject="${t}" data-type="KI3" oninput="handleGradeInput(this); calculateRataRata(this);" ${a}></td>\n                    <td><input type="number" min="0" max="100" value="${s}" data-nisn="${n}" data-semester="${e}" data-subject="${t}" data-type="KI4" oninput="handleGradeInput(this); calculateRataRata(this);" ${a}></td>\n                    <td><input type="number" value="${l}" data-nisn="${n}" data-semester="${e}" data-subject="${t}" data-type="RT" readonly ${a}></td>`}else{const i=o&&database.nilai[n]?.[e]?.[t]?.NILAI||"";r+=`<td><input type="number" min="0" max="100" value="${i}" data-nisn="${n}" data-semester="${e}" data-subject="${t}" data-type="NILAI" oninput="handleGradeInput(this)" ${a}></td>`}}),s.innerHTML+=r,i.appendChild(s)}),n.appendChild(i),a.appendChild(n),optimizedUpdatePaginationControls("isiNilai",l.length),updateSortHeaders("isiNilai")}function handleGradeInput(e){validateGrade(e),saveGrade(e)}function calculateRataRata(e){const{nisn:t,semester:a,subject:n,type:o}=e.dataset;if("K13"!==window.currentUser.kurikulum||"KI3"!==o&&"KI4"!==o)return;const i=e.closest("tr");if(!i)return;const s=i.querySelector(`input[data-nisn="${t}"][data-semester="${a}"][data-subject="${n}"][data-type="KI3"]`),r=i.querySelector(`input[data-nisn="${t}"][data-semester="${a}"][data-subject="${n}"][data-type="KI4"]`),l=i.querySelector(`input[data-nisn="${t}"][data-semester="${a}"][data-subject="${n}"][data-type="RT"]`);if(!s||!r||!l)return;const d=parseFloat(s.value),c=parseFloat(r.value);if(isNaN(d)||isNaN(c))l.value="",database.nilai[t]?.[a]?.[n]&&(database.nilai[t][a][n].RT="");else{const e=Math.round((d+c)/2);l.value=e,database.nilai[t]||(database.nilai[t]={}),database.nilai[t][a]||(database.nilai[t][a]={}),database.nilai[t][a][n]||(database.nilai[t][a][n]={}),database.nilai[t][a][n].RT=e,saveGrade(l)}}function validateGrade(e){let t=parseInt(e.value,10);isNaN(t)?e.classList.remove("invalid-input"):(t>100?(e.value=100,e.classList.add("invalid-input")):t<0?(e.value=0,e.classList.add("invalid-input")):e.classList.remove("invalid-input"),setTimeout(()=>{e.classList.remove("invalid-input")},1500))}function saveGrade(e){const{nisn:t,semester:a,subject:n,type:o}=e.dataset,i=e.value;database.nilai[t]||(database.nilai[t]={}),database.nilai[t][a]||(database.nilai[t][a]={}),database.nilai[t][a][n]||(database.nilai[t][a][n]={}),database.nilai[t][a][n][o]=i,clearTimeout(autosaveTimer),showAutosaveStatus("saving"),autosaveTimer=setTimeout(()=>{fetchWithAuth(apiUrl("/api/data/grade/save"),{method:"POST",body:JSON.stringify({nisn:t,semester:a,subject:n,type:o,value:i})}).then(e=>{e.success?(showAutosaveStatus("saved"),document.getElementById("rankingContainer")&&updateRankingWidget()):(showNotification("Gagal menyimpan nilai ke server.","error"),showAutosaveStatus("idle"))}).catch(e=>{console.error("Error saving grade:",e),showNotification(e.message||"Koneksi ke server gagal saat menyimpan nilai.","error"),showAutosaveStatus("idle")})},1500)}function parseDateToYMD(e){if(!e||""===e.trim())return"";const t=e.trim();if(/^\d{4}-\d{2}-\d{2}$/.test(t))return t;const a=t.split(" ");if(3!==a.length)return"";const n=parseInt(a[0],10),o=parseInt(a[2],10),i=["januari","februari","maret","april","mei","juni","juli","agustus","september","oktober","november","desember"].indexOf(a[1].toLowerCase());if(isNaN(n)||isNaN(o)||-1===i)return"";return`${o}-${String(i+1).padStart(2,"0")}-${String(n).padStart(2,"0")}`}function openEditModal(e){if(!e||!Array.isArray(e)||e.length<=6)return console.error("Invalid student data provided to openEditModal",e),void showSmartNotification("Data siswa tidak valid.","error","edit siswa");const t=e[6];if(!t)return console.error("NISN tidak ditemukan di data siswa",e),void showSmartNotification("NISN siswa tidak valid.","error","edit siswa");if(!database||!database.siswa||!Array.isArray(database.siswa))return console.error("Database siswa tidak tersedia"),void showSmartNotification("Database siswa tidak tersedia.","error","edit siswa");const a=database.siswa.findIndex(e=>e[6]===t);if(-1===a)return console.error("Student not found in database.siswa",t),void showSmartNotification("Data siswa tidak ditemukan di database.","error","edit siswa");document.getElementById("editSiswaIndex").value=a;[{id:"editNis",value:e[5]},{id:"editNisn",value:e[6]},{id:"editNamaPeserta",value:e[7]},{id:"editNamaOrtu",value:e[9]}].forEach(e=>{const t=document.getElementById(e.id);t?(t.value=e.value||"",t.style.display="block",t.style.visibility="visible",t.style.opacity="1",t.style.height="auto",t.style.minHeight="40px",t.style.width="100%",t.style.position="static",t.style.overflow="visible",t.style.clip="auto",t.style.transform="none",t.style.zIndex="999"):console.error(`Element ${e.id} not found`)});const n=(e[8]||",").split(","),o=n[0]?n[0].trim():"",i=n[1]?n[1].trim():"",s=document.getElementById("editTempatLahir"),r=document.getElementById("editTanggalLahir");s&&(s.value=o),r&&(r.value=parseDateToYMD(i)),loadFotoSiswa(e[6]),editModal.style.display="flex"}function closeEditModal(){editModal.style.display="none",resetFotoPreview()}function openEditModalByNisn(e){if(!database||!database.siswa||!Array.isArray(database.siswa))return console.error("Database siswa tidak tersedia"),void showSmartNotification("Database siswa tidak tersedia.","error","edit siswa");const t=database.siswa.findIndex(t=>t[6]===e);if(-1===t)return console.error("Student not found in database.siswa with NISN:",e),void showSmartNotification("Data siswa tidak ditemukan di database.","error","edit siswa");openEditModal(database.siswa[t])}async function downloadIsiNilaiTemplate(){if("sekolah"!==window.currentUser.role||!window.currentUser.schoolData)return void showNotification("Hanya sekolah yang dapat mengunduh template.","warning");const{currentSemester:e,currentSemesterName:t}=paginationState.isiNilai||{};if(e)try{showNotification("Mengunduh template Excel...","info");const t=localStorage.getItem("jwtToken");if(!t)return showNotification("Token tidak ditemukan. Silakan login ulang.","error"),void handleLogout?.();const a=apiUrl(`/api/data/template/download?semester=${e}&kurikulum=${window.currentUser.kurikulum}&kodeSekolah=${window.currentUser.schoolData[0]}`),n=await fetch(a,{method:"GET",headers:{Authorization:`Bearer ${t}`}});if(!n.ok){if(401===n.status||403===n.status)return showNotification("Sesi telah berakhir. Silakan login ulang.","error"),void handleLogout?.();throw new Error(`HTTP error! status: ${n.status}`)}const o=await n.blob(),i=window.URL.createObjectURL(o),s=document.createElement("a");s.href=i,s.download=`Template-Nilai-Sem${e}-${window.currentUser.kurikulum}.xlsx`,document.body.appendChild(s),s.click(),document.body.removeChild(s),window.URL.revokeObjectURL(i),showNotification("Template Excel berhasil diunduh!","success")}catch(e){console.error("Download template error:",e),showNotification("Gagal mengunduh template Excel. Silakan coba lagi.","error")}else showNotification("Pilih semester terlebih dahulu untuk mengunduh template.","warning")}function previewFotoSiswa(e){if(e.files&&e.files[0]){const t=e.files[0];if(!t.type.match("image.*"))return showNotification("Hanya file gambar yang diizinkan!","error"),void(e.value="");if(t.size>2097152)return showNotification("Ukuran file terlalu besar! Maksimal 2MB.","error"),void(e.value="");const a=new FileReader;a.onload=function(e){const t=document.getElementById("editFotoPreview");t.src=e.target.result,t.classList.add("uploaded")},a.readAsDataURL(t)}}async function hapusFotoSiswa(){const e=document.getElementById("editFotoPreview"),t=document.getElementById("editSiswaIndex").value;if(""!==t&&database.siswa[t])try{const e=database.siswa[t][7];(await fetchWithAuth(apiUrl("/api/data/siswa/update"),{method:"POST",body:JSON.stringify({nisn:e,updatedData:{foto:null}})})).success&&await fetchDataFromServer()}catch(e){console.error("Error hapus foto:",e)}e.src="https://placehold.co/120x150/f0f0f0/999?text=Foto",e.classList.remove("uploaded"),showNotification("Foto berhasil dihapus","info")}function resetFotoPreview(){const e=document.getElementById("editFotoPreview");e&&(e.src="https://placehold.co/120x150/f0f0f0/999?text=Foto",e.classList.remove("uploaded"))}function getFotoBase64(){return Promise.resolve(null)}function loadFotoSiswa(e){const t=document.getElementById("editFotoPreview");e&&t&&(database.sklPhotos&&database.sklPhotos[e]?(t.src=database.sklPhotos[e],t.classList.add("uploaded")):(t.src="https://placehold.co/120x150/f0f0f0/999?text=Foto",t.classList.remove("uploaded")))}function closeTranskripModal(){transkripModal.style.display="none"}function closeSklModal(){sklModal.style.display="none"}function closeSkkbModal(){skkbModal.style.display="none"}function showLoginInfoModal(){if(!window.currentUser.schoolData)return;if(window.loginInfoModalShown)return;window.loginInfoModalShown=!0;const e=window.currentUser.schoolData,t=String(e[0]),a=database.siswa.filter(e=>String(e[0])===t).length;document.getElementById("infoNamaSekolah").textContent=e[4]||"Nama Sekolah Tidak Ditemukan",document.getElementById("infoJumlahSiswa").textContent=`${a} siswa`,document.getElementById("infoKurikulum").textContent=window.currentUser.kurikulum;const n=document.getElementById("loginTypeBadge"),o=document.getElementById("loginTypeText"),i=document.getElementById("loginTypeDescription"),s=document.getElementById("loginTypeCard");if(n&&o&&i){const e=window.currentUser.loginType;n.className="login-type-badge","pro"===e?(n.classList.add("pro"),o.textContent="KODE PRO",i.textContent="Akses premium dengan fitur lengkap, logo kustom, dan kontrol penuh",s&&(s.style.borderLeftColor="#f57f17",s.style.borderColor="#ffe0b2")):(n.classList.add("biasa"),o.textContent="KODE BIASA",i.textContent="Akses standar dengan fitur dasar untuk pengelolaan nilai siswa",s&&(s.style.borderLeftColor="#2196f3",s.style.borderColor="#e3f2fd"))}document.querySelectorAll(".modal-overlay").forEach(e=>{"loginInfoModal"!==e.id&&(e.style.display="none")}),"flex"!==loginInfoModal.style.display&&(loginInfoModal.style.display="flex",setTimeout(()=>{"flex"===loginInfoModal.style.display&&closeLoginInfoModal()},1e4))}function closeLoginInfoModal(){loginInfoModal.style.display="none",window.loginInfoModalShown=!1}async function saveSiswaChanges(e){e.preventDefault();const t=document.getElementById("editNamaPeserta").value.trim(),a=document.getElementById("editNisn").value.trim();if(!t||!a)return void showNotification("Nama Peserta dan NISN wajib diisi.","warning");const n=document.getElementById("editSiswaIndex").value;if(""!==n&&database.siswa[n])try{showLoader();const e=document.getElementById("editTempatLahir").value.trim(),n=document.getElementById("editTanggalLahir").value,o=formatDateToIndonesian(n),i={nis:document.getElementById("editNis").value||"",nisn:a,noPeserta:"",namaPeserta:t,ttl:`${e}, ${o}`,namaOrtu:document.getElementById("editNamaOrtu").value||""};Object.keys(i).forEach(e=>{null!==i[e]&&void 0!==i[e]||delete i[e]});try{await fetch(apiUrl("/api/data/siswa"),{method:"GET",headers:{Authorization:`Bearer ${localStorage.getItem("jwtToken")}`,"Content-Type":"application/json"}})}catch(e){throw console.error("Server connection test failed:",e),new Error("Tidak dapat terhubung ke server. Pastikan server sedang berjalan.")}const s=await fetchWithAuth(apiUrl("/api/data/siswa/update"),{method:"POST",body:JSON.stringify({nisn:a,updatedData:i})});if(!s.success)throw console.error("Server returned error:",s),new Error(s.message||"Server mengembalikan error tanpa pesan");await fetchDataFromServer(),closeEditModal(),renderProfilSiswa(),showNotification("Data siswa berhasil diperbarui!","success")}catch(e){console.error("Save siswa changes error:",e),console.error("Error stack:",e.stack),showNotification(`Error: ${e.message||"Gagal memperbarui data siswa."}`,"error")}finally{hideLoader()}}function handleLogout(){localStorage.removeItem("currentUserSession"),adminDashboard.style.display="none",sekolahDashboard.style.display="none",loginPage.style.display="flex",appCodeInput.value="";const e=document.querySelector('#loginForm button[type="submit"]');e&&(e.disabled=!1,e.style.opacity="1",e.textContent="Masuk"),window.currentUser={isLoggedIn:!1,role:null,schoolData:null,loginType:null,kurikulum:null}}function switchContent(e){document.querySelectorAll(".content-section").forEach(e=>e.classList.remove("active")),document.querySelectorAll("#adminDashboard .sidebar-menu .menu-item").forEach(e=>e.classList.remove("active")),document.getElementById(e).classList.add("active"),document.querySelector(`#adminDashboard .menu-item[data-target="${e}"]`).classList.add("active"),"dashboardContent"===e?populateDashboardStatistics():"sekolah"===e?renderAdminTable("sekolah"):"siswa"===e?renderAdminTable("siswa"):"rekapNilaiAdmin"===e?renderRekapNilaiAdminPage():"notificationCenterSection"===e&&fetchNotifications()}function updateAdminCounters(){const e=document.getElementById("sekolahCount"),t=document.getElementById("siswaCount");if(e){const t=database.sekolah?database.sekolah.length:0;e.textContent=t}if(t){const e=database.siswa?database.siswa.length:0;t.textContent=e}}const kecamatanMelawi=["BELIMBING","BELIMBING HULU","ELLA HILIR","MENUKUNG","NANGA PINOH","PINOH SELATAN","PINOH UTARA","SAYAN","SOKAN","TANAH PINOH","TANAH PINOH BARAT"];function normalizeKecamatan(e){if(!e)return"LAINNYA";const t=e.toUpperCase().trim(),a=kecamatanMelawi.find(e=>e===t);if(a)return a;const n=kecamatanMelawi.find(e=>t.includes(e)||e.includes(t));return n||"LAINNYA"}async function openSekolahKecamatanModal(e){const t=document.createElement("div");t.className="modal-overlay",t.style.cssText="\n        position: fixed; top: 0; left: 0; right: 0; bottom: 0;\n        background: rgba(0,0,0,0.7); z-index: 10000;\n        display: flex; align-items: center; justify-content: center;\n    ";const a=document.createElement("div");if(a.style.cssText="\n        background: white; border-radius: 12px; padding: 24px;\n        max-width: 800px; width: 90%; max-height: 80vh; overflow-y: auto;\n        box-shadow: 0 20px 60px rgba(0,0,0,0.3);\n        position: relative;\n    ",a.innerHTML=`\n        <div style="text-align: center; margin-bottom: 20px;">\n            <h2 style="color: #2563eb; margin-bottom: 8px; font-size: 24px;">🏫 Sekolah di Kecamatan ${e}</h2>\n            <p style="color: #666; font-size: 14px;">Mencari data sekolah...</p>\n        </div>\n        <div style="display: flex; justify-content: center; align-items: center; padding: 40px;">\n            <div style="border: 4px solid #f3f3f3; border-top: 4px solid #2563eb; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite;"></div>\n        </div>\n    `,t.appendChild(a),document.body.appendChild(t),!document.getElementById("spinner-styles")){const e=document.createElement("style");e.id="spinner-styles",e.textContent="\n            @keyframes spin {\n                0% { transform: rotate(0deg); }\n                100% { transform: rotate(360deg); }\n            }\n        ",document.head.appendChild(e)}try{const t=await fetch(`/api/data/sekolah-by-kecamatan/${e}`),n=await t.json();if(n.success&&n.data.length>0){const t=n.data.map((e,t)=>`<tr style="border-bottom: 1px solid #eee; ${t%2==0?"background: #f8f9fa;":""}">\n                    <td style="padding: 12px 8px; text-align: center; font-weight: 600;">${t+1}</td>\n                    <td style="padding: 12px 8px;">\n                        <div style="font-weight: 600; color: #1f2937;">${e.namaSekolahLengkap}</div>\n                    </td>\n                    <td style="padding: 12px 8px; text-align: center;">\n                        <span style="background: #dbeafe; color: #1e40af; padding: 4px 8px; border-radius: 6px; font-size: 12px; font-weight: 600;">${e.npsn||"N/A"}</span>\n                    </td>\n                    <td style="padding: 12px 8px; text-align: center;">\n                        <span style="background: #dcfce7; color: #166534; padding: 4px 8px; border-radius: 6px; font-size: 12px; font-weight: 600;">${e.kodeBiasa}</span>\n                    </td>\n                </tr>`).join("");a.innerHTML=`\n                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">\n                    <div>\n                        <h2 style="color: #2563eb; margin: 0; font-size: 24px;">🏫 Sekolah di Kecamatan ${e}</h2>\n                        <p style="color: #666; margin: 4px 0 0 0; font-size: 14px;">Ditemukan ${n.data.length} sekolah</p>\n                    </div>\n                    <button onclick="this.closest('.modal-overlay').remove()" style="\n                        background: #ef4444; color: white; border: none;\n                        border-radius: 50%; width: 32px; height: 32px;\n                        cursor: pointer; font-size: 18px; font-weight: bold;\n                        display: flex; align-items: center; justify-content: center;\n                        box-shadow: 0 2px 4px rgba(0,0,0,0.1);\n                    ">&times;</button>\n                </div>\n                <div style="background: #f8f9fa; border-radius: 8px; padding: 16px; overflow-x: auto;">\n                    <table style="width: 100%; border-collapse: collapse; background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">\n                        <thead>\n                            <tr style="background: linear-gradient(135deg, #2563eb, #3b82f6); color: white;">\n                                <th style="padding: 16px 8px; text-align: center; font-weight: 600;">NO</th>\n                                <th style="padding: 16px 8px; text-align: left; font-weight: 600;">NAMA SEKOLAH</th>\n                                <th style="padding: 16px 8px; text-align: center; font-weight: 600;">NPSN</th>\n                                <th style="padding: 16px 8px; text-align: center; font-weight: 600;">KODE</th>\n                            </tr>\n                        </thead>\n                        <tbody>\n                            ${t}\n                        </tbody>\n                    </table>\n                </div>\n                <div style="margin-top: 16px; padding: 12px; background: #eff6ff; border-radius: 8px; border-left: 4px solid #2563eb;">\n                    <p style="margin: 0; font-size: 14px; color: #1e40af;">\n                        💡 <strong>Tips:</strong> Klik kolom untuk melihat detail lebih lanjut atau gunakan fitur pencarian untuk menemukan sekolah tertentu.\n                    </p>\n                </div>\n            `}else a.innerHTML=`\n                <div style="text-align: center; padding: 40px;">\n                    <div style="color: #f59e0b; font-size: 64px; margin-bottom: 16px;">🏫</div>\n                    <h2 style="color: #1f2937; margin-bottom: 8px;">Tidak Ada Sekolah</h2>\n                    <p style="color: #6b7280; margin-bottom: 20px;">Tidak ada sekolah ditemukan di kecamatan ${e}.</p>\n                    <button onclick="this.closest('.modal-overlay').remove()" style="\n                        background: #2563eb; color: white; border: none;\n                        padding: 12px 24px; border-radius: 8px; cursor: pointer;\n                        font-weight: 600; box-shadow: 0 2px 4px rgba(0,0,0,0.1);\n                    ">Tutup</button>\n                </div>\n            `}catch(e){console.error("Error fetching sekolah by kecamatan:",e),a.innerHTML='\n            <div style="text-align: center; padding: 40px;">\n                <div style="color: #ef4444; font-size: 64px; margin-bottom: 16px;">❌</div>\n                <h2 style="color: #ef4444; margin-bottom: 8px;">Gagal Memuat Data</h2>\n                <p style="color: #6b7280; margin-bottom: 20px;">Terjadi kesalahan saat memuat data sekolah. Silakan coba lagi.</p>\n                <button onclick="this.closest(\'.modal-overlay\').remove()" style="\n                    background: #ef4444; color: white; border: none;\n                    padding: 12px 24px; border-radius: 8px; cursor: pointer;\n                    font-weight: 600; box-shadow: 0 2px 4px rgba(0,0,0,0.1);\n                ">Tutup</button>\n            </div>\n        '}t.addEventListener("click",e=>{e.target===t&&t.remove()}),document.addEventListener("keydown",function e(a){"Escape"===a.key&&(t.remove(),document.removeEventListener("keydown",e))})}function closeSekolahKecamatanModal(){const e=document.getElementById("sekolahKecamatanModal");e&&(e.style.display="none")}function generateStatistikByKecamatan(e,t){const a={};kecamatanMelawi.forEach(e=>{a[e]={kecamatan:e,sekolahList:[],jumlahSekolah:0,jumlahSiswa:0}}),a.LAINNYA={kecamatan:"LAINNYA",sekolahList:[],jumlahSekolah:0,jumlahSiswa:0},e.forEach(e=>{const t=e[0],n=e[2],o=normalizeKecamatan(n),i=e[4]||"Unknown";a[o].sekolahList.push({kode:t,nama:i,npsn:e[3]||"N/A",kecamatanAsli:n}),a[o].jumlahSekolah++}),t.forEach(t=>{const n=t[0],o=e.find(e=>String(e[0])===String(n));if(o){const e=normalizeKecamatan(o[2]);a[e]&&a[e].jumlahSiswa++}});return Object.values(a).filter(e=>e.jumlahSekolah>0||e.jumlahSiswa>0||"LAINNYA"===e.kecamatan&&(e.jumlahSekolah>0||e.jumlahSiswa>0)).map(e=>({...e,rataRataSiswa:e.jumlahSekolah>0?(e.jumlahSiswa/e.jumlahSekolah).toFixed(1):"0"})).sort((e,t)=>"LAINNYA"===e.kecamatan?1:"LAINNYA"===t.kecamatan?-1:e.kecamatan.localeCompare(t.kecamatan))}function renderAdminTable(e){const t={siswa:"adminSiswaTableBody",sekolah:"adminSekolahTableBody",dashboardContent:null}[e];if(!t)return;const a=document.getElementById(t);if(!a)return;let n;window.LoadingManager&&LoadingManager.showTableLoading(t,"Memuat data..."),n="rekapNilaiAdmin"===e?getRekapNilaiLengkapData():database[e]||[],"siswa"===e&&n.length,window.LoadingManager&&LoadingManager.hideTableLoading(t),updateAdminCounters();const o=document.getElementById(`search${capitalize(e)}`),i=(o?o.value:"").toLowerCase(),s=applySort(i?n.filter(t=>{if(["rekapNilaiAdmin","sekolah"].includes(e))return Object.values(t).some(e=>String(e).toLowerCase().includes(i));return t.some(e=>String(e).toLowerCase().includes(i))}):n,e);optimizedUpdatePaginationControls(e,s.length);const r=paginationState[e],l="all"===r.rowsPerPage?s.length:parseInt(r.rowsPerPage),d=(r.currentPage-1)*l,c=d+l,u=s.slice(d,c);if(a.innerHTML="","rekapNilaiAdmin"===e||u.forEach(t=>{const n=a.insertRow();if("siswa"===e){0===n.rowIndex&&t.forEach((e,t)=>{});t.slice(0,11).forEach(e=>{n.insertCell().textContent=e||"-"})}else{t.forEach(e=>{n.insertCell().textContent=e||"-"})}if("sekolah"===e){const e=n.insertCell();e.classList.add("action-cell");const a=t[0];e.innerHTML=`\n    <button type="button" class="btn btn-edit btn-edit-sekolah" data-kode="${a}">Edit</button>\n    <button type="button" class="btn btn-delete btn-delete-sekolah" data-kode="${a}">Hapus</button>\n`}else if("siswa"===e){const e=n.insertCell();e.classList.add("action-cell");const a=t[6],o=t[7];e.innerHTML=`\n    <button type="button" class="btn btn-edit btn-edit-admin btn-edit-siswa" data-nisn="${a}" data-nama="${o}">Edit</button>\n    <button type="button" class="btn btn-delete btn-delete-admin btn-delete-siswa" data-nisn="${a}" data-nama="${o}">Hapus</button>\n`}}),window.EmptyStateManager){const a=`empty${capitalize(e)}State`;EmptyStateManager.checkTableData(t,a)}}function renderAdminSiswaTable(){renderAdminTable("siswa")}function populateDashboardStatistics(){try{const e=database.sekolah?database.sekolah.length:0,t=database.siswa?database.siswa.length:0;updateStatCard("totalSekolahStat",e,"Total Sekolah"),updateStatCard("totalSiswaStat",t,"Total Siswa"),calculateKecamatanStatistics()}catch(e){console.error("Error populating dashboard statistics:",e)}}function updateStatCard(e,t,a){const n=document.getElementById(e);n&&animateNumber(n,0,t,1e3)}function animateNumber(e,t,a,n){const o=performance.now(),i=a-t;requestAnimationFrame(function s(r){const l=r-o,d=Math.min(l/n,1),c=easeOutQuart(d),u=Math.floor(t+i*c);e.textContent=u.toLocaleString(),d<1?requestAnimationFrame(s):e.textContent=a.toLocaleString()})}function easeOutQuart(e){return 1-Math.pow(1-e,4)}function calculateKecamatanStatistics(){const e=["BELIMBING","BELIMBING HULU","ELLA HILIR","MENUKUNG","NANGA PINOH","PINOH SELATAN","PINOH UTARA","SAYAN","SOKAN","TANAH PINOH","TANAH PINOH BARAT"],t={};e.forEach(e=>{t[e]=0}),database.siswa&&database.sekolah&&database.siswa.forEach(a=>{const n=a[0],o=database.sekolah.find(e=>e[0]===n);if(o){const a=o[2],n=e.find(e=>e.toLowerCase()===a.toLowerCase());n&&t[n]++}}),updateKecamatanCards(t)}function updateKecamatanCards(e){Object.entries(e).forEach(([e,t])=>{const a=document.querySelector(`[data-kecamatan="${e}"]`);if(a){const e=a.querySelector(".kecamatan-count");e&&animateNumber(e,0,t,800)}})}function initializeSiswaSearch(){window.siswaSearch?window.siswaSearch.init():setTimeout(()=>{window.siswaSearch&&window.siswaSearch.init()},500)}function refreshSiswaSearchData(){window.siswaSearch&&window.siswaSearch.refreshData()}function updatePaginationControls(e,t){const a=document.querySelector(`.pagination-controls[data-table-id="${e}"]`);if(!a)return;const n=paginationState[e];if(!n)return;const o=parseInt(n.rowsPerPage,10),i=o>0?Math.ceil(t/o):1,s=a.querySelector(".pagination-info"),r=a.querySelector(".rows-per-page"),l=a.querySelector(".prev-page"),d=a.querySelector(".next-page");if(s){const e=t>0?(n.currentPage-1)*o+1:0,a=Math.min(e+o-1,t);s.textContent=`Menampilkan ${e} - ${a} dari ${t} siswa`}r&&(r.value=n.rowsPerPage),l&&(l.disabled=n.currentPage<=1),d&&(d.disabled=n.currentPage>=i)}async function deleteAllData(e){try{"function"==typeof showLoader&&showLoader();const t=await fetchWithAuth(apiUrl("/api/data/delete-all"),{method:"POST",body:JSON.stringify({tableId:e})});if(!t?.success)throw new Error(t?.message||"Gagal menghapus data.");await fetchDataFromServer();const a=[e];a.forEach(e=>{const t=document.getElementById(`search${e.charAt(0).toUpperCase()}${e.slice(1)}`)||document.querySelector(`.search-bar[data-table-id="${e}"]`);t&&(t.value=""),"object"==typeof searchState&&Object.prototype.hasOwnProperty.call(searchState,e)&&(searchState[e]=""),"object"==typeof paginationState&&(paginationState[e]||(paginationState[e]={currentPage:1,rowsPerPage:10}),paginationState[e].currentPage=1,paginationState[e].rowsPerPage="all")}),"function"==typeof renderAdminTable?a.forEach(e=>renderAdminTable(e)):"function"==typeof rerenderActiveTable&&a.forEach(e=>rerenderActiveTable(e)),"siswa"===e&&refreshSiswaSearchData(),"function"==typeof showNotification&&showNotification(t.message||"Data berhasil dihapus.","success")}catch(e){let t=e?.message||String(e)||"Terjadi kesalahan.";try{const e=JSON.parse(t);e&&e.message&&(t=e.message)}catch(e){}console.error("deleteAllData error:",e),"function"==typeof showNotification&&showNotification(t,"error")}finally{"function"==typeof hideLoader&&hideLoader()}}function renderGenericSiswaTable(e,t,a){if("sekolah"!==window.currentUser.role||!window.currentUser.schoolData)return;const n="transkripNilai"===e?"transkripSiswaTableBody":`${e}SiswaTableBody`,o=document.getElementById(n);if(!o)return;window.LoadingManager&&LoadingManager.showTableLoading(n,"Memuat data siswa...");const i=String(window.currentUser.schoolData[0]);let s=filterSiswaData(database.siswa.filter(e=>String(e[0])===i),searchState[e]);s=applySort(s,e),window.LoadingManager&&LoadingManager.hideTableLoading(n),o.innerHTML="";const r=paginationState[e]||{currentPage:1,rowsPerPage:10};paginationState[e]||(paginationState[e]={currentPage:1,rowsPerPage:10});const l="all"===r.rowsPerPage?s.length:parseInt(r.rowsPerPage),d=l>0?Math.ceil(s.length/l):1;r.currentPage=Math.max(1,Math.min(r.currentPage,d));const c=(r.currentPage-1)*l,u="all"===r.rowsPerPage?s.length:c+l;if(s.slice(c,u).forEach((n,i)=>{const s=n[6]||`temp-${c+i}`,r=o.insertRow();let l='<span style="color: #6c757d;">-</span>';l="skkb"===e?'<span style="color: #1e8e3e; font-weight: bold;" title="Dokumen siap dicetak">✔</span>':checkNilaiLengkap(s,!1)?'<span style="color: #1e8e3e; font-weight: bold;" title="Nilai sudah lengkap, dokumen siap dicetak">✔</span>':'<span style="color: #ff9800; font-weight: bold;" title="Nilai belum lengkap, tidak dapat dicetak">⚠️</span>';let d="";t&&(d+=`<button class="btn btn-small btn-view" onclick="${t}('${s}')">Lihat</button>`);const u="skkb"===e||checkNilaiLengkap(s,!1);d+=`<button class="btn btn-small btn-pdf" onclick="${u?`${a}('${s}')`:"showNotification('Nilai belum lengkap.', 'warning')"}" ${u?"":"disabled"}>PDF</button>`,r.innerHTML=`\n            <td>${c+i+1}</td>\n            <td>${n[7]||""}</td>\n            <td>${s}</td>\n            <td style="text-align: center;">${l}</td>\n            <td>${d}</td>`}),optimizedUpdatePaginationControls(e,s.length),updateSortHeaders(e),window.EmptyStateManager){const t=`empty${capitalize(e)}State`;EmptyStateManager.checkTableData(n,t)}}function renderTranskripSiswaTable(){renderGenericSiswaTable("transkripNilai","openTranskripModal","downloadTranskripPDF")}function renderSklSiswaTable(){renderGenericSiswaTable("skl","openSklModal","downloadSklPDF")}function renderSkkbSiswaTable(){renderGenericSiswaTable("skkb","openSkkbModal","downloadSkkbPDF")}function renderRekapNilai(){if("sekolah"!==window.currentUser.role||!window.currentUser.schoolData)return;const e=document.getElementById("rekapNilaiThead"),t=document.getElementById("rekapNilaiTbody");window.LoadingManager&&t&&LoadingManager.showTableLoading("rekapNilaiTbody","Memuat rekap nilai...");const a=String(window.currentUser.schoolData[0]);let n=filterSiswaData(database.siswa.filter(e=>String(e[0])===a),searchState.rekapNilai);e.innerHTML="",t.innerHTML="",window.LoadingManager&&t&&LoadingManager.hideTableLoading("rekapNilaiTbody");const o=subjects[window.currentUser.kurikulum],i=(database.settings[a]||{}).subjectVisibility||{},s=database.nilai._mulokNames?.[a]||{},r=o.filter(e=>e.startsWith("MULOK")?s[e]&&""!==s[e].trim():!1!==i[e]),l=e.insertRow();l.innerHTML="<th>NO</th><th>NISN</th><th>NAMA</th>",r.forEach(e=>{const t=s[e]||e;l.innerHTML+=`<th>${t}</th>`}),l.innerHTML+="<th>RATA-RATA</th>";const d=paginationState.rekapNilai,c="all"===d.rowsPerPage?n.length:parseInt(d.rowsPerPage),u=c>0?Math.ceil(n.length/c):1;d.currentPage=Math.max(1,Math.min(d.currentPage,u));const g=(d.currentPage-1)*c,m="all"===d.rowsPerPage?n.length:g+c;n.slice(g,m).forEach((e,a)=>{const n=e[6]||`temp-${g+a}`,o=t.insertRow();o.innerHTML=`<td>${g+a+1}</td><td>${n}</td><td>${e[7]||""}</td>`;let i=0,s=0;r.forEach(e=>{const t=calculateAverageForSubject(n,e),a=null!==t?t.toFixed(2):"-";o.innerHTML+=`<td style="text-align: center;">${a}</td>`,null===t||isNaN(t)||(i+=t,s++)});const l=s>0?(s>0?i/s:0).toFixed(2):"-";o.innerHTML+=`<td style="text-align: center; font-weight: bold;">${l}</td>`}),optimizedUpdatePaginationControls("rekapNilai",n.length),updateSortHeaders("rekapNilai");const p=document.getElementById("downloadRekapNilaiSekolahPdfBtn");if(p&&(p.onclick=()=>{downloadRekapNilaiSekolahPDF(n,r,s)}),window.EmptyStateManager){const e="emptyRekapNilaiState";EmptyStateManager.checkTableData("rekapNilaiTbody",e)}}async function downloadRekapNilaiSekolahPDF(e,t,a){if(!e||0===e.length)return void showNotification("Tidak ada data siswa untuk dicetak.","warning");showLoader();const{jsPDF:n}=window.jspdf;try{const o=new n({orientation:"landscape",unit:"mm",format:"a4"}),i=(window.currentUser.schoolData[4]||"SEKOLAH").toUpperCase(),s=window.currentUser.kurikulum||"Merdeka",r=[{header:"NO",dataKey:"no"},{header:"NAMA",dataKey:"nama"},{header:"NISN",dataKey:"nisn"}];t.forEach(e=>{const t=a[e]||e;r.push({header:t,dataKey:e})}),r.push({header:"RATA-RATA",dataKey:"average"});const l=e.map((e,a)=>{const n={no:a+1,nama:e[7]||"",nisn:e[6]||""};let o=0,i=0;t.forEach(t=>{const a=calculateAverageForSubject(e[6],t);n[t]=a>0?a.toFixed(2):"-",a>0&&(o+=a,i++)});const s=i>0?o/i:0;return n.average=s>0?s.toFixed(2):"-",n}),d=(t,a)=>{t.setFontSize(16),t.setFont(void 0,"bold"),t.text("REKAP NILAI AKHIR SISWA",148,20,{align:"center"}),t.text("TAHUN PELAJARAN 2024/2025",148,30,{align:"center"}),t.setFontSize(11),t.setFont(void 0,"normal");const n=49;t.text("KECAMATAN",14,42),t.text("NAMA SEKOLAH",14,48),t.text("NPSN",14,54),t.text("KURIKULUM",14,60),t.text("JUMLAH SISWA",14,66),t.text(":",n,42),t.text(":",n,48),t.text(":",n,54),t.text(":",n,60),t.text(":",n,66),t.text(window.currentUser.schoolData[2]||"-",54,42),t.text(i,54,48),t.text(window.currentUser.schoolData[3]||"-",54,54),t.text(s,54,60),t.text(`${e.length} orang`,54,66)};d(o,1),o.autoTable({columns:r,body:l,startY:75,styles:{fontSize:7,cellPadding:1.5,overflow:"linebreak",cellWidth:"wrap"},headStyles:{fillColor:[41,128,185],textColor:255,fontSize:7,fontStyle:"bold"},columnStyles:{0:{halign:"center",cellWidth:12},1:{halign:"left",cellWidth:45},2:{halign:"center",cellWidth:20}},margin:{top:75,right:5,bottom:20,left:5},tableWidth:"auto",didDrawPage:e=>{e.pageNumber>1&&d(o,e.pageNumber)}});const c=(new Date).toLocaleDateString("id-ID",{year:"numeric",month:"long",day:"numeric"});let u=(o.autoTable.previous.finalY||75)+20;u>180&&(o.addPage(),d(o,o.internal.getNumberOfPages()),u=90),o.setFontSize(11),o.setFont(void 0,"normal");const g=window.currentUser.schoolData[2]||"Nanga Pinoh";o.text(`${g}, ${c}`,200,u,{align:"left"}),u+=10,o.text("Kepala Sekolah,",200,u,{align:"left"}),u+=30;const m=database.settings[window.currentUser.schoolData[0]]?.principalName||"PRASETYA LUKMANA, S.KOM";o.setFont(void 0,"bold"),o.text(m,200,u,{align:"left"});const p=o.getStringUnitWidth(m)*o.internal.getFontSize()/o.internal.scaleFactor;o.line(200,u+2,200+p,u+2),u+=8;const h=database.settings[window.currentUser.schoolData[0]]?.principalNip||"198840620252111031";o.setFont(void 0,"normal"),o.text(`NIP. ${h}`,200,u,{align:"left"});const k=`Rekap_Nilai_${i.replace(/\s+/g,"_")}_${(new Date).toISOString().slice(0,10)}.pdf`;o.save(k),showNotification("PDF rekap nilai berhasil dibuat!","success")}catch(e){console.error("Error membuat PDF:",e),showNotification("Gagal membuat file PDF rekap nilai.","error")}finally{hideLoader()}}function checkNilaiLengkap(e,t=!0){if(!e)return!1;for(const a of semesterIds)if(!checkNilaiLengkapForSemester(e,a))return t&&showNotification("Data nilai belum lengkap. Periksa semua semester.","warning"),!1;return!0}function checkNilaiLengkapForSemester(e,t){if(!e)return!1;const a=subjects[window.currentUser.kurikulum];for(const n of a){const a=database.nilai[e]?.[t]?.[n];if(n.startsWith("MULOK")){const e=String(window.currentUser.schoolData[0]),t=database.nilai._mulokNames?.[e]?.[n];if(!t||""===t.trim())continue}if(!a)return!1;if("K13"===window.currentUser.kurikulum){if(!a.KI3||""===String(a.KI3).trim()||!a.KI4||""===String(a.KI4).trim())return!1}else if(!a.NILAI||""===String(a.NILAI).trim())return!1}return!0}function calculateAverageForSubject(e,t){let a=0,n=0;return Object.keys({1:"KELAS 1 SEMESTER 1",2:"KELAS 1 SEMESTER 2",3:"KELAS 2 SEMESTER 1",4:"KELAS 2 SEMESTER 2",5:"KELAS 3 SEMESTER 1",6:"KELAS 3 SEMESTER 2",7:"KELAS 4 SEMESTER 1",8:"KELAS 4 SEMESTER 2",9:"KELAS 5 SEMESTER 1",10:"KELAS 5 SEMESTER 2",11:"KELAS 6 SEMESTER 1",12:"KELAS 6 SEMESTER 2"}).forEach(o=>{const i=database.nilai[e]?.[o]?.[t];let s;if("K13"===window.currentUser.kurikulum)if(i&&void 0!==i.RT&&""!==String(i.RT).trim())s=i.RT;else if(i&&""!==String(i.KI3||"").trim()&&""!==String(i.KI4||"").trim()){const e=parseFloat(i.KI3),t=parseFloat(i.KI4);isNaN(e)||isNaN(t)||(s=Math.round((e+t)/2))}else s="";else s=i?.NILAI||"";""===s||isNaN(s)||(a+=parseFloat(s),n++)}),n>0?a/n:null}function createTranskripHTML(e){const t=database.siswa.find(t=>t[6]===e),a=window.currentUser.schoolData;if(!t||!a)return"<p>Data tidak ditemukan.</p>";const n=String(a[0]),o=database.settings[n]||{},{tableRows:i}=createNilaiTableHTML(e,"transkrip"),s=(a[4]||"NAMA SEKOLAH").toUpperCase(),r=s.length>40?`<p style="font-size: 1em;">${s}</p>`:`<p>${s}</p>`,l=formatDateToIndonesian(o.printDate)||(new Date).toLocaleDateString("id-ID",{day:"numeric",month:"long",year:"numeric"}),d=(o.transcriptNumber||"431.211/07/").replace(/ /g,"&nbsp;"),c="pro"===window.currentUser?.loginType||n&&"true"===localStorage.getItem(`kodeProActivated:${n}`),u=o.logoLeftPosTop||13,g=o.logoLeftPosLeft||15,m=o.logoRightPosTop||13,p=o.logoRightPosRight||15;return`\n        <div class="transkrip-full-header">\n            <img src="${c&&o.logoLeft?o.logoLeft:"./assets/kop-left-melawi.png"}" alt="Logo Kiri" class="transkrip-logo" style="position: absolute; top: ${u}mm; left: ${g}mm; width: ${o.logoLeftSize||80}px; height: auto;" >\n            <div class="transkrip-header-text" style="display: inline-block; vertical-align: middle; padding-top: 13mm;">\n                <p><strong>PEMERINTAH KABUPATEN MELAWI</strong></p>\n                ${r}\n                <p style="font-weight: normal; font-size: 0.9em;">${o.schoolAddress||"JL. PENDIDIKAN NANGA PINOH"}</p>\n            </div>\n            <img src="${c&&o.logoRight?o.logoRight:"./assets/kop-right-tutwuri.png"}" alt="Logo Kanan" class="transkrip-logo" style="position: absolute; top: ${m}mm; right: ${p}mm; width: ${o.logoRightSize||80}px; height: auto;" >\n        </div>\n        <hr class="transkrip-hr">\n        <div style="text-align: center; margin: 20px 0;">\n            <h2 style="font-size: 18px; font-weight: bold; margin: 10px 0;"><strong><u>TRANSKRIP NILAI</u></strong></h2>\n            <p style="margin: 5px 0;">Nomor : ${d}</p>\n        </div>\n        <div class="transkrip-student-info-table">\n            <table style="border: none; margin-bottom: 20px; font-size: 14px;">\n                <tr style="border: none;">\n                    <td style="border: none; padding: 3px 0; vertical-align: top; width: 200px;">Satuan Pendidikan</td>\n                    <td style="border: none; padding: 3px 5px; vertical-align: top; width: 20px;">:</td>\n                    <td style="border: none; padding: 3px 0; vertical-align: top;">${toTitleCase(a[4]||"SEKOLAH DASAR SWASTA ISLAM TERPADU INSAN KAMIL")}</td>\n                </tr>\n                <tr style="border: none;">\n                    <td style="border: none; padding: 3px 0; vertical-align: top;">Nomor Pokok Sekolah Nasional</td>\n                    <td style="border: none; padding: 3px 5px; vertical-align: top;">:</td>\n                    <td style="border: none; padding: 3px 0; vertical-align: top;">${a[3]||"69854814"}</td>\n                </tr>\n                <tr style="border: none;">\n                    <td style="border: none; padding: 3px 0; vertical-align: top;">Nama Lengkap</td>\n                    <td style="border: none; padding: 3px 5px; vertical-align: top;">:</td>\n                    <td style="border: none; padding: 3px 0; vertical-align: top;">${toTitleCase(t[7]||"ACHMAD FAHRY SETIAWAN")}</td>\n                </tr>\n                <tr style="border: none;">\n                    <td style="border: none; padding: 3px 0; vertical-align: top;">Tempat, Tanggal Lahir</td>\n                    <td style="border: none; padding: 3px 5px; vertical-align: top;">:</td>\n                    <td style="border: none; padding: 3px 0; vertical-align: top;">${formatBirthPlaceDate(t[8]||"NANGA PINOH, 9 September 2012")}</td>\n                </tr>\n                <tr style="border: none;">\n                    <td style="border: none; padding: 3px 0; vertical-align: top;">Nomor Induk Siswa Nasional</td>\n                    <td style="border: none; padding: 3px 5px; vertical-align: top;">:</td>\n                    <td style="border: none; padding: 3px 0; vertical-align: top;">${t[6]||"0128593698"}</td>\n                </tr>\n                <tr style="border: none;">\n                    <td style="border: none; padding: 3px 0; vertical-align: top;">Nomor Ijazah</td>\n                    <td style="border: none; padding: 3px 5px; vertical-align: top;">:</td>\n                    <td style="border: none; padding: 3px 0; vertical-align: top;">${t[11]||""}</td>\n                </tr>\n                <tr style="border: none;">\n                    <td style="border: none; padding: 3px 0; vertical-align: top;">Tanggal Kelulusan</td>\n                    <td style="border: none; padding: 3px 5px; vertical-align: top;">:</td>\n                    <td style="border: none; padding: 3px 0; vertical-align: top;">2 Juni 2025</td>\n                </tr>\n            </table>\n        </div>\n        <table id="transkripNilaiTable" style="border-collapse: collapse; width: 100%; margin-bottom: 30px;">\n            <thead>\n                <tr style="border: 1px solid black;">\n                    <th style="border: 1px solid black; padding: 8px; text-align: center; width: 50px;">No</th>\n                    <th style="border: 1px solid black; padding: 8px; text-align: center;">Mata Pelajaran</th>\n                    <th style="border: 1px solid black; padding: 8px; text-align: center; width: 80px;">Nilai</th>\n                </tr>\n            </thead>\n            <tbody>${i}</tbody>\n        </table>\n        <div class="transkrip-signature" style="text-align: right; margin-top: 40px;">\n            <div class="transkrip-signature-block" style="display: inline-block; text-align: left;">\n                <p>Kabupaten Melawi, ${l}</p>\n                <p>Kepala,</p><br><br><br>\n                <p class="principal-name" style="text-decoration: underline;"><strong>${o.principalName||"Prasetya Lukmana, S.Kom"}</strong></p>\n                <p>${o.principalNip?"NIP. "+o.principalNip:"NIP. 198840620252111031"}</p>\n            </div>\n        </div>`}function createSklHTML(e){const t=database.siswa.find(t=>t[6]===e),a=window.currentUser.schoolData;if(!t||!a)return"<p>Data tidak ditemukan.</p>";const n=String(a[0]),o=database.settings[n]||{},{tableRows:i}=createNilaiTableHTML(e,"skl"),s=(a[4]||"NAMA SEKOLAH").toUpperCase(),r=s.length>40?`<p style="font-size: 1em;">${s}</p>`:`<p>${s}</p>`,l=database.sklPhotos?.[e];let d,c="skl-pasfoto no-photo";l?(d=`<img src="${l}" alt="Pasfoto">`,c="skl-pasfoto has-photo"):d='\n            <p style="margin: 0;">Pasfoto 3 cm x 4 cm</p>\n            <p style="margin: 0;">hitam putih atau</p>\n            <p style="margin: 0;">berwarna</p>\n        ';const u=formatDateToIndonesian(o.printDate)||(new Date).toLocaleDateString("id-ID",{day:"numeric",month:"long",year:"numeric"}),g=(o.transcriptNumber||"400.3/").replace(/ /g,"&nbsp;"),m="pro"===window.currentUser?.loginType||n&&"true"===localStorage.getItem(`kodeProActivated:${n}`),p=o.logoLeftPosTop||13,h=o.logoLeftPosLeft||15,k=o.logoRightPosTop||13,f=o.logoRightPosRight||15,b=o.sklPhotoLayout||5;return`\n        <div class="transkrip-full-header">\n            <img src="${m&&o.logoLeft?o.logoLeft:"./assets/kop-left-melawi.png"}" alt="Logo Kiri" class="transkrip-logo" style="position: absolute; top: ${p}mm; left: ${h}mm; width: ${o.logoLeftSize||80}px; height: auto;" >\n            <div class="transkrip-header-text" style="display: inline-block; vertical-align: middle; padding-top: 13mm;">\n                <p><strong>PEMERINTAH KABUPATEN MELAWI</strong></p>\n                ${r}\n                <p style="font-weight: normal; font-size: 0.9em;">${o.schoolAddress||"JL. PENDIDIKAN KECAMATAN NANGA PINOH KABUPATEN MELAWI"}</p>\n            </div>\n            <img src="${m&&o.logoRight?o.logoRight:"./assets/kop-right-tutwuri.png"}" alt="Logo Kanan" class="transkrip-logo" style="position: absolute; top: ${k}mm; right: ${f}mm; width: ${o.logoRightSize||80}px; height: auto;" >\n        </div>\n        <hr class="transkrip-hr">\n        <p class="transkrip-title"><strong><u>SURAT KETERANGAN LULUS</u></strong></p>\n        <p class="transkrip-nomor" style="text-align: center;"><strong>TAHUN PELAJARAN 2025/2026</strong></p>\n        <p class="transkrip-nomor" style="text-align: center;">Nomor: ${g}</p>\n        <p class="skl-body-text">Yang bertanda tangan dibawah ini, Kepala ${toTitleCase(a[4]||"SEKOLAH DASAR SWASTA ISLAM TERPADU INSAN KAMIL")} NPSN: ${a[3]||"69854814"} Kecamatan ${toTitleCase(a[2]||"NANGA PINOH")} Kabupaten Melawi Provinsi Kalimantan Barat menerangkan :</p>\n        <div class="skl-student-info-table">\n            <table style="border: none; margin-left: 4cm; margin-bottom: 20px;">\n                <tr style="border: none;">\n                    <td style="border: none; padding: 3px 0; vertical-align: top; width: 200px;">Nama</td>\n                    <td style="border: none; padding: 3px 5px; vertical-align: top; width: 20px;">:</td>\n                    <td style="border: none; padding: 3px 0; vertical-align: top;">${toTitleCase(t[7]||"ACHMAD FAHRY SETIAWAN")}</td>\n                </tr>\n                <tr style="border: none;">\n                    <td style="border: none; padding: 3px 0; vertical-align: top;">Tempat Dan Tanggal Lahir</td>\n                    <td style="border: none; padding: 3px 5px; vertical-align: top;">:</td>\n                    <td style="border: none; padding: 3px 0; vertical-align: top;">${formatBirthPlaceDate(t[8]||"NANGA PINOH, 08 SEPTEMBER 2012")}</td>\n                </tr>\n                <tr style="border: none;">\n                    <td style="border: none; padding: 3px 0; vertical-align: top;">Nama Orang Tua/Wali</td>\n                    <td style="border: none; padding: 3px 5px; vertical-align: top;">:</td>\n                    <td style="border: none; padding: 3px 0; vertical-align: top;">${toTitleCase(t[10]||"TATO")}</td>\n                </tr>\n                <tr style="border: none;">\n                    <td style="border: none; padding: 3px 0; vertical-align: top;">Nomor Induk Siswa</td>\n                    <td style="border: none; padding: 3px 5px; vertical-align: top;">:</td>\n                    <td style="border: none; padding: 3px 0; vertical-align: top;">${t[5]||"0134"}</td>\n                </tr>\n                <tr style="border: none;">\n                    <td style="border: none; padding: 3px 0; vertical-align: top;">Nomor Induk Siswa Nasional</td>\n                    <td style="border: none; padding: 3px 5px; vertical-align: top;">:</td>\n                    <td style="border: none; padding: 3px 0; vertical-align: top;">${t[6]||"0128593698"}</td>\n                </tr>\n                <tr style="border: none;">\n                    <td style="border: none; padding: 3px 0; vertical-align: top;">Nomor Ijazah</td>\n                    <td style="border: none; padding: 3px 5px; vertical-align: top;">:</td>\n                    <td style="border: none; padding: 3px 0; vertical-align: top;">${t[11]||""}</td>\n                </tr>\n            </table>\n        </div>\n        <div style="text-align: center; margin: 30px 0;">\n            <h2 style="font-size: 24px; font-weight: bold; margin: 0;"><strong>LULUS</strong></h2>\n        </div>\n        <table id="sklNilaiTable" style="border-collapse: collapse; width: 100%; margin-bottom: 20px;">\n            <thead>\n                <tr style="border: 1px solid black;">\n                    <th style="border: 1px solid black; padding: 8px; text-align: center; width: 50px;">No</th>\n                    <th style="border: 1px solid black; padding: 8px; text-align: center;">Mata Pelajaran</th>\n                    <th style="border: 1px solid black; padding: 8px; text-align: center; width: 80px;">Nilai</th>\n                </tr>\n            </thead>\n            <tbody>${i}</tbody>\n        </table>\n        <p class="skl-body-text" style="margin-top: 15px;">Surat Keterangan Kelulusan ini bersifat sementara sampai dikeluarkannya Ijazah.</p>\n        <div class="skl-footer" style="position: relative; margin-top: 30px; height: 4cm; width: 100%;">\n            <div class="${c}" style="position: absolute; left: ${b}%; top: 0; width: 3cm; height: 4cm; border: 1px solid black; display: flex; align-items: center; justify-content: center; flex-direction: column; font-size: 12px; text-align: center;">${d}</div>\n            <div class="transkrip-signature-block" style="position: absolute; right: 0; top: 0; text-align: left; width: 280px;">\n                <p>Kabupaten Melawi, ${u}</p>\n                <p>Kepala Sekolah,</p><br><br><br>\n                <p class="principal-name" style="text-decoration: underline;"><strong>${o.principalName||"PRASETYA LUKMANA, S.KOM"}</strong></p>\n                <p>${o.principalNip?"NIP. "+o.principalNip:"NIP. 198840620252111031"}</p>\n            </div>\n        </div>`}function createSkkbHTML(e){const t=database.siswa.find(t=>t[6]===e),a=window.currentUser.schoolData;if(!t||!a)return"<p>Data tidak ditemukan.</p>";const n=String(a[0]),o=database.settings[n]||{},i=(a[4]||"NAMA SEKOLAH").toUpperCase(),s=i.length>40?`<p style="font-size: 1em;">${i}</p>`:`<p>${i}</p>`,r=formatDateToIndonesian(o.printDate)||".........................",l=(o.skkbNumber||"").replace(/ /g,"&nbsp;"),d="pro"===window.currentUser?.loginType||n&&"true"===localStorage.getItem(`kodeProActivated:${n}`),c=o.logoLeftPosTop||13,u=o.logoLeftPosLeft||15,g=o.logoRightPosTop||13,m=o.logoRightPosRight||15;return`\n        <div class="transkrip-full-header">\n            <img src="${d&&o.logoLeft?o.logoLeft:"./assets/kop-left-melawi.png"}" alt="Logo Kiri" class="transkrip-logo" style="position: absolute; top: ${c}mm; left: ${u}mm; width: ${o.logoLeftSize||80}px; height: auto;" >\n            <div class="transkrip-header-text" style="display: inline-block; vertical-align: middle; padding-top: 13mm;">\n                <p><strong>PEMERINTAH KABUPATEN MELAWI</strong></p>\n                ${s}\n                <p style="font-weight: normal; font-size: 0.9em;">${o.schoolAddress||""}</p>\n            </div>\n            <img src="${d&&o.logoRight?o.logoRight:"./assets/kop-right-tutwuri.png"}" alt="Logo Kanan" class="transkrip-logo" style="position: absolute; top: ${g}mm; right: ${m}mm; width: ${o.logoRightSize||80}px; height: auto;" >\n        </div>\n        <hr class="transkrip-hr">\n\n        <div style="text-align: center; margin: 30px 0;">\n            <p class="transkrip-title" style="margin: 20px 0;"><strong><u>SURAT KETERANGAN BERKELAKUAN BAIK</u></strong></p>\n            <p class="transkrip-nomor" style="margin: 10px 0;">Nomor:&nbsp;${l}</p>\n        </div>\n\n        <div style="margin: 30px 0; text-align: justify; line-height: 1.8;">\n            <p class="skl-body-text" style="margin-bottom: 20px;">Yang bertanda tangan dibawah ini, Kepala ${toTitleCase(a[4])} NPSN: ${a[3]} Kecamatan ${toTitleCase(a[2])} Kabupaten Melawi Provinsi Kalimantan Barat menerangkan dengan sesungguhnya bahwa :</p>\n\n            <div class="skl-student-info-table" style="text-align: center; margin: 40px 0; margin-left: 3.5cm;">\n                <table style="margin: 0 auto; border-spacing: 0; line-height: 2.0; text-align: left;">\n                    <tr>\n                        <td style="border: none; padding: 3px 0; vertical-align: top; width: 200px;">Nama</td>\n                        <td style="border: none; padding: 3px 5px; vertical-align: top; width: 20px;">:</td>\n                        <td style="border: none; padding: 3px 0; vertical-align: top;">${toTitleCase(t[7]||"")}</td>\n                    </tr>\n                    <tr>\n                        <td style="border: none; padding: 3px 0; vertical-align: top;">Tempat Dan Tanggal Lahir</td>\n                        <td style="border: none; padding: 3px 5px; vertical-align: top; width: 20px;">:</td>\n                        <td style="border: none; padding: 3px 0; vertical-align: top;">${formatBirthPlaceDate(t[8]||"")}</td>\n                    </tr>\n                    <tr>\n                        <td style="border: none; padding: 3px 0; vertical-align: top;">Nomor Induk Siswa Nasional</td>\n                        <td style="border: none; padding: 3px 5px; vertical-align: top; width: 20px;">:</td>\n                        <td style="border: none; padding: 3px 0; vertical-align: top;">${t[6]||""}</td>\n                    </tr>\n                </table>\n            </div>\n\n            <p class="skl-body-text" style="margin-top: 30px; margin-bottom: 15px;">Adalah benar-benar siswa kami dan selama menjadi siswa di sekolah ini yang bersangkutan berkelakuan baik.</p>\n            <p class="skl-body-text" style="margin-bottom: 40px;">Demikian surat keterangan ini kami buat dengan sebenarnya untuk dapat dipergunakan sebagaimana mestinya.</p>\n        </div>\n\n        <div style="margin-top: 50px; text-align: right;">\n            <div style="display: inline-block; text-align: left; width: 280px;">\n                <p>Kabupaten Melawi, ${r.replace(/,/g,"")}</p>\n                <p>Kepala Sekolah,</p>\n                <br><br><br>\n                <p style="text-decoration: underline; font-weight: bold;">${o.principalName||""}</p>\n            </div>\n        </div>`}function createNilaiTableHTML(e,t,a=null){let n="",o=0,i=0;const s=String(window.currentUser.schoolData[0]),r=(database.settings[s]||{}).subjectVisibility||{},l=database.nilai[e]||{},d=transcriptSubjects[window.currentUser.kurikulum].filter(e=>!1!==r[e.key]);d.forEach((s,r)=>{let d;if(a){const e=l[a]?.[s.key];d=("K13"===window.currentUser.kurikulum?e?.RT:e?.NILAI)||""}else{const t=calculateAverageForSubject(e,s.key);d=null!==t?t.toFixed(2):"",null!==t&&(o+=t,i++)}n+="skl"===t||"transkrip"===t?`<tr style="border: 1px solid black;"><td style="border: 1px solid black; padding: 8px; text-align: center;">${r+1}</td><td style="border: 1px solid black; padding: 8px;">${s.display}</td><td style="border: 1px solid black; padding: 8px; text-align: center;">${d}</td></tr>`:`<tr><td style="text-align: center;">${r+1}</td><td>${s.display}</td><td style="text-align: center;">${d}</td></tr>`});const c=d.length+1;n+="skl"===t||"transkrip"===t?`<tr style="border: 1px solid black;"><td style="border: 1px solid black; padding: 8px; text-align: center;">${c}</td><td style="border: 1px solid black; padding: 8px;">Muatan Lokal</td><td style="border: 1px solid black; padding: 8px;"></td></tr>`:`<tr><td style="text-align: center;">${c}</td><td>Muatan Lokal</td><td></td></tr>`;const u="abcdefghijklmnopqrstuvwxyz",g=database.nilai?._mulokNames?.[s]||{};if(["MULOK1","MULOK2","MULOK3"].forEach((s,r)=>{const d=g[s]&&""!==g[s].trim(),c=d?g[s]:"-";let m="";if(d)if(a){const e=l[a]?.[s];m=("K13"===window.currentUser.kurikulum?e?.RT:e?.NILAI)||""}else{const t=calculateAverageForSubject(e,s);m=null!==t?t.toFixed(2):"",null!==t&&(o+=t,i++)}n+="skl"===t||"transkrip"===t?`\n                <tr style="border: 1px solid black;">\n                    <td style="border: 1px solid black; padding: 8px;"></td>\n                    <td style="border: 1px solid black; padding: 8px;"> &nbsp; &nbsp; ${u[r]}. ${c}</td>\n                    <td style="border: 1px solid black; padding: 8px; text-align: center;">${m}</td>\n                </tr>\n            `:`\n                <tr>\n                    <td></td>\n                    <td> &nbsp; &nbsp; ${u[r]}. ${c}</td>\n                    <td style="text-align: center;">${m}</td>\n                </tr>\n            `}),"skl"===t&&!a){const e=i>0?(o/i).toFixed(2):"-";n+=`\n            <tr style="border: 1px solid black;">\n                <td colspan="2" style="border: 1px solid black; padding: 8px; text-align: center; font-weight: bold;">Rata - Rata</td>\n                <td style="border: 1px solid black; padding: 8px; font-weight: bold; text-align: center;">${e}</td>\n            </tr>\n        `}return{tableRows:n}}function openTranskripModal(e){if(!checkNilaiLengkap(e))return;const t=createTranskripHTML(e);document.getElementById("transkripContent").innerHTML=t,updateLogoPreviewUI(),transkripModal.style.display="flex"}function openSklModal(e){if(!checkNilaiLengkap(e))return;const t=createSklHTML(e);document.getElementById("sklContent").innerHTML=t,setTimeout(()=>updateLogoPreviewUI(),100),sklModal.style.display="flex"}function openSkkbModal(e){const t=createSkkbHTML(e);document.getElementById("skkbContent").innerHTML=t,setTimeout(()=>updateLogoPreviewUI(),100),skkbModal.style.display="flex"}async function downloadTranskripPDF(e){checkNilaiLengkap(e,!1)||showNotification("Data nilai belum lengkap. PDF akan di-generate dengan data yang tersedia.","warning");const t=createTranskripHTML(e);await downloadAsPDF(t,e,"Transkrip")}async function downloadSklPDF(e){checkNilaiLengkap(e,!1)||showNotification("Data nilai belum lengkap. PDF akan di-generate dengan data yang tersedia.","warning");const t=createSklHTML(e);await downloadAsPDF(t,e,"SKL")}async function downloadSkkbPDF(e){const t=createSkkbHTML(e);await downloadAsPDF(t,e,"SKKB")}async function downloadAsPDF(e,t,a){const{jsPDF:n}=window.jspdf,o=document.getElementById("pdf-content"),i=database.siswa.find(e=>e[6]===t),s=window.currentUser.schoolData;if(i&&s){o.innerHTML=e,setTimeout(()=>updateLogoPreviewUI(),100),showLoader(),showNotification(`Membuat PDF ${a}.`,"success");try{await waitForImages(o);const e=(await html2canvas(o,{scale:3,useCORS:!0,backgroundColor:"#ffffff",imageTimeout:15e3})).toDataURL("image/png"),t=new n({orientation:"portrait",unit:"mm",format:[210,330]}),r=t.internal.pageSize.getWidth(),l=t.internal.pageSize.getHeight();t.addImage(e,"PNG",0,0,r,l);const d=(s[5]||"sekolah").replace(/ /g,"_"),c=`${a}_${d}_${(i[8]||"siswa").replace(/ /g,"_")}.pdf`;t.save(c)}catch(e){console.error("Error creating PDF:",e),showNotification("Gagal membuat file PDF.","error")}finally{o.innerHTML="",hideLoader()}}else showNotification("Data siswa atau sekolah tidak ditemukan.","error")}function renderSettingsPage(){if(!window.currentUser?.schoolData)return;const e=String(window.currentUser.schoolData[0]),t=database?.settings?.[e]||{},a=database?.nilai?._mulokNames?.[e]||{},n=(e,t)=>{const a=document.getElementById(e);a&&(a.value=t??"")},o=(e,t,a)=>{const n=document.getElementById(e),o=document.getElementById(t);n&&(n.value=a??n.value??""),o&&(o.textContent=String(n?n.value:a??""))};n("settingPrincipalName",t.principalName),n("settingPrincipalNip",t.principalNip),n("settingSchoolAddress",t.schoolAddress),n("settingPrintDate",t.printDate),n("settingTranscriptNumber",t.transcriptNumber),n("settingSkkbNumber",t.skkbNumber),n("settingMulok1Name",a.MULOK1),n("settingMulok2Name",a.MULOK2),n("settingMulok3Name",a.MULOK3);const i=document.getElementById("logoLeftPreview"),s=document.getElementById("logoRightPreview");i&&t.logoLeft&&(i.src=t.logoLeft),s&&t.logoRight&&(s.src=t.logoRight),o("settingLogoLeftSize","logoLeftSizeLabel",t.logoLeftSize||80),o("settingLogoRightSize","logoRightSizeLabel",t.logoRightSize||80);!(t.logoLeftSize&&t.logoRightSize&&t.logoLeftPosTop&&t.logoLeftPosLeft&&t.logoRightPosTop&&t.logoRightPosRight)&&setTimeout(()=>{const e=document.getElementById("settingsForm");if(e){const t=new Event("submit",{bubbles:!0,cancelable:!0});e.dispatchEvent(t)}},100),o("settingSklPhotoLayout","sklPhotoLayoutLabel",t.sklPhotoLayout),o("settingLogoLeftPosTop","logoLeftPosTopLabel",t.logoLeftPosTop||13),o("settingLogoLeftPosLeft","logoLeftPosLeftLabel",t.logoLeftPosLeft||15),o("settingLogoRightPosTop","logoRightPosTopLabel",t.logoRightPosTop||13),o("settingLogoRightPosRight","logoRightPosRightLabel",t.logoRightPosRight||15);const r=document.getElementById("subjectSelectionContainer");if(r){r.innerHTML="";const e=window.currentUser.kurikulum||"Merdeka",a=transcriptSubjects?.[e]||[],n=t.subjectVisibility||{};a.forEach(e=>{const t=!Object.prototype.hasOwnProperty.call(n,e.key)||!!n[e.key];r.insertAdjacentHTML("beforeend",`\n        <div class="subject-checkbox">\n          <input type="checkbox" id="check-${e.key}" data-subject-key="${e.key}" ${t?"checked":""}>\n          <label for="check-${e.key}">${e.display}</label>\n        </div>\n      `)})}else console.error("subjectSelectionContainer not found!");const l=document.querySelector(".tab-nav");l&&!l.dataset.inited&&("function"==typeof setupSettingTabs&&setupSettingTabs(),l.dataset.inited="1");[["settingLogoLeftSize","logoLeftSizeLabel"],["settingLogoRightSize","logoRightSizeLabel"],["settingSklPhotoLayout","sklPhotoLayoutLabel"],["settingLogoLeftPosTop","logoLeftPosTopLabel"],["settingLogoLeftPosLeft","logoLeftPosLeftLabel"],["settingLogoRightPosTop","logoRightPosTopLabel"],["settingLogoRightPosRight","logoRightPosRightLabel"]].forEach(([e,t])=>{const a=document.getElementById(e),n=document.getElementById(t);a&&n&&(n.textContent=a.value)}),bindLiveLogoOnce(),updateLogoPreviewUI(),"function"==typeof updateLivePreviewLogo&&updateLivePreviewLogo()}async function saveSettings(e){try{if(!window.currentUser.schoolData)return;const e=String(window.currentUser.schoolData[0]);showLoader();const t={principalName:document.getElementById("settingPrincipalName").value,principalNip:document.getElementById("settingPrincipalNip").value,schoolAddress:document.getElementById("settingSchoolAddress").value,printDate:document.getElementById("settingPrintDate").value,transcriptNumber:document.getElementById("settingTranscriptNumber").value,skkbNumber:document.getElementById("settingSkkbNumber").value,logoLeftSize:document.getElementById("settingLogoLeftSize").value,logoRightSize:document.getElementById("settingLogoRightSize").value,sklPhotoLayout:document.getElementById("settingSklPhotoLayout").value,logoLeftPosTop:document.getElementById("settingLogoLeftPosTop").value,logoLeftPosLeft:document.getElementById("settingLogoLeftPosLeft").value,logoRightPosTop:document.getElementById("settingLogoRightPosTop").value,logoRightPosRight:document.getElementById("settingLogoRightPosRight").value,subjectVisibility:{}};document.querySelectorAll('#subjectSelectionContainer input[type="checkbox"]').forEach(e=>{t.subjectVisibility[e.dataset.subjectKey]=e.checked});const a={MULOK1:document.getElementById("settingMulok1Name").value,MULOK2:document.getElementById("settingMulok2Name").value,MULOK3:document.getElementById("settingMulok3Name").value},n=await fetchWithAuth(apiUrl("/api/data/settings/save"),{method:"POST",body:JSON.stringify({schoolCode:e,settingsData:t,mulokNamesData:a})});if(!n.success)throw new Error(n.message);database.settings[e]={...database.settings[e],...t},database.nilai._mulokNames||(database.nilai._mulokNames={}),database.nilai._mulokNames[e]=a,updateLogoPreviewUI(),showNotification(n.message,"success")}catch(e){showNotification(e.message||"Gagal menyimpan pengaturan.","error")}finally{hideLoader()}}async function handleSklPhotoUpload(e,t){const a=e.target.files[0];if(!a)return;if(!["image/jpeg","image/jpg","image/png","image/gif"].includes(a.type))return showNotification("Hanya file gambar yang diizinkan! (JPG, PNG, GIF)","error"),void(e.target.value="");if(a.size>2097152)return showNotification(`Ukuran file terlalu besar! Maksimal 2MB. (File Anda: ${(a.size/1024/1024).toFixed(1)}MB)`,"error"),void(e.target.value="");showNotification(`Mengunggah foto untuk siswa NISN: ${t}...`,"info",2e3);const n=new FileReader;n.onload=async a=>{const n=a.target.result;try{showLoader();const e=await fetchWithAuth(apiUrl("/api/data/skl-photo/save"),{method:"POST",body:JSON.stringify({nisn:t,photoData:n})});if(!e.success)throw new Error(e.message);database.sklPhotos||(database.sklPhotos={}),database.sklPhotos[t]=n,showNotification(`✅ Foto berhasil diunggah untuk siswa NISN: ${t}`,"success"),rerenderActiveTable("sekolahSiswa")}catch(e){showNotification(`❌ Gagal mengunggah foto: ${e.message||"Terjadi kesalahan server"}`,"error")}finally{hideLoader(),e.target.value=""}},n.onerror=()=>{showNotification("❌ Gagal membaca file gambar","error"),e.target.value=""},n.readAsDataURL(a)}async function deleteSklPhoto(e){try{showLoader();const t=await fetchWithAuth(apiUrl("/api/data/skl-photo/delete"),{method:"POST",body:JSON.stringify({nisn:e})});if(!t.success)throw new Error(t.message);database.sklPhotos?.[e]&&delete database.sklPhotos[e],showNotification("Foto berhasil dihapus.","success"),rerenderActiveTable("sekolahSiswa")}catch(e){showNotification(e.message||"Gagal menghapus foto dari server.","error")}finally{hideLoader()}}async function handleLogoUpload(e,t,a){const n=e.target.files[0];if(!n)return;if(!window.currentUser?.schoolData)return showNotification("❌ Anda harus login sebagai sekolah untuk mengunggah logo","error"),void(e.target.value="");const o=window.currentUser.schoolData[0];if(!("pro"===window.currentUser.loginType||o&&"true"===localStorage.getItem(`kodeProActivated:${o}`)))return showNotification("⚡ Fitur kustomisasi logo hanya tersedia untuk user PRO. Silakan upgrade ke PRO terlebih dahulu.","warning"),void(e.target.value="");if(!["image/jpeg","image/jpg","image/png","image/gif"].includes(n.type))return showNotification("❌ Hanya file gambar yang diizinkan! (JPG, PNG, GIF)","error"),void(e.target.value="");if(n.size>1048576)return showNotification(`❌ Ukuran file terlalu besar! Maksimal 1MB untuk logo. (File Anda: ${(n.size/1024/1024).toFixed(1)}MB)`,"error"),void(e.target.value="");const i="logoLeft"===t?"Logo Kiri (Kabupaten)":"Logo Kanan (Tut Wuri)";showNotification(`📤 Mengunggah ${i}...`,"info",2e3);const s=new FileReader;s.onload=async n=>{try{showLoader();const e=String(window.currentUser.schoolData[0]),o=n.target.result;document.getElementById(a).src=o;const s={};s[t]=o;const r=await fetchWithAuth(apiUrl("/api/data/settings/save"),{method:"POST",body:JSON.stringify({schoolCode:e,settingsData:s})});if(!r.success)throw new Error(r.message);database.settings[e]||(database.settings[e]={}),database.settings[e][t]=o,updateLogoPreviewUI(),showNotification(`✅ ${i} berhasil diunggah dan disimpan!`,"success")}catch(e){showNotification(`❌ Gagal mengunggah ${i}: ${e.message||"Terjadi kesalahan server"}`,"error");const n=database.settings[window.currentUser.schoolData[0]]&&database.settings[window.currentUser.schoolData[0]][t];document.getElementById(a).src=n||"https://placehold.co/80x80/f0f0f0/ccc?text=Logo"}finally{hideLoader(),e.target.value=""}},s.onerror=()=>{showNotification(`❌ Gagal membaca file ${i}`,"error"),e.target.value=""},s.readAsDataURL(n)}async function deleteAllGradesForSemester(){const{currentSemester:e,currentSemesterName:t}=paginationState.isiNilai;if(e)try{showLoader();const a=String(window.currentUser.schoolData[0]),n=await fetchWithAuth(apiUrl("/api/data/grades/delete-by-semester"),{method:"POST",body:JSON.stringify({schoolCode:a,semesterId:e})});if(!n.success)throw new Error(n.message);await fetchDataFromServer(),renderIsiNilaiPage(e,t),showNotification(n.message,"success")}catch(e){showNotification(e.message||"Gagal menghapus data nilai.","error")}finally{hideLoader()}else showNotification("Pilih semester terlebih dahulu.","warning")}function renderCetakGabunganPage(){const e=document.getElementById("cetakGabunganProMessage"),t=document.getElementById("cetakGabunganTableContainer"),a=document.querySelector('.pagination-controls[data-table-id="cetakGabungan"]'),n=document.getElementById("searchCetakGabungan");if("pro"!==window.currentUser.loginType)return e.style.display="block",t.style.display="none",a.style.display="none",void(n.style.display="none");e.style.display="none",t.style.display="block",a.style.display="flex",n.style.display="block",renderGenericSiswaTable("cetakGabungan","","downloadGabunganPDF")}async function downloadGabunganPDF(e){if(!checkNilaiLengkap(e))return;const{jsPDF:t}=window.jspdf,a=document.getElementById("pdf-content"),n=database.siswa.find(t=>t[6]===e),o=window.currentUser.schoolData;if(n&&o){showLoader(),showNotification("Membuat PDF Gabungan.","success");try{const i=new t({orientation:"portrait",unit:"mm",format:[210,330]}),s=i.internal.pageSize.getWidth(),r=i.internal.pageSize.getHeight(),l=[{type:"Transkrip",html:createTranskripHTML(e)},{type:"SKL",html:createSklHTML(e)},{type:"SKKB",html:createSkkbHTML(e)}];for(let e=0;e<l.length;e++){const t=l[e];a.innerHTML=t.html,setTimeout(()=>updateLogoPreviewUI(),100),await waitForImages(a);const n=(await html2canvas(a,{scale:3,useCORS:!0,backgroundColor:"#ffffff",imageTimeout:15e3})).toDataURL("image/png");e>0&&i.addPage(),i.addImage(n,"PNG",0,0,s,r)}const d=(o[5]||"sekolah").replace(/ /g,"_"),c=`Laporan_Gabungan_${d}_${(n[7]||"siswa").replace(/ /g,"_")}.pdf`;i.save(c)}catch(e){console.error("Error creating combined PDF:",e),showNotification("Gagal membuat file PDF gabungan.","error")}finally{a.innerHTML="",hideLoader()}}else showNotification("Data siswa atau sekolah tidak ditemukan.","error")}async function handleBackup(){if("sekolah"===window.currentUser.role&&window.currentUser.schoolData){showBackupProgress();try{updateBackupProgress(10,"Mempersiapkan data...");const e=String(window.currentUser.schoolData[0]),t=(window.currentUser.schoolData[5]||"sekolah").replace(/ /g,"_");updateBackupProgress(20,"Mengumpulkan data sekolah...");const a={appVersion:"2.6-server",backupDate:(new Date).toISOString(),schoolCode:e,schoolName:window.currentUser.schoolData[4],siswa:database.siswa.filter(t=>String(t[0])===e),nilai:{},settings:database.settings[e]||{},sklPhotos:{},mulokNames:database.nilai._mulokNames&&database.nilai._mulokNames[e]||{}};updateBackupProgress(40,"Mengumpulkan data siswa...");const n=new Set(a.siswa.map(e=>e[7]));let o=0;const i=n.size;updateBackupProgress(50,"Mengumpulkan data nilai dan foto...");for(const e of n)if(database.nilai[e]&&(a.nilai[e]=database.nilai[e]),database.sklPhotos[e]&&(a.sklPhotos[e]=database.sklPhotos[e]),o++,o%50==0||o===i){updateBackupProgress(50+Math.floor(o/i*30),`Memproses data siswa ${o}/${i}...`),await new Promise(e=>setTimeout(e,1))}if(updateBackupProgress(85,"Membuat file backup..."),0===a.siswa.length)throw new Error("Tidak ada data siswa untuk di-backup.");let s,r;await new Promise(e=>setTimeout(e,100));try{s=JSON.stringify(a,null,2)}catch(e){throw console.error("JSON stringify error:",e),new Error("Gagal mengkonversi data ke JSON. Data mungkin terlalu besar atau memiliki referensi circular.")}try{r=new Blob([s],{type:"application/json"})}catch(e){throw console.error("Blob creation error:",e),new Error("Gagal membuat file backup. Ukuran data mungkin terlalu besar.")}updateBackupProgress(95,"Menyiapkan unduhan...");const l=(new Date).toISOString().slice(0,10),d=(new Date).toTimeString().slice(0,5).replace(":","-"),c=`backup_${t}_${l}_${d}.json`;try{if(window.URL&&window.URL.createObjectURL){const e=URL.createObjectURL(r),t=document.createElement("a");t.href=e,t.download=c,t.style.display="none",document.body.appendChild(t),t.click(),document.body.removeChild(t),URL.revokeObjectURL(e)}else if(window.navigator&&window.navigator.msSaveOrOpenBlob)window.navigator.msSaveOrOpenBlob(r,c);else{const e=new FileReader;e.onload=function(){const t=document.createElement("a");t.href=e.result,t.download=c,t.click()},e.readAsDataURL(r)}}catch(e){throw console.error("Download error:",e),new Error("Gagal mengunduh file backup. Browser Anda mungkin tidak mendukung download otomatis.")}updateBackupProgress(100,"Backup selesai!"),setTimeout(()=>{hideBackupProgress(),showNotification(`Backup berhasil! File: backup_${t}_${l}_${d}.json`,"success")},1e3)}catch(e){console.error("Backup failed:",e),hideBackupProgress(),showNotification(e.message||"Terjadi kesalahan saat membuat backup.","error")}}}function showBackupProgress(){const e=document.createElement("div");e.id="backupProgressModal",e.className="progress-modal",e.innerHTML='\n        <div class="progress-modal-content">\n            <h3>Membuat Backup Data</h3>\n            <div class="progress-container">\n                <div class="progress-bar">\n                    <div class="progress-fill" id="backupProgressFill"></div>\n                </div>\n                <div class="progress-text" id="backupProgressText">0%</div>\n            </div>\n            <div class="progress-status" id="backupProgressStatus">Memulai backup...</div>\n        </div>\n    ',document.body.appendChild(e)}function updateBackupProgress(e,t){const a=document.getElementById("backupProgressFill"),n=document.getElementById("backupProgressText"),o=document.getElementById("backupProgressStatus");a&&(a.style.width=e+"%"),n&&(n.textContent=e+"%"),o&&(o.textContent=t)}function showRestoreProgress(){const e=document.createElement("div");e.id="restoreProgressModal",e.className="progress-modal",e.innerHTML='\n        <div class="progress-modal-content">\n            <h3>Memulihkan Data Backup</h3>\n            <div class="progress-container">\n                <div class="progress-bar">\n                    <div class="progress-fill" id="restoreProgressFill"></div>\n                </div>\n                <div class="progress-text" id="restoreProgressText">0%</div>\n            </div>\n            <div class="progress-status" id="restoreProgressStatus">Memulai restore...</div>\n        </div>\n    ',document.body.appendChild(e)}function updateRestoreProgress(e,t){const a=document.getElementById("restoreProgressFill"),n=document.getElementById("restoreProgressText"),o=document.getElementById("restoreProgressStatus");a&&(a.style.width=e+"%"),n&&(n.textContent=e+"%"),o&&(o.textContent=t)}async function handleRestore(e){const t=e.target.files[0];if(!t)return;if(document.getElementById("restoreProgressModal"))return;showRestoreProgress();const a=new FileReader;a.onload=async t=>{try{updateRestoreProgress(10,"Membaca file backup...");const a=JSON.parse(t.target.result);updateRestoreProgress(20,"Memvalidasi file backup...");const n=validateBackupData(a);if(!n.isValid)throw new Error(n.message);updateRestoreProgress(30,"File backup valid, mengirim ke server...");const o=`\nFile Backup Info:\n- Sekolah: ${a.schoolName||"Tidak diketahui"}\n- Tanggal: ${new Date(a.backupDate).toLocaleDateString("id-ID")}\n- Jumlah Siswa: ${a.siswa?.length||0}\n- App Version: ${a.appVersion||"Tidak diketahui"}\n\nApakah Anda yakin ingin melakukan restore? Data saat ini akan diganti!\n            `;if(updateRestoreProgress(40,"Menunggu konfirmasi..."),!confirm(o.trim()))return hideRestoreProgress(),void(e.target.value="");let i;updateRestoreProgress(50,"Mengirim data ke server...");try{i=await fetchWithAuth("/api/data/restore",{method:"POST",body:JSON.stringify(a)})}catch(e){throw console.error("Network error:",e),e.message.includes("Failed to fetch")?new Error("Tidak dapat terhubung ke server. Pastikan server sedang berjalan dan Anda terhubung ke internet."):new Error(`Gagal mengirim data ke server: ${e.message}`)}if(updateRestoreProgress(80,"Memproses di server..."),!i||!i.success)throw new Error(i?.message||"Server mengembalikan response yang tidak valid");{updateRestoreProgress(100,"Restore berhasil!"),await new Promise(e=>setTimeout(e,1e3)),updateRestoreProgress(100,"Memuat ulang data...");let e=!1;for(let t=1;t<=3;t++){await fetchDataFromServer();if(Object.keys(database.nilai||{}).filter(e=>"_mulokNames"!==e).length>0){e=!0;break}t<3&&await new Promise(e=>setTimeout(e,1e3))}setTimeout(()=>{hideRestoreProgress(),e?showNotification("Data berhasil direstore! Halaman akan dimuat ulang untuk menerapkan perubahan.","success"):showNotification("Data berhasil direstore, namun mungkin perlu refresh manual untuk menampilkan semua data.","warning"),setTimeout(()=>{location.reload()},2e3)},500)}}catch(e){console.error("Restore failed:",e),hideRestoreProgress(),showNotification(e.message||"Gagal memproses file backup!","error")}finally{e.target.value=""}},a.readAsText(t)}function validateBackupData(e){if(!e)return{isValid:!1,message:"File backup kosong atau tidak valid."};if(!e.schoolCode)return{isValid:!1,message:"File backup tidak berisi kode sekolah."};if(!e.appVersion)return{isValid:!1,message:"File backup tidak memiliki informasi versi aplikasi."};if(!e.backupDate)return{isValid:!1,message:"File backup tidak memiliki tanggal backup."};const t=["siswa","nilai","settings"];for(const a of t)if(void 0===e[a])return{isValid:!1,message:`Field '${a}' tidak ditemukan dalam backup.`};if(!Array.isArray(e.siswa))return{isValid:!1,message:"Data siswa harus berupa array."};if("object"!=typeof e.nilai)return{isValid:!1,message:"Data nilai harus berupa object."};if("object"!=typeof e.settings)return{isValid:!1,message:"Data settings harus berupa object."};const a=new Date(e.backupDate),n=new Date,o=Math.floor((n-a)/864e5);return o>365?{isValid:!1,message:`Backup terlalu lama (${o} hari). Gunakan backup yang lebih baru.`}:{isValid:!0,message:"File backup valid."}}function calculateStudentRanking(){if(!window.currentUser||!database.siswa)return[];if(!database.nilai)return[];const e=window.currentUser.schoolData[0],t=database.siswa.filter(t=>t[0]===e);if(0===t.length)return[];const a={K13:[{key:"AGAMA",display:"Pendidikan Agama dan Budi Pekerti"},{key:"PKN",display:"Pendidikan Pancasila dan Kewarganegaraan"},{key:"B.INDO",display:"Bahasa Indonesia"},{key:"MTK",display:"Matematika"},{key:"IPA",display:"Ilmu Pengetahuan Alam"},{key:"IPS",display:"Ilmu Pengetahuan Sosial"},{key:"B.ING",display:"Bahasa Inggris"},{key:"SBDP",display:"Seni Budaya dan Prakarya"},{key:"PJOK",display:"Pendidikan Jasmani, Olahraga, dan Kesehatan"}],MERDEKA:[{key:"AGAMA",display:"Pendidikan Agama dan Budi Pekerti"},{key:"PKN",display:"Pendidikan Pancasila"},{key:"B.INDO",display:"Bahasa Indonesia"},{key:"MTK",display:"Matematika"},{key:"IPAS",display:"Ilmu Pengetahuan Alam dan Sosial"},{key:"B.ING",display:"Bahasa Inggris"},{key:"SBDP",display:"Seni Budaya dan Prakarya"},{key:"PJOK",display:"Pendidikan Jasmani, Olahraga, dan Kesehatan"}]},n=a[window.currentUser.kurikulum]||a.MERDEKA;return t.map(e=>{const t=e[6],a=e[8];let o=0,i=0;n.forEach(e=>{const a=calculateAverageForSubject(t,e.key);null!==a&&!isNaN(a)&&a>=0&&(o+=a,i++)});const s=i>0?o/i:0;return{nisn:t,nama:a,noUrut:e[4],average:s}}).filter(e=>e.nama&&""!==e.nama.trim()).sort((e,t)=>t.average-e.average).slice(0,10)}function updateRankingWidget(){const e=document.getElementById("rankingContainer");if(!e)return;const t=calculateStudentRanking();if(0===t.length)return void(e.innerHTML='<div class="ranking-empty">Belum ada data nilai untuk menampilkan ranking</div>');let a="";t.forEach((e,t)=>{const n=t+1,o=1===n?"rank-1":2===n?"rank-2":3===n?"rank-3":"rank-other";a+=`\n            <div class="ranking-item ${n<=3?`top-3 ${o}`:""}">\n                <div class="ranking-number ${o}">${n}</div>\n                <div class="ranking-info">\n                    <div class="ranking-name">${e.nama}</div>\n                    <div class="ranking-average">${e.average.toFixed(2)}</div>\n                </div>\n            </div>\n        `}),e.innerHTML=a}function _getCurrentSchoolKode(){return String(window.currentUser&&window.currentUser.schoolData&&window.currentUser.schoolData[0]||"")}function _getMulokNamesForSchool(){const e=_getCurrentSchoolKode();return database.nilai&&database.nilai._mulokNames&&database.nilai._mulokNames[e]||{}}function _normalizeHeader(e){return String(e||"").toLowerCase().replace(/\s+/g," ").replace(/[().]/g,"").trim()}function _subjectDisplayForTemplate(e){const t=_getMulokNamesForSchool();return e.startsWith("MULOK")&&t[e]&&t[e].trim()?t[e]:e}function _mapHeadersToKeys(e,t){const a=e.map(_normalizeHeader),n=a.findIndex(e=>"nisn"===e),o=a.findIndex(e=>"nama"===e||"nama peserta"===e||"nama siswa"===e),i=new Map(a.map((e,t)=>[e,t])),s={},r=(e,t,a)=>{const n=i.get(e);void 0!==n&&n>=0&&(s[n]={subject:t,type:a})},l={agama:"AGAMA",pai:"AGAMA",pabp:"AGAMA",ppkn:"PKN",pkn:"PKN","bahasa indonesia":"B.INDO",bindo:"B.INDO","b indo":"B.INDO",matematika:"MTK",mtk:"MTK",mat:"MTK",ipas:"IPAS",ipa:"IPAS",ips:"IPAS","bahasa inggris":"B.ING",bing:"B.ING","b inggris":"B.ING",sbdp:"SBDP",sbkp:"SBDP",sbk:"SBDP",pjok:"PJOK",penjas:"PJOK",penjaskes:"PJOK"},d=_getMulokNamesForSchool(),c=["MULOK1","MULOK2","MULOK3"],u=c.map(e=>{const t=[_normalizeHeader(d[e]||""),_normalizeHeader(e),_normalizeHeader(e.replace("MULOK","Muatan Lokal "))].filter(Boolean);return Array.from(new Set(t))});if("K13"===t)(subjects&&subjects.K13?subjects.K13:[]).forEach(e=>{const t=_normalizeHeader(_subjectDisplayForTemplate(e)),a=_normalizeHeader(e);Array.from(new Set([t,a,...Object.keys(l).filter(t=>l[t]===e)])).forEach(t=>{r(`${t} ki3`,e,"KI3"),r(`${t} ki4`,e,"KI4")})}),u.forEach((e,t)=>{e.forEach(e=>{r(`${e} ki3`,`MULOK${t+1}`,"KI3"),r(`${e} ki4`,`MULOK${t+1}`,"KI4")})});else{(subjects&&subjects.Merdeka?subjects.Merdeka:[]).forEach(e=>{const t=_normalizeHeader(_subjectDisplayForTemplate(e)),a=_normalizeHeader(e);Array.from(new Set([t,a,...Object.keys(l).filter(t=>l[t]===e)])).forEach(t=>r(t,e,"NILAI"))}),u.forEach((e,t)=>{e.forEach(e=>r(e,`MULOK${t+1}`,"NILAI"))});const e=new Set(Object.keys(s).map(e=>parseInt(e,10))),t=c.filter(e=>!Object.values(s).some(t=>t.subject===e));if(t.length)for(let i=0;i<a.length;i++){if(i===n||i===o||e.has(i))continue;const r=a[i];if(!r||"-"===r||"nil"===r)continue;const l=t.shift();if(!l)break;s[i]={subject:l,type:"NILAI"}}}return{map:s,idxNISN:n,idxNama:o}}async function handleUploadExcelChange(e){const t=e.target.files?.[0];if(t){showLoader();try{const e=_getCurrentSchoolKode();database.nilai&&database.nilai._mulokNames&&database.nilai._mulokNames[e]||await fetchDataFromServer();const a=await t.arrayBuffer(),n=XLSX.read(a,{type:"array"}),o=n.Sheets[n.SheetNames[0]],i=XLSX.utils.sheet_to_json(o,{header:1,blankrows:!1});if(i.length<2)throw new Error("Sheet kosong atau hanya header.");const s=i[0],r=i.slice(1),l=window.currentUser?.kurikulum||"Merdeka",{map:d,idxNISN:c}=_mapHeadersToKeys(s,l);if(c<0)throw new Error("Kolom NISN tidak ditemukan di header.");const u=paginationState?.isiNilai?.currentSemester,g=[];for(const e of r){const t=String(e[c]??"").trim();if(t)for(const a of Object.keys(d)){const n=+a,{subject:o,type:i}=d[n];let s=e[n];if(null==s||""===String(s).trim())continue;let r=String(s).replace(",",".").trim();const l=Number(r);r=Number.isFinite(l)?l:r,g.push({nisn:t,semester:u,subject:o,type:i,value:r})}}if(!g.length)throw new Error("Tidak ada nilai yang terbaca dari file.");let m;const p=2;let h;for(let e=1;e<=p;e++)try{m=await fetchWithAuth(apiUrl("/api/data/grades/save-bulk"),{method:"POST",body:JSON.stringify(g)});break}catch(t){h=t,e<p&&await new Promise(e=>setTimeout(e,1e3))}if(!m&&h)throw new Error(`Gagal menyimpan nilai setelah ${p} percobaan: ${h.message}`);if(!m||!1===m.success)throw new Error(m?.message||"Gagal menyimpan nilai (server).");await fetchDataFromServer(),await refreshIsiNilaiViewAfterSave(),showNotification(m.message||"Berhasil menyimpan nilai.","success")}catch(e){console.error("Error processing Excel for grades:",e),showNotification(e.message||"Gagal memproses file Excel.","error")}finally{hideLoader(),e.target.value=""}}}async function saveIjazahNumber(e){const t=parseInt(e.dataset.index),a=e.value.trim(),n=database.siswa[t];if(!n)return;const o=String(n[6]);if(e.classList.remove("invalid-input"),""!==a&&!/^\d{15}$/.test(a)){return showSmartNotification("Nomor Ijazah harus tepat 15 digit dan hanya berisi angka.","error","validasi no ijazah"),e.classList.add("invalid-input"),e.value=n[10]||"",void setTimeout(()=>e.classList.remove("invalid-input"),2500)}if(""!==a&&checkDuplicateIjazah(a,t)){return showSmartNotification("Nomor Ijazah sudah digunakan oleh siswa lain. Harap masukkan nomor yang unik.","error","validasi no ijazah"),e.classList.add("invalid-input"),e.value=n[10]||"",void setTimeout(()=>e.classList.remove("invalid-input"),2500)}const i=n[10];n[10]=a;try{const e=await fetchWithAuth(apiUrl("/api/data/siswa/update"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({nisn:o,updatedData:{noIjazah:a}})});if(!e.success)throw new Error(e.message);showSmartNotification("Nomor Ijazah berhasil disimpan!","success","simpan no ijazah")}catch(e){n[10]=i,showSmartNotification(e.message||"Gagal menyimpan No. Ijazah ke server.","error","simpan no ijazah")}}document.addEventListener("DOMContentLoaded",()=>{const e=document.getElementById("kecamatanGrid");e&&e.addEventListener("click",e=>{const t=e.target.closest(".kecamatan-card");if(t){const e=t.dataset.kecamatan;e&&openSekolahKecamatanModal(e)}})}),document.addEventListener("DOMContentLoaded",()=>{const e=localStorage.getItem("currentUserSession");if(e){if(window.currentUser=JSON.parse(e),window.currentUser.token||(window.currentUser.token=localStorage.getItem("jwtToken")),window.currentUser.token&&localStorage.setItem("currentUserSession",JSON.stringify(window.currentUser)),window.currentUser?.schoolData?.[0]?migrateLegacyProFlag(window.currentUser.schoolData[0],window.currentUser.schoolData?.[1]):migrateLegacyProFlag(null,null),"sekolah"===window.currentUser?.role){const e=window.currentUser.schoolData?.[0],t=window.currentUser.schoolData?.[1],a=e&&t&&"true"===localStorage.getItem(`kodeProActivated:${e}`),n=e&&localStorage.getItem(`kodeProValue:${e}`);a&&n&&((e,t)=>(e||"").toString().trim().toUpperCase()===(t||"").toString().trim().toUpperCase())(n,t)&&(window.currentUser.loginType="pro",localStorage.setItem("currentUserSession",JSON.stringify(window.currentUser)))}window.currentUser.isLoggedIn&&window.currentUser.token&&fetchDataFromServer(!0).then(()=>{showDashboard(window.currentUser.role)}).catch(e=>{localStorage.removeItem("currentUserSession"),localStorage.removeItem("jwtToken"),window.currentUser=null})}setupSettingTabs();try{const e=document.querySelector(".brand-logo");e&&(e.textContent="EI"),document.querySelectorAll(".brand-points li").forEach(e=>{e.textContent=(e.textContent||"").replace(/^[^A-Za-z0-9]+\s*/,"")});const t=document.querySelector(".input-icon");t&&(t.textContent="🔑");const a=document.querySelector(".stat-card-small.total-siswa .icon");a&&(a.textContent="👥");const n=document.querySelector(".stat-card-small.kurikulum-info .icon");n&&(n.textContent="📘");const o=document.querySelector("#aktivasiSuccess .success-icon");o&&(o.textContent="✓");const i=document.getElementById("kodeProInput");i&&(i.placeholder="Masukkan Kode Pro (8 digit)")}catch(e){}const t=document.getElementById("btnTambahSekolah");t&&t.addEventListener("click",()=>{openSekolahModal("add")});const a=document.getElementById("adminDashboard");a&&a.addEventListener("click",e=>{if(e.target.matches(".btn-edit-sekolah")){const t=e.target.dataset.kode,a=database.sekolah.find(e=>e[0]===t);a&&openSekolahModal("edit",a)}if(e.target.matches(".btn-delete-sekolah")){handleDeleteSekolah(e.target.dataset.kode)}if(e.target.matches(".btn-edit-siswa")){const t=e.target.dataset.nisn,a=database.siswa.find(e=>e[6]===t);a&&openSiswaAdminModal("edit",a)}if(e.target.matches(".btn-delete-siswa")){handleDeleteSiswa(e.target.dataset.nisn,e.target.dataset.nama)}});const n=document.getElementById("sekolahForm");n&&n.addEventListener("submit",e=>{handleSekolahFormSubmit(e)});const o=document.getElementById("closeSekolahModalBtn");o&&o.addEventListener("click",()=>{closeSekolahModal()});const i=document.getElementById("sekolahModal");i&&i.addEventListener("click",e=>{e.target===i&&closeSekolahModal()}),document.getElementById("loginForm").addEventListener("submit",handleLogin),document.getElementById("cancelBtn").addEventListener("click",()=>{appCodeInput.value=""}),document.querySelectorAll("#adminDashboard .sidebar-menu .menu-item").forEach(e=>{e.addEventListener("click",t=>{e.getAttribute("href")&&"#"!==e.getAttribute("href")&&!e.dataset.target||(t.preventDefault(),e.dataset.target&&switchContent(e.dataset.target))})}),document.querySelectorAll("#sekolahDashboard .sidebar-menu .menu-item").forEach(e=>{e.addEventListener("click",t=>{if(t.preventDefault(),e.classList.contains("has-submenu")){e.classList.toggle("open");const t=document.getElementById(e.dataset.target);t&&t.classList.toggle("open")}else switchSekolahContent(e.dataset.target)})}),document.querySelectorAll(".submenu-item").forEach(e=>{e.addEventListener("click",t=>{t.preventDefault(),document.querySelectorAll(".menu-item, .submenu-item").forEach(e=>{e.classList.remove("active")}),e.classList.add("active");const a=e.closest("ul.submenu").closest("li"),n=a?.querySelector(".has-submenu");if(n){n.classList.add("open");const e=document.getElementById(n.dataset.target);e&&e.classList.add("open")}paginationState.isiNilai.currentPage=1,renderIsiNilaiPage(e.dataset.semester,e.dataset.semesterName)})}),document.querySelectorAll(".btn-import[data-target-input]").forEach(e=>{e.addEventListener("click",()=>{document.getElementById(e.dataset.targetInput).click()})}),document.getElementById("importSekolahInput").addEventListener("change",e=>handleFile(e,"sekolah")),document.getElementById("importSiswaInput").addEventListener("change",e=>handleFile(e,"siswa")),document.querySelectorAll(".btn-delete[data-table-id]").forEach(e=>{e.addEventListener("click",()=>{deleteAllData(e.dataset.tableId)})}),document.querySelectorAll(".search-bar").forEach(e=>{e.addEventListener("input",e=>{const t=e.target.dataset.tableId;Object.prototype.hasOwnProperty.call(searchState,t)&&Object.prototype.hasOwnProperty.call(paginationState,t)&&debouncedSearch(t,e.target.value,300)})}),document.addEventListener("click",e=>{if(e.target.closest("#btnDownloadTemplate")){e.preventDefault();try{downloadIsiNilaiTemplate()}catch(e){console.error("Download template error:",e),showNotification("Error saat download template.","error")}return}if(e.target.closest("#btnUploadNilai")){e.preventDefault();const t=document.getElementById("uploadExcelInput");return void(t&&t.click())}}),document.addEventListener("change",e=>{e.target&&"uploadExcelInput"===e.target.id&&handleUploadExcelChange(e)}),document.getElementById("settingsForm").addEventListener("submit",saveSettings),document.getElementById("settingLogoLeftPosTop").addEventListener("input",e=>{document.getElementById("logoLeftPosTopLabel").textContent=e.target.value}),document.getElementById("settingLogoLeftPosLeft").addEventListener("input",e=>{document.getElementById("logoLeftPosLeftLabel").textContent=e.target.value}),document.getElementById("settingLogoRightPosTop").addEventListener("input",e=>{document.getElementById("logoRightPosTopLabel").textContent=e.target.value}),document.getElementById("settingLogoRightPosRight").addEventListener("input",e=>{document.getElementById("logoRightPosRightLabel").textContent=e.target.value}),document.getElementById("settingSklPhotoLayout").addEventListener("input",e=>{document.getElementById("sklPhotoLayoutLabel").textContent=e.target.value}),document.getElementById("deleteAllGradesBtn").addEventListener("click",deleteAllGradesForSemester),document.getElementById("backupBtn").addEventListener("click",handleBackup),document.getElementById("restoreBtn").addEventListener("click",()=>document.getElementById("restoreInput").click()),document.getElementById("restoreInput").addEventListener("change",handleRestore)}),window.editSekolah=function(e){const t=document.querySelector(`.btn-edit-sekolah[data-kode="${e}"]`);if(t)t.click();else{const t=database.sekolah.find(t=>t[0]===e);t&&openSekolahModal("edit",t)}},window.deleteSekolah=function(e){const t=document.querySelector(`.btn-delete-sekolah[data-kode="${e}"]`);t?t.click():handleDeleteSekolah(e)},editSiswaForm.addEventListener("submit",saveSiswaChanges),window.addEventListener("click",e=>{e.target==editModal&&closeEditModal(),e.target==transkripModal&&closeTranskripModal(),e.target==sklModal&&closeSklModal(),e.target==skkbModal&&closeSkkbModal(),e.target==loginInfoModal&&closeLoginInfoModal()}),populateKecamatanFilter();let rekapNilaiAdminState={filteredSiswa:[],selectedSchool:null,selectedKurikulum:null};function renderRekapNilaiAdminPage(){const e=document.querySelector("#rekapNilaiAdmin table thead tr");if(!e)return;const t=document.getElementById("rekapNilaiTableBody");t&&(t.innerHTML="");const a=document.getElementById("filterKurikulum")?.value||"Merdeka",n=(transcriptSubjects[a]||[]).map(e=>`<th>${e.display}</th>`).join("");e.innerHTML=`\n        <th>No</th>\n        <th>NISN</th>\n        <th>Nama Siswa</th>\n        <th>Asal Sekolah</th>\n        ${n}\n        <th>Rata-rata</th>\n    `,initRekapFilters();const o="rekapNilaiAdmin",i=document.querySelector(`.pagination-controls[data-table-id="${o}"]`);if(i&&!i.dataset.listenerAttached){const e=i.querySelector(".prev-page");e&&e.addEventListener("click",()=>{paginationState[o]&&paginationState[o].currentPage>1&&(paginationState[o].currentPage--,renderAdminRekapTable())});const t=i.querySelector(".next-page");t&&t.addEventListener("click",()=>{const e=paginationState[o];if(!e)return;const t=rekapNilaiAdminState.filteredSiswa;if(!t)return;const a="all"===e.rowsPerPage?t.length:parseInt(e.rowsPerPage),n=a>0?Math.ceil(t.length/a):1;e.currentPage<n&&(e.currentPage++,renderAdminRekapTable())});const a=i.querySelector(".rows-per-page");a&&a.addEventListener("change",e=>{paginationState[o]&&(paginationState[o].rowsPerPage=e.target.value,paginationState[o].currentPage=1,renderAdminRekapTable())}),i.dataset.listenerAttached="true"}}function populateRekapNilaiFilters(){const e=document.getElementById("filterKecamatan");e.innerHTML='<option value="">Semua Kecamatan</option>';document.getElementById("filterSekolah").innerHTML='<option value="">Semua Sekolah</option>';[...new Set(database.sekolah.map(e=>e[2]))].forEach(t=>{e.innerHTML+=`<option value="${t}">${t}</option>`});e.value&&populateSekolahFilter()}function filterAndRenderRekapNilaiAdminTable(){document.getElementById("filterKurikulum").value;const e=document.getElementById("adminFilterKecamatan").value,t=document.getElementById("filterSekolah").value,a=document.getElementById("downloadRekapPdfBtn");let n=database.siswa;e&&(n=n.filter(t=>t[3]===e)),t&&(n=n.filter(e=>e[0]===t)),rekapNilaiAdminState.filteredSiswa=n,rekapNilaiAdminState.selectedSchool=t?database.sekolah.find(e=>e[0]===t):null,a.disabled=0===n.length,renderAdminRekapTable()}function renderAdminRekapTable(){const e=document.querySelector("#rekapNilaiAdmin table thead tr"),t=document.getElementById("rekapNilaiTableBody"),a=document.getElementById("filterKurikulum").value,n=rekapNilaiAdminState.filteredSiswa,o=paginationState.rekapNilaiAdmin,i="all"===o.rowsPerPage?n.length:parseInt(o.rowsPerPage),s=Math.ceil(n.length/i)||1;o.currentPage=Math.min(o.currentPage,s);const r=(o.currentPage-1)*i,l=r+i,d=n.slice(r,l);if(e&&(e.innerHTML=""),t.innerHTML="",0===d.length)return t.innerHTML='<tr><td colspan="20" style="text-align: center; padding: 20px;">Tidak ada data yang cocok dengan filter Anda.</td></tr>',void updatePaginationControls("rekapNilaiAdmin",0);const c=subjects[a||"Merdeka"],u=String(d[0][0]),g=database.nilai._mulokNames?.[u]||{};let m="<th>NO</th><th>NAMA SEKOLAH</th><th>NAMA SISWA</th><th>NISN</th>";c.forEach(e=>{const t=e.startsWith("MULOK")&&g[e]?g[e]:e;m+=`<th>${t}</th>`}),m+="<th>RATA-RATA</th>",e&&(e.innerHTML=m),d.forEach((e,a)=>{const n=e[6]||"",o=t.insertRow();let i=`\n            <td>${r+a+1}</td>\n            <td>${e[2]||"-"}</td>\n            <td>${e[7]||"-"}</td>\n            <td>${n}</td>\n        `,s=0,l=0;c.forEach(e=>{const t=calculateAverageForSubject(n,e),a=null!==t?t.toFixed(2):"-";i+=`<td style="text-align: center;">${a}</td>`,null===t||isNaN(t)||(s+=t,l++)});const d=l>0?(l>0?s/l:0).toFixed(2):"-";i+=`<td style="text-align: center; font-weight: bold;">${d}</td>`,o.innerHTML=i}),updatePaginationControls("rekapNilaiAdmin",n.length)}async function downloadRekapNilaiAdminPDF(){const e=rekapNilaiAdminState.selectedSchool;if(!e)return void showNotification("Pilih sekolah terlebih dahulu.","warning");showLoader();const{jsPDF:t}=window.jspdf,a=rekapNilaiAdminState.filteredSiswa;try{const n=new t({orientation:"landscape",unit:"mm",format:"a4"}),o=(e[4]||"SEKOLAH").toUpperCase(),i=a[0]?.kurikulum||"Merdeka",s=subjects[i]||[],r=database.nilai._mulokNames?.[e[0]]||{},l=[{header:"NO",dataKey:"no"},{header:"NAMA",dataKey:"nama"},{header:"NISN",dataKey:"nisn"}];s.forEach(e=>{const t=r&&r[e]||e;l.push({header:t,dataKey:e})}),l.push({header:"RATA-RATA",dataKey:"average"});const d=a.map((e,t)=>{const a={no:t+1,nama:e[7]||"",nisn:e[6]||""};let n=0,o=0;s.forEach(t=>{const i=calculateAverageForSubject(e[6],t);a[t]=null!==i?i.toFixed(2):"-",null===i||isNaN(i)||(n+=i,o++)});const i=o>0?n/o:0;return a.average=o>0?i.toFixed(2):"-",a}),c=(t,n)=>{t.setFontSize(16),t.setFont(void 0,"bold"),t.text("REKAP NILAI AKHIR SISWA",14,20),t.setFontSize(14),t.setFont(void 0,"bold"),t.text("TAHUN PELAJARAN 2024/2025",14,30),t.setFontSize(11),t.setFont(void 0,"normal");const s=49;t.text("Kecamatan",14,42),t.text("NPSN",14,48),t.text("Nama Sekolah",14,54),t.text("Jumlah Siswa",14,60),t.text("Kurikulum",14,66),t.text(":",s,42),t.text(":",s,48),t.text(":",s,54),t.text(":",s,60),t.text(":",s,66),t.text(e[2]||"-",54,42),t.text(e[3]||"-",54,48),t.text(o,54,54),t.text(`${a.length} orang`,54,60),t.text(i,54,66)};c(n,1),n.autoTable({startY:75,head:[l.map(e=>e.header)],body:d.map(e=>l.map(t=>e[t.dataKey])),styles:{fontSize:8,cellPadding:2},headStyles:{fillColor:[240,240,240],textColor:[0,0,0],lineWidth:.1,lineColor:[0,0,0]},bodyStyles:{lineWidth:.1,lineColor:[0,0,0]},didDrawPage:e=>{e.pageNumber>1&&(c(n,e.pageNumber),e.cursor.y=Math.max(e.cursor.y,75))},margin:{top:75},columnStyles:{0:{cellWidth:10},1:{cellWidth:50},2:{cellWidth:30},[l.length-1]:{cellWidth:20,halign:"center",fontStyle:"bold"}}});const u=`RekapNilai_${o.replace(/ /g,"_")}.pdf`;n.save(u),showNotification(`Rekap nilai berhasil diunduh: ${u}`,"success")}catch(e){console.error("Error creating Rekap Nilai PDF:",e),showNotification("Gagal membuat file PDF rekap nilai.","error")}finally{hideLoader()}}function createRekapNilaiHTML(e,t){const a=(e[4]||"NAMA SEKOLAH").toUpperCase(),n=t[0]?.kurikulum||"Merdeka",o=subjects[n],i=database.nilai._mulokNames?.[e[0]]||{};let s="<th>NO</th><th>NAMA</th><th>NISN</th>";o.forEach(e=>{const t=i&&i[e]||e;s+=`<th>${t}</th>`});let r="";return t.forEach((e,t)=>{const a=e[7]||"";let n=`<td>${t+1}</td><td>${e[8]||""}</td><td>${a}</td>`;o.forEach(e=>{const t=calculateAverageForSubject(a,e),o=null!==t?t.toFixed(2):"-";n+=`<td>${o}</td>`}),r+=`<tr>${n}</tr>`}),`\n        <div style="font-family: 'Times New Roman', Times, serif; font-size: 10pt;">\n            <h1 style="text-align: center; margin-bottom: 5px;">Rekap Nilai Akhir Siswa</h1>\n            <h2 style="text-align: center; margin-top: 0;">${a}</h2>\n            <p style="margin-top: 20px;"><strong>Kecamatan:</strong> ${e[2]}</p>\n            <p><strong>NPSN:</strong> ${e[3]}</p>\n            <p><strong>Kurikulum:</strong> ${n}</p>\n            <table style="width: 100%; border-collapse: collapse; margin-top: 15px;">\n                <thead><tr>${s}</tr></thead>\n                <tbody>${r}</tbody>\n            </table>\n        </div>\n    `}function getRekapNilaiData(){const e=document.getElementById("filterKecamatan").value,t=document.getElementById("filterSekolah").value;let a=database.siswa;if("Semua Kecamatan"!==e){const t=new Set(database.sekolah.filter(t=>t[2]===e).map(e=>e[0]));a=a.filter(e=>t.has(e[0]))}"Semua Sekolah"!==t&&(a=a.filter(e=>e[0]===t));return a.map(e=>{const t=e[6],a=e[8],n=(database.sekolah.find(t=>t[0]===e[0])||[])[4]||"N/A";let o=0,i=0;transcriptSubjects[window.currentUser.kurikulum||"Merdeka"].forEach(e=>{const a=calculateAverageForSubject(t,e.key);null!==a&&(o+=a,i++)});const s=i>0?(o/i).toFixed(2):"N/A";return[t,a,n,s]})}function capitalize(e){return"string"!=typeof e?"":e.charAt(0).toUpperCase()+e.slice(1)}function populateKecamatanFilter(){const e=document.getElementById("filterKecamatan");if(!e)return;const t=["Semua Kecamatan",...new Set(database.sekolah.map(e=>e[2]))];e.innerHTML="",t.forEach(t=>{const a=document.createElement("option");a.value=t,a.textContent=t,e.appendChild(a)}),populateSekolahFilter()}function populateSekolahFilter(){const e=document.getElementById("filterKecamatan").value,t=document.getElementById("filterSekolah");if(!t)return;t.innerHTML="";const a=document.createElement("option");if(a.value="Semua Sekolah",a.textContent="Semua Sekolah",t.appendChild(a),"Semua Kecamatan"!==e){database.sekolah.filter(t=>t[2]===e).forEach(e=>{const a=document.createElement("option");a.value=e[0],a.textContent=e[4],t.appendChild(a)})}}function getRekapNilaiLengkapData(){const e=document.getElementById("adminFilterKecamatan").value,t=document.getElementById("filterSekolah").value;let a=database.siswa;if("Semua Kecamatan"!==e&&""!==e){const t=new Set(database.sekolah.filter(t=>t[2]===e).map(e=>e[0]));a=a.filter(e=>t.has(e[0]))}"Semua Sekolah"!==t&&""!==t&&(a=a.filter(e=>e[0]===t));return a.map(e=>{const t=e[6],a=e[8],n=(database.sekolah.find(t=>t[0]===e[0])||[])[4]||"N/A";let o={},i=0,s=0;transcriptSubjects[window.currentUser.kurikulum||"Merdeka"].forEach(e=>{const a=calculateAverageForSubject(t,e.key);o[e.key]=null!==a?a.toFixed(2):"-",null!==a&&(i+=a,s++)});const r=s>0?(i/s).toFixed(2):"0";return{no:0,nisn:t,namaSiswa:a,namaSekolah:n,nilaiMapel:o,rataRata:parseFloat(r)}})}function setupSettingTabs(){const e=document.querySelectorAll(".tab-button"),t=document.querySelectorAll(".tab-pane");e.forEach(a=>{a.addEventListener("click",()=>{e.forEach(e=>e.classList.remove("active")),t.forEach(e=>e.classList.remove("active")),a.classList.add("active");document.getElementById(a.dataset.target).classList.add("active"),"tab-mapel"===a.dataset.target&&renderSubjectCheckboxes()})})}function renderSubjectCheckboxes(){const e=document.getElementById("subjectSelectionContainer");if(!e)return void console.error("subjectSelectionContainer not found!");if(!window.currentUser||!window.currentUser.schoolData)return void console.error("window.currentUser or schoolData not found!");const t=String(window.currentUser.schoolData[0]),a=database?.settings?.[t]||{};e.innerHTML="";const n=window.currentUser.kurikulum||"Merdeka",o=transcriptSubjects?.[n]||[],i=a.subjectVisibility||{};o.forEach(t=>{const a=!Object.prototype.hasOwnProperty.call(i,t.key)||!!i[t.key];e.insertAdjacentHTML("beforeend",`\n            <div class="subject-checkbox">\n                <input type="checkbox" id="check-${t.key}" data-subject-key="${t.key}" ${a?"checked":""}>\n                <label for="check-${t.key}">${t.display}</label>\n            </div>\n        `)})}function openSekolahModal(e,t=null){const a=document.getElementById("sekolahModal");document.getElementById("sekolahForm").reset(),document.getElementById("sekolahModalMode").value=e,"edit"===e?(document.getElementById("sekolahModalTitle").textContent="Edit Data Sekolah",document.getElementById("originalKodeBiasa").value=t[0],document.getElementById("kodeBiasa").value=t[0],document.getElementById("kodePro").value=t[1],document.getElementById("kecamatan").value=t[2],document.getElementById("npsn").value=t[3],document.getElementById("namaSekolah").value=t[4],document.getElementById("namaSekolahSingkat").value=t[5]):document.getElementById("sekolahModalTitle").textContent="Tambah Sekolah Baru",a.style.display="block"}function closeSekolahModal(){document.getElementById("sekolahModal").style.display="none"}async function handleSekolahFormSubmit(e){e.preventDefault(),showLoader();try{const e=document.getElementById("sekolahModalMode").value,t=document.getElementById("originalKodeBiasa").value,a={mode:e,sekolahData:[document.getElementById("kodeBiasa").value,document.getElementById("kodePro").value,document.getElementById("kecamatan").value,document.getElementById("npsn").value,document.getElementById("namaSekolah").value,document.getElementById("namaSekolahSingkat").value],originalKodeBiasa:t},n=await fetchWithAuth(apiUrl("/api/data/sekolah/save"),{method:"POST",body:JSON.stringify(a)});if(!n.success)throw new Error(n.message);closeSekolahModal(),showNotification(n.message,"success"),await fetchDataFromServer()}catch(e){showNotification(e.message||"Gagal menyimpan data.","error")}finally{hideLoader()}}async function handleDeleteSekolah(e){showLoader();try{const t=await fetchWithAuth(apiUrl("/api/data/sekolah/delete"),{method:"POST",body:JSON.stringify({kodeBiasa:e})});if(!t.success)throw new Error(t.message);showNotification(t.message,"success"),await fetchDataFromServer()}catch(e){showNotification(e.message||"Gagal menghapus data.","error")}finally{hideLoader()}}function generateSmartExcelTemplate(e){const t=XLSX.utils.book_new();if("sekolah"===e){const e=[["KODE_BIASA","KODE_REGISTRASI","NSS","NPSN","NAMA_SEKOLAH","STATUS","BENTUK_PENDIDIKAN","KEPALA_SEKOLAH","OPERATOR"],["CONTOH: 12345","CONTOH: REG001","CONTOH: 101230001001","CONTOH: 10123456","CONTOH: SDN 1 Jakarta","CONTOH: Negeri/Swasta","CONTOH: SD","CONTOH: Pak Budi","CONTOH: Bu Sari"],["","","","","","","","",""]],a=[["KOLOM","ATURAN VALIDASI","KETERANGAN"],["KODE_BIASA","Wajib diisi, angka 5 digit","Kode unik sekolah"],["KODE_REGISTRASI","Opsional, alfanumerik","Kode registrasi sekolah"],["NSS","Wajib diisi, angka 12 digit","Nomor Statistik Sekolah"],["NPSN","Wajib diisi, angka 8 digit","Nomor Pokok Sekolah Nasional"],["NAMA_SEKOLAH","Wajib diisi, maksimal 100 karakter","Nama lengkap sekolah"],["STATUS","Pilihan: Negeri/Swasta","Status sekolah"],["BENTUK_PENDIDIKAN","Pilihan: SD/MI/SDS","Bentuk pendidikan"],["KEPALA_SEKOLAH","Wajib diisi, maksimal 50 karakter","Nama kepala sekolah"],["OPERATOR","Opsional, maksimal 50 karakter","Nama operator sekolah"]],n=XLSX.utils.aoa_to_sheet(e),o=XLSX.utils.aoa_to_sheet(a);XLSX.utils.book_append_sheet(t,n,"Data Sekolah"),XLSX.utils.book_append_sheet(t,o,"Aturan Validasi")}else if("siswa"===e){const e=[["KODE_SEKOLAH","KODE_KELAS","KODE_ROMBEL","KODE_BIASA","NIS","NO_PESERTA","NISN","NAMA_SISWA","TEMPAT_TANGGAL_LAHIR","NAMA_ORANG_TUA","NO_IJAZAH"],["CONTOH: 12345","CONTOH: 6A","CONTOH: R001","CONTOH: 001","CONTOH: 12345","CONTOH: P001","CONTOH: 1234567890","CONTOH: Ahmad Budi","CONTOH: Jakarta, 01 Januari 2010","CONTOH: Pak Rahman",""],["","","","","","","","","","",""]],a=[["KOLOM","ATURAN VALIDASI","KETERANGAN"],["KODE_SEKOLAH","Wajib diisi, angka 5 digit","Harus sesuai dengan kode sekolah yang sudah ada"],["KODE_KELAS","Wajib diisi, format: angka+huruf","Contoh: 5A, 6B"],["KODE_ROMBEL","Opsional, alfanumerik","Kode rombongan belajar"],["KODE_BIASA","Wajib diisi, angka 3 digit","Nomor urut siswa di sekolah"],["NIS","Wajib diisi, maksimal 20 karakter","Nomor Induk Siswa"],["NO_PESERTA","Opsional, alfanumerik","Nomor peserta ujian"],["NISN","Wajib diisi, angka 10 digit","Nomor Induk Siswa Nasional"],["NAMA_SISWA","Wajib diisi, maksimal 50 karakter","Nama lengkap siswa"],["TEMPAT_TANGGAL_LAHIR","Wajib diisi, format: Tempat, DD MM YYYY","Contoh: Jakarta, 01 Januari 2010"],["NAMA_ORANG_TUA","Wajib diisi, maksimal 50 karakter","Nama orang tua/wali"],["NO_IJAZAH","Opsional, akan diisi kemudian","Nomor ijazah siswa"]],n=XLSX.utils.aoa_to_sheet(e),o=XLSX.utils.aoa_to_sheet(a);XLSX.utils.book_append_sheet(t,n,"Data Siswa"),XLSX.utils.book_append_sheet(t,o,"Aturan Validasi")}const a=`Template_${e.charAt(0).toUpperCase()+e.slice(1)}_${(new Date).toISOString().split("T")[0]}.xlsx`;XLSX.writeFile(t,a),showNotification(`Template Excel ${e} berhasil didownload: ${a}`,"success")}function validateExcelData(e,t){const a=[],n=[];return Array.isArray(e)&&0!==e.length?(e.forEach((e,o)=>{const i=o+1;if("sekolah"===t)e[0]&&""!==String(e[0]).trim()?/^\d{5}$/.test(String(e[0]).trim())||a.push(`Baris ${i}: KODE_BIASA harus berupa 5 digit angka`):a.push(`Baris ${i}: KODE_BIASA wajib diisi`),e[2]&&""!==String(e[2]).trim()?/^\d{12}$/.test(String(e[2]).trim())||a.push(`Baris ${i}: NSS harus berupa 12 digit angka`):a.push(`Baris ${i}: NSS wajib diisi`),e[3]&&""!==String(e[3]).trim()?/^\d{8}$/.test(String(e[3]).trim())||a.push(`Baris ${i}: NPSN harus berupa 8 digit angka`):a.push(`Baris ${i}: NPSN wajib diisi`),e[4]&&""!==String(e[4]).trim()?String(e[4]).length>100&&n.push(`Baris ${i}: NAMA_SEKOLAH terlalu panjang (maksimal 100 karakter)`):a.push(`Baris ${i}: NAMA_SEKOLAH wajib diisi`),e[5]&&!["Negeri","Swasta"].includes(String(e[5]).trim())&&n.push(`Baris ${i}: STATUS sebaiknya 'Negeri' atau 'Swasta'`),e[6]&&!["SD","MI","SDS"].includes(String(e[6]).trim())&&n.push(`Baris ${i}: BENTUK_PENDIDIKAN sebaiknya 'SD', 'MI', atau 'SDS'`);else if("siswa"===t){if(e[0]&&""!==String(e[0]).trim()?/^\d{5}$/.test(String(e[0]).trim())||a.push(`Baris ${i}: KODE_SEKOLAH harus berupa 5 digit angka`):a.push(`Baris ${i}: KODE_SEKOLAH wajib diisi`),e[4]&&""!==String(e[4]).trim()||a.push(`Baris ${i}: NIS wajib diisi`),e[6]&&""!==String(e[6]).trim()?/^\d{10}$/.test(String(e[6]).trim())||a.push(`Baris ${i}: NISN harus berupa 10 digit angka`):a.push(`Baris ${i}: NISN wajib diisi`),e[7]&&""!==String(e[7]).trim()?String(e[7]).length>50&&n.push(`Baris ${i}: NAMA_SISWA terlalu panjang (maksimal 50 karakter)`):a.push(`Baris ${i}: NAMA_SISWA wajib diisi`),e[8]&&""!==String(e[8]).trim()){/^.+,\s*\d{1,2}\s+\w+\s+\d{4}$/.test(String(e[8]).trim())||n.push(`Baris ${i}: Format TEMPAT_TANGGAL_LAHIR sebaiknya 'Tempat, DD Bulan YYYY'`)}else a.push(`Baris ${i}: TEMPAT_TANGGAL_LAHIR wajib diisi`);e[9]&&""!==String(e[9]).trim()?String(e[9]).length>50&&n.push(`Baris ${i}: NAMA_ORANG_TUA terlalu panjang (maksimal 50 karakter)`):a.push(`Baris ${i}: NAMA_ORANG_TUA wajib diisi`)}}),{isValid:0===a.length,errors:a,warnings:n,totalRows:e.length}):(a.push("Data kosong atau format tidak valid"),{isValid:!1,errors:a,warnings:n})}function showValidationErrorModal(e){const t=document.createElement("div");t.className="modal-overlay",t.style.cssText="\n        position: fixed; top: 0; left: 0; right: 0; bottom: 0;\n        background: rgba(0,0,0,0.7); z-index: 10000;\n        display: flex; align-items: center; justify-content: center;\n    ";const a=document.createElement("div");a.style.cssText="\n        background: white; border-radius: 12px; padding: 24px;\n        max-width: 600px; width: 90%; max-height: 80vh; overflow-y: auto;\n        box-shadow: 0 20px 60px rgba(0,0,0,0.3);\n    ";const n=e.errors.map(e=>`<li style="margin-bottom: 8px; color: #dc3545;">${e}</li>`).join("");a.innerHTML=`\n        <div style="text-align: center; margin-bottom: 20px;">\n            <div style="color: #dc3545; font-size: 48px; margin-bottom: 12px;">⚠️</div>\n            <h2 style="color: #dc3545; margin-bottom: 8px;">Validasi Gagal</h2>\n            <p style="color: #666;">Data Excel mengandung error yang harus diperbaiki:</p>\n        </div>\n\n        <div style="background: #fff5f5; border: 1px solid #fed7d7; border-radius: 8px; padding: 16px; margin-bottom: 20px;">\n            <h4 style="color: #dc3545; margin-bottom: 12px;">Error yang ditemukan (${e.errors.length}):</h4>\n            <ul style="margin: 0; padding-left: 20px;">${n}</ul>\n        </div>\n\n        <div style="text-align: center;">\n            <button id="closeValidationError" style="\n                background: #dc3545; color: white; border: none; padding: 12px 24px;\n                border-radius: 8px; cursor: pointer; font-size: 16px; font-weight: 500;\n            ">Tutup dan Perbaiki Data</button>\n        </div>\n    `,t.appendChild(a),document.body.appendChild(t),document.getElementById("closeValidationError").onclick=()=>{t.remove()},t.onclick=e=>{e.target===t&&t.remove()}}function showValidationWarningModal(e){return new Promise(t=>{const a=document.createElement("div");a.className="modal-overlay",a.style.cssText="\n            position: fixed; top: 0; left: 0; right: 0; bottom: 0;\n            background: rgba(0,0,0,0.7); z-index: 10000;\n            display: flex; align-items: center; justify-content: center;\n        ";const n=document.createElement("div");n.style.cssText="\n            background: white; border-radius: 12px; padding: 24px;\n            max-width: 600px; width: 90%; max-height: 80vh; overflow-y: auto;\n            box-shadow: 0 20px 60px rgba(0,0,0,0.3);\n        ";const o=e.warnings.map(e=>`<li style="margin-bottom: 8px; color: #f56500;">${e}</li>`).join("");n.innerHTML=`\n            <div style="text-align: center; margin-bottom: 20px;">\n                <div style="color: #f56500; font-size: 48px; margin-bottom: 12px;">⚠️</div>\n                <h2 style="color: #f56500; margin-bottom: 8px;">Peringatan Validasi</h2>\n                <p style="color: #666;">Data Excel mengandung warning yang sebaiknya diperbaiki:</p>\n            </div>\n\n            <div style="background: #fffbf0; border: 1px solid #fed7aa; border-radius: 8px; padding: 16px; margin-bottom: 20px;">\n                <h4 style="color: #f56500; margin-bottom: 12px;">Warning ditemukan (${e.warnings.length}):</h4>\n                <ul style="margin: 0; padding-left: 20px;">${o}</ul>\n            </div>\n\n            <div style="text-align: center; display: flex; gap: 12px; justify-content: center;">\n                <button id="cancelWarning" style="\n                    background: #6b7280; color: white; border: none; padding: 12px 24px;\n                    border-radius: 8px; cursor: pointer; font-size: 16px; font-weight: 500;\n                ">Batal dan Perbaiki</button>\n                <button id="proceedWarning" style="\n                    background: #f56500; color: white; border: none; padding: 12px 24px;\n                    border-radius: 8px; cursor: pointer; font-size: 16px; font-weight: 500;\n                ">Lanjutkan Import</button>\n            </div>\n        `,a.appendChild(n),document.body.appendChild(a),document.getElementById("cancelWarning").onclick=()=>{a.remove(),t(!1)},document.getElementById("proceedWarning").onclick=()=>{a.remove(),t(!0)},a.onclick=e=>{e.target===a&&(a.remove(),t(!1))}})}function showImportPreviewModal(e,t,a){return new Promise(n=>{const o=document.createElement("div");o.className="modal-overlay",o.style.cssText="\n            position: fixed; top: 0; left: 0; right: 0; bottom: 0;\n            background: rgba(0,0,0,0.7); z-index: 10000;\n            display: flex; align-items: center; justify-content: center;\n        ";const i=document.createElement("div");i.style.cssText="\n            background: white; border-radius: 12px; padding: 24px;\n            max-width: 90%; width: 1000px; max-height: 80vh; overflow-y: auto;\n            box-shadow: 0 20px 60px rgba(0,0,0,0.3);\n        ";const s=e.slice(0,5),r="sekolah"===t?["KODE_BIASA","KODE_REGISTRASI","NSS","NPSN","NAMA_SEKOLAH","STATUS","BENTUK_PENDIDIKAN","KEPALA_SEKOLAH","OPERATOR"]:["KODE_SEKOLAH","KODE_KELAS","KODE_ROMBEL","KODE_BIASA","NIS","NO_PESERTA","NISN","NAMA_SISWA","TEMPAT_TANGGAL_LAHIR","NAMA_ORANG_TUA","NO_IJAZAH"],l=`\n            <table style="width: 100%; border-collapse: collapse; margin: 16px 0;">\n                <thead>\n                    <tr style="background: #f8f9fa;">\n                        ${r.map(e=>`<th style="border: 1px solid #dee2e6; padding: 8px; font-size: 12px;">${e}</th>`).join("")}\n                    </tr>\n                </thead>\n                <tbody>\n                    ${s.map(e=>`\n                        <tr>\n                            ${r.map((t,a)=>`<td style="border: 1px solid #dee2e6; padding: 8px; font-size: 12px;">${e[a]||""}</td>`).join("")}\n                        </tr>\n                    `).join("")}\n                </tbody>\n            </table>\n        `;i.innerHTML=`\n            <div style="text-align: center; margin-bottom: 20px;">\n                <div style="color: #28a745; font-size: 48px; margin-bottom: 12px;">📊</div>\n                <h2 style="color: #28a745; margin-bottom: 8px;">Preview Import Data</h2>\n                <p style="color: #666;">Konfirmasi data yang akan diimport:</p>\n            </div>\n\n            <div style="background: #f0f9ff; border: 1px solid #bfdbfe; border-radius: 8px; padding: 16px; margin-bottom: 16px;">\n                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px;">\n                    <div><strong>Total Rows:</strong> ${a.totalRows}</div>\n                    <div><strong>Type:</strong> ${t.charAt(0).toUpperCase()+t.slice(1)}</div>\n                    <div><strong>Errors:</strong> <span style="color: ${a.errors.length>0?"#dc3545":"#28a745"}">${a.errors.length}</span></div>\n                    <div><strong>Warnings:</strong> <span style="color: ${a.warnings.length>0?"#f56500":"#28a745"}">${a.warnings.length}</span></div>\n                </div>\n            </div>\n\n            <div style="margin-bottom: 20px;">\n                <h4 style="margin-bottom: 12px;">Preview Data (5 baris pertama):</h4>\n                <div style="overflow-x: auto; border: 1px solid #dee2e6; border-radius: 8px;">\n                    ${l}\n                </div>\n                ${e.length>5?`<p style="text-align: center; color: #666; margin-top: 8px; font-size: 14px;">... dan ${e.length-5} baris lainnya</p>`:""}\n            </div>\n\n            <div style="text-align: center; display: flex; gap: 12px; justify-content: center;">\n                <button id="cancelImport" style="\n                    background: #6b7280; color: white; border: none; padding: 12px 24px;\n                    border-radius: 8px; cursor: pointer; font-size: 16px; font-weight: 500;\n                ">Batal</button>\n                <button id="confirmImport" style="\n                    background: #28a745; color: white; border: none; padding: 12px 24px;\n                    border-radius: 8px; cursor: pointer; font-size: 16px; font-weight: 500;\n                ">Import Data (${a.totalRows} rows)</button>\n            </div>\n        `,o.appendChild(i),document.body.appendChild(o),document.getElementById("cancelImport").onclick=()=>{o.remove(),n(!1)},document.getElementById("confirmImport").onclick=()=>{o.remove(),n(!0)},o.onclick=e=>{e.target===o&&(o.remove(),n(!1))}})}async function handleFile(e,t){const a=e.target.closest(".btn, button");let n="";try{a&&(n=showButtonLoading(a)),"function"==typeof showLoader&&showLoader("Memproses file Excel...");const o=e.target?.files?.[0];if(!o)return void("function"==typeof showSmartNotification&&showSmartNotification("Tidak ada file yang dipilih.","warning","upload file"));const i=await o.arrayBuffer(),s=XLSX.read(i,{type:"array"}),r=[];for(const e of s.SheetNames){const t=s.Sheets[e];let a=XLSX.utils.sheet_to_json(t,{header:1,blankrows:!1})||[];a.length&&(a.shift(),a=a.filter(e=>Array.isArray(e)&&e.some(e=>""!==String(e??"").trim())),a.length&&r.push(...a))}if(!r.length)return void("function"==typeof showNotification&&showNotification("Tidak ada baris data valid pada file.","warning"));const l=await fetchWithAuth(apiUrl(`/api/data/import/${t}`),{method:"POST",body:JSON.stringify(r)});if(!l?.success)throw new Error(l?.message||"Import gagal pada server.");let d=10;const c=document.querySelector(`.pagination-controls[data-table-id="${t}"] .rows-per-page`)||document.querySelector(`#${t} .pagination-controls .rows-per-page`);c&&c.value?d=c.value:"object"==typeof paginationState&&paginationState?.[t]?.rowsPerPage&&(d=paginationState[t].rowsPerPage);if(!await fetchDataFromServer())throw new Error("Gagal memuat ulang data dari server setelah import.");const u=document.getElementById(`search${t.charAt(0).toUpperCase()}${t.slice(1)}`)||document.querySelector(`.search-bar[data-table-id="${t}"]`);if(u&&(u.value=""),"object"==typeof searchState&&Object.prototype.hasOwnProperty.call(searchState,t)&&(searchState[t]=""),"object"==typeof paginationState&&(paginationState[t]||(paginationState[t]={currentPage:1,rowsPerPage:10}),paginationState[t].currentPage=1,paginationState[t].rowsPerPage=d),"function"==typeof renderAdminTable?renderAdminTable(t):"function"==typeof rerenderActiveTable&&rerenderActiveTable(t),"siswa"===t&&refreshSiswaSearchData(),"function"==typeof showNotification){showNotification(`Import ${t} berhasil: ${l?.message||`${r.length} baris diimpor.`}`,"success")}e.target.value=""}catch(e){console.error("Import error:",e),"function"==typeof showSmartNotification&&showSmartNotification(e,"error","import file Excel")}finally{a&&hideButtonLoading(a,n),"function"==typeof hideLoader&&hideLoader()}}async function handleDeleteAllDataClick(e){const t="sekolah"===(()=>{const t=e?.currentTarget||e?.target;return t?.dataset?.tableId||"sekolah"})()?["Anda akan MENGHAPUS SEMUA DATA SEKOLAH.","Karena relasi database (FOREIGN KEY + CASCADE), SEMUA SISWA, NILAI, dan FOTO TERKAIT juga akan ikut terhapus.","","Tindakan ini tidak dapat dibatalkan.","Ketik HAPUS untuk konfirmasi kemudian tekan OK."].join("\n"):["Perhatian:","Saat ini penghapusan massal berjalan di level basis data.",'Menjalankan "hapus semua" akan mengosongkan tabel-tabel terkait (termasuk siswa & nilai).',"","Tindakan ini tidak dapat dibatalkan.","Ketik HAPUS untuk konfirmasi kemudian tekan OK."].join("\n");if("HAPUS"===prompt(t,""))try{"function"==typeof showLoader&&showLoader();const e=await fetchWithAuth(apiUrl("/api/data/delete-all"),{method:"POST"});if(!e?.success)throw new Error(e?.message||"Gagal menghapus data.");if(!await fetchDataFromServer())throw new Error("Gagal memuat ulang data setelah penghapusan.");const t=["sekolah","siswa"];t.forEach(e=>{const t=document.getElementById(`search${e.charAt(0).toUpperCase()}${e.slice(1)}`)||document.querySelector(`.search-bar[data-table-id="${e}"]`);t&&(t.value=""),"object"==typeof searchState&&Object.prototype.hasOwnProperty.call(searchState,e)&&(searchState[e]=""),"object"==typeof paginationState&&(paginationState[e]||(paginationState[e]={currentPage:1,rowsPerPage:10}),paginationState[e].currentPage=1,paginationState[e].rowsPerPage="all")}),"function"==typeof renderAdminTable?t.forEach(e=>renderAdminTable(e)):"function"==typeof rerenderActiveTable&&t.forEach(e=>rerenderActiveTable(e)),"function"==typeof showNotification&&showNotification("Seluruh data berhasil dihapus.","success")}catch(e){console.error("Delete-all error:",e),"function"==typeof showNotification&&showNotification(e.message||"Terjadi kesalahan saat menghapus data.","error")}finally{"function"==typeof hideLoader&&hideLoader();try{(e?.currentTarget||e?.target)?.blur?.()}catch(e){}}else"function"==typeof showNotification&&showNotification("Dibatalkan.","warning")}function bindAdminDeleteAllButtons(){const e=document.querySelector('#sekolah .btn.btn-delete[data-table-id="sekolah"]');e&&(e.removeEventListener("click",handleDeleteAllSekolahClick),e.addEventListener("click",handleDeleteAllSekolahClick));const t=document.querySelector('#siswa .btn.btn-delete[data-table-id="siswa"]');t&&(t.removeEventListener("click",handleDeleteAllSiswaClick),t.addEventListener("click",handleDeleteAllSiswaClick))}async function handleDeleteAllSekolahClick(e){if(confirm("Anda akan MENGHAPUS SEMUA DATA SEKOLAH.\nTindakan ini hanya menyasar tabel SEKOLAH.\nJika masih ada SISWA terkait, penghapusan akan DITOLAK.\n\nApakah Anda yakin?"))try{"function"==typeof showLoader&&showLoader();const e=await fetchWithAuth(apiUrl("/api/data/delete-all"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({tableId:"sekolah"})});if(!e?.success)throw new Error(e?.message||"Gagal menghapus data sekolah.");if(!await fetchDataFromServer())throw new Error("Gagal memuat ulang data setelah penghapusan.");["sekolah","siswa"].forEach(e=>{const t=document.getElementById(`search${e.charAt(0).toUpperCase()}${e.slice(1)}`)||document.querySelector(`.search-bar[data-table-id="${e}"]`);t&&(t.value=""),"object"==typeof searchState&&Object.prototype.hasOwnProperty.call(searchState,e)&&(searchState[e]=""),"object"==typeof paginationState&&(paginationState[e]||(paginationState[e]={currentPage:1,rowsPerPage:10}),paginationState[e].currentPage=1,paginationState[e].rowsPerPage="all")}),"function"==typeof renderAdminTable?(renderAdminTable("sekolah"),renderAdminTable("siswa")):"function"==typeof rerenderActiveTable&&(rerenderActiveTable("sekolah"),rerenderActiveTable("siswa")),"function"==typeof showNotification&&showNotification("Semua data sekolah (beserta siswa & nilai) berhasil dihapus.","success")}catch(e){console.error("Delete-all sekolah error:",e),"function"==typeof showNotification&&showNotification(e.message||"Terjadi kesalahan saat menghapus sekolah.","error")}finally{"function"==typeof hideLoader&&hideLoader();try{(e?.currentTarget||e?.target)?.blur?.()}catch(e){}}else"function"==typeof showNotification&&showNotification("Dibatalkan.","warning")}async function handleDeleteAllSiswaClick(e){if(confirm("Anda akan MENGHAPUS SEMUA DATA SISWA.\nTindakan ini hanya menyasar tabel SISWA.\nJika masih ada NILAI/FOTO terkait, penghapusan akan DITOLAK.\nDATA SEKOLAH TETAP ADA.\n\nApakah Anda yakin?"))try{"function"==typeof showLoader&&showLoader();const e=await fetchWithAuth(apiUrl("/api/data/delete-all"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({tableId:"siswa"})});if(!e?.success)throw new Error(e?.message||"Gagal menghapus data siswa.");if(!await fetchDataFromServer())throw new Error("Gagal memuat ulang data setelah penghapusan.");const t="siswa",a=document.getElementById(`search${t.charAt(0).toUpperCase()}${t.slice(1)}`)||document.querySelector(`.search-bar[data-table-id="${t}"]`);a&&(a.value=""),"object"==typeof searchState&&Object.prototype.hasOwnProperty.call(searchState,t)&&(searchState[t]=""),"object"==typeof paginationState&&(paginationState[t]||(paginationState[t]={currentPage:1,rowsPerPage:10}),paginationState[t].currentPage=1,paginationState[t].rowsPerPage="all"),"function"==typeof renderAdminTable?(renderAdminTable("siswa"),renderAdminTable("sekolah")):"function"==typeof rerenderActiveTable&&(rerenderActiveTable("siswa"),rerenderActiveTable("sekolah")),"function"==typeof showNotification&&showNotification("Semua data siswa (beserta nilai & foto) berhasil dihapus. Data sekolah tetap ada.","success")}catch(e){console.error("Delete-all siswa error:",e),"function"==typeof showNotification&&showNotification(e.message||"Terjadi kesalahan saat menghapus siswa.","error")}finally{"function"==typeof hideLoader&&hideLoader();try{(e?.currentTarget||e?.target)?.blur?.()}catch(e){}}else"function"==typeof showNotification&&showNotification("Dibatalkan.","warning")}async function refreshIsiNilaiViewAfterSave(){const e=paginationState?.isiNilai?.currentSemester,t=paginationState?.isiNilai?.currentSemesterName||"";paginationState?.isiNilai&&(paginationState.isiNilai.currentPage=1,paginationState.isiNilai.rowsPerPage=10),searchState&&(searchState.isiNilai="");const a=document.getElementById("searchIsiNilai");if(a&&(a.value=""),await new Promise(e=>setTimeout(e,100)),"function"==typeof window.renderIsiNilaiPage)window.renderIsiNilaiPage(e,t);else if("function"==typeof window.switchSekolahContent)try{window.switchSekolahContent("isiNilai")}catch(e){}setTimeout(()=>{if("function"==typeof window.updatePaginationControls)try{window.updatePaginationControls("isiNilai")}catch(e){}if("function"==typeof window.optimizedUpdatePaginationControls){const e=database.siswa?.filter(e=>String(e[0])===String(window.currentUser.schoolData[0]))||[];try{window.optimizedUpdatePaginationControls("isiNilai",e.length)}catch(e){}}},200)}async function waitForImages(e){const t=Array.from(e.querySelectorAll("img")).filter(e=>!e.complete||0===e.naturalWidth);0!==t.length&&await Promise.all(t.map(e=>new Promise(t=>{e.crossOrigin||(e.crossOrigin="anonymous");const a=()=>t();e.onload=a,e.onerror=a})))}"loading"===document.readyState?document.addEventListener("DOMContentLoaded",bindAdminDeleteAllButtons):bindAdminDeleteAllButtons(),function(){const e=document.getElementById("appCode");e&&e.focus();const t=document.querySelector('#loginForm button[type="submit"]');t&&(t.disabled=!1,t.style.opacity="1",t.textContent="Masuk");const a=document.getElementById("cancelBtn");a&&a.addEventListener("click",()=>{const t=document.getElementById("loginForm");t&&t.reset(),e&&(e.value="",e.focus());const a=document.getElementById("kurikulumMerdeka");a&&(a.checked=!0);const n=document.querySelector('#loginForm button[type="submit"]');n&&(n.disabled=!1,n.style.opacity="1",n.textContent="Masuk")}),e&&e.addEventListener("keydown",e=>{if("Enter"===e.key){const e=document.getElementById("loginForm");e&&(e.requestSubmit?e.requestSubmit():e.submit())}})}();const PX_PER_MM=96/25.4;function mmToPx(e){return e*PX_PER_MM}function updateSliderLabel(e){const t={settingLogoLeftSize:"logoLeftSizeLabel",settingLogoRightSize:"logoRightSizeLabel",settingLogoLeftPosTop:"logoLeftPosTopLabel",settingLogoLeftPosLeft:"logoLeftPosLeftLabel",settingLogoRightPosTop:"logoRightPosTopLabel",settingLogoRightPosRight:"logoRightPosRightLabel"}[e];if(t){const a=document.getElementById(e),n=document.getElementById(t);a&&n&&(n.textContent=a.value)}}function updateLogoPreviewUI(){const e=window.currentUser?.schoolData?.[0],t="pro"===window.currentUser?.loginType||e&&"true"===localStorage.getItem(`kodeProActivated:${e}`);if(window.currentUser?.schoolData){const a=database?.settings?.[e]||{},n=document.getElementById("logoLeftPreview"),o=document.getElementById("logoRightPreview");n&&(n.src=t&&a.logoLeft?a.logoLeft:"./assets/kop-left-melawi.png"),o&&(o.src=t&&a.logoRight?a.logoRight:"./assets/kop-right-tutwuri.png");const i=document.getElementById("logoLeftUploadBtn"),s=document.getElementById("logoRightUploadBtn"),r=document.getElementById("logoLeftProWarning"),l=document.getElementById("logoRightProWarning"),d=document.getElementById("settingLogoLeftInput"),c=document.getElementById("settingLogoRightInput");t?(i&&(i.style.display="inline-block"),s&&(s.style.display="inline-block"),r&&(r.style.display="none"),l&&(l.style.display="none"),d&&(d.disabled=!1),c&&(c.disabled=!1)):(i&&(i.style.display="none"),s&&(s.style.display="none"),r&&(r.style.display="block"),l&&(l.style.display="block"),d&&(d.disabled=!0),c&&(c.disabled=!0))}const a=e=>{const t=document.getElementById(e);if(!t)return null;const a=Number(t.value);return Number.isFinite(a)?a:null},n=a("settingLogoLeftPosTop"),o=a("settingLogoLeftPosLeft"),i=a("settingLogoRightPosTop"),s=a("settingLogoRightPosRight"),r=a("settingLogoLeftSize"),l=a("settingLogoRightSize"),d=document.getElementById("livePreviewLeftLogo"),c=document.getElementById("livePreviewRightLogo"),u=document.getElementById("livePreviewPlaceholder");if(d||c){if(window.currentUser?.schoolData){const e=String(window.currentUser.schoolData[0]),t=database?.settings?.[e]||{},a=document.getElementById("livePreviewSchoolName"),n=document.getElementById("livePreviewSchoolAddress");if(a){const e=(window.currentUser.schoolData[4]||"NAMA SEKOLAH").toUpperCase();a.textContent=e}n&&(n.textContent=t.schoolAddress||"Alamat Sekolah Belum Diatur")}let e=!1;if(d){const t=null!==n?n:13,a=null!==o?o:15,i=null!==r?r:80;d.style.top=`${t}mm`,d.style.left=`${a}mm`,d.style.width=`${i}px`;const s=document.getElementById("logoLeftPreview");s&&s.src?(d.src=s.src,d.style.display="block",e=!0):(d.src="./assets/kop-left-melawi.png",d.style.display="block",e=!0)}if(c){const t=null!==i?i:13,a=null!==s?s:15,n=null!==l?l:80;c.style.top=`${t}mm`,c.style.right=`${a}mm`,c.style.width=`${n}px`;const o=document.getElementById("logoRightPreview");o&&o.src?(c.src=o.src,c.style.display="block",e=!0):(c.src="./assets/kop-right-tutwuri.png",c.style.display="block",e=!0)}u&&(u.style.display=e?"none":"block")}["transkripContent","sklContent","skkbContent","pdf-content"].map(e=>document.getElementById(e)).filter(Boolean).forEach(e=>{const t=e.querySelector('img[alt="Logo Kiri"]'),a=e.querySelector('img[alt="Logo Kanan"]');t&&(null!=n&&(t.style.top=`${n}mm`),null!=o&&(t.style.left=`${o}mm`),null!=r&&(t.style.width=`${r}px`)),a&&(null!=i&&(a.style.top=`${i}mm`),null!=s&&(a.style.right=`${s}mm`),null!=l&&(a.style.width=`${l}px`))})}function bindLiveLogoOnce(){const e=document.getElementById("settingsForm");if(!e||e.dataset.liveLogoBound)return;["settingLogoLeftPosTop","settingLogoLeftPosLeft","settingLogoRightPosTop","settingLogoRightPosRight","settingLogoLeftSize","settingLogoRightSize"].forEach(e=>{const t=document.getElementById(e);t&&t.addEventListener("input",()=>{updateSliderLabel(e),updateLogoPreviewUI()})}),e.dataset.liveLogoBound="1"}function initAktivasiKodePro(){const e=document.getElementById("kodeProInput"),t=document.getElementById("aktivasiButton"),a=(document.getElementById("menuAktivasiKodePro"),window.currentUser?.schoolData?.[0]),n=(window.currentUser,!!a&&"true"===localStorage.getItem(`kodeProActivated:${a}`));if("pro"===window.currentUser?.loginType||"biasa"===window.currentUser?.loginType&&n)return disableAktivasiMenu(),void showSuccessStatus();if(e&&"1"!==e.dataset.bound){const a=function(){let e=this.value.toUpperCase().replace(/[^A-Z0-9]/g,"");e.length>8&&(e=e.substring(0,8)),this.value=e,t&&(t.disabled=8!==e.length)},n=function(e){e.preventDefault();const a=(e.clipboardData||window.clipboardData).getData("text").toUpperCase().replace(/[^A-Z0-9]/g,"").substring(0,8);this.value=a,t&&(t.disabled=8!==a.length)};e.addEventListener("input",a),e.addEventListener("paste",n),e.dataset.bound="1"}t&&"1"!==t.dataset.bound&&(t.addEventListener("click",async function(){const t=e.value.trim();if(8===t.length)try{showLoader(),await new Promise(e=>setTimeout(e,1e3));const e=t.toString().trim().toUpperCase(),n=(window.currentUser?.schoolData?.[1]||"").toString().trim().toUpperCase();if(n&&e!==n)return hideLoader(),void showNotification("Kode Pro tidak sesuai","error");if(!n&&!/^[A-Z0-9]{8}$/.test(e))return hideLoader(),void showNotification("Kode Pro harus 8 karakter huruf/angka!","error");if(a&&(localStorage.setItem(`kodeProActivated:${a}`,"true"),localStorage.setItem(`kodeProValue:${a}`,t)),window.currentUser&&window.currentUser.isLoggedIn&&"sekolah"===window.currentUser.role){window.currentUser.loginType="pro";const e=JSON.parse(localStorage.getItem("currentUserSession")||"{}");e&&(e.loginType="pro",localStorage.setItem("currentUserSession",JSON.stringify(e)))}showSuccessStatus(),disableAktivasiMenu(),"function"==typeof renderVersionBadge&&renderVersionBadge();try{"function"==typeof renderProfilSiswa&&renderProfilSiswa()}catch(e){}setTimeout(()=>{try{window.location.reload()}catch(e){}},600),showAktivasiSuccessPopup(t),hideLoader()}catch(e){hideLoader(),showNotification("Gagal mengaktivasi kode pro. Silakan coba lagi.","error")}else showNotification("Kode Pro harus 8 karakter!","error")}),t.dataset.bound="1")}function showSuccessStatus(){const e=document.getElementById("aktivasiSuccess"),t=document.querySelector(".aktivasi-form-container");if(e&&t){e.classList.add("show"),t.style.display="none";const a=window.currentUser?.schoolData?.[0],n=a&&localStorage.getItem(`kodeProValue:${a}`)||"********",o=e.querySelector(".kode-pro-display");o&&(o.textContent=n)}}function disableAktivasiMenu(){const e=document.getElementById("menuAktivasiKodePro");e&&(e.classList.add("disabled"),e.addEventListener("click",preventDisabledClick))}function enableAktivasiMenu(){const e=document.getElementById("menuAktivasiKodePro");e&&(e.classList.remove("disabled"),e.removeEventListener("click",preventDisabledClick))}function preventDisabledClick(e){const t=e.target.closest("#menuAktivasiKodePro");if(t&&t.classList.contains("disabled"))return e.preventDefault(),e.stopPropagation(),!1}function showAktivasiSuccessPopup(e){const t=document.createElement("div");t.className="success-popup-overlay",t.innerHTML=`\n    <div class="success-popup-content">\n      <div class="success-popup-icon">✅</div>\n      <h2>Berhasil Aktivasi!</h2>\n      <p>Kode Pro <strong>${e}</strong> berhasil diaktivasi.</p>\n      <p>Sekarang Anda memiliki akses penuh ke semua fitur aplikasi.</p>\n      <button class="popup-close-btn" onclick="closeSuccessPopup()">Tutup</button>\n    </div>\n  `;const a=document.createElement("style");a.textContent="\n    .success-popup-overlay {\n      position: fixed;\n      top: 0;\n      left: 0;\n      width: 100%;\n      height: 100%;\n      background: rgba(0, 0, 0, 0.5);\n      display: flex;\n      justify-content: center;\n      align-items: center;\n      z-index: 10000;\n    }\n    \n    .success-popup-content {\n      background: white;\n      padding: 40px 30px;\n      border-radius: 15px;\n      text-align: center;\n      max-width: 400px;\n      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);\n    }\n    \n    .success-popup-icon {\n      font-size: 60px;\n      margin-bottom: 20px;\n    }\n    \n    .success-popup-content h2 {\n      color: var(--success-green);\n      margin-bottom: 15px;\n      font-size: 24px;\n    }\n    \n    .success-popup-content p {\n      color: #666;\n      margin-bottom: 15px;\n      line-height: 1.5;\n    }\n    \n    .popup-close-btn {\n      background: #4a90e2;\n      color: white;\n      border: none;\n      padding: 12px 30px;\n      border-radius: 6px;\n      font-size: 16px;\n      font-weight: 600;\n      cursor: pointer;\n      margin-top: 10px;\n      transition: background 0.3s ease;\n    }\n    \n    .popup-close-btn:hover {\n      background: #3a7bc8;\n    }\n  ",document.head.appendChild(a),document.body.appendChild(t)}function closeSuccessPopup(){const e=document.querySelector(".success-popup-overlay");e&&e.remove()}function switchToAktivasiKodePro(){document.getElementById("aktivasiKodeProSection")&&initAktivasiKodePro()}function initRekapFilters(){const e=document.getElementById("filterKurikulum"),t=document.getElementById("adminFilterKecamatan"),a=document.getElementById("filterSekolah"),n=document.getElementById("searchRekapBtn"),o=document.getElementById("rekapNilaiTableBody");a.innerHTML='<option value="">-- Pilih Kecamatan Dahulu --</option>',a.disabled=!0,n.disabled=!0,o&&(o.innerHTML='<tr><td colspan="100%" style="text-align:center; padding: 20px;">Silakan lengkapi semua filter di atas untuk menampilkan data.</td></tr>'),async function(){t.innerHTML='<option value="">Memuat...</option>',t.disabled=!0;try{const e=await fetchWithAuth("/api/data/rekap/kecamatan");if(!e.success)throw new Error(e.message);t.innerHTML='<option value="">Pilih Kecamatan</option>',e.data.forEach(e=>{const a=new Option(e,e);t.add(a)}),t.disabled=!1}catch(e){showNotification(e.message||"Gagal memuat data kecamatan.","error"),t.innerHTML='<option value="">-- Gagal Memuat --</option>'}}(),e.onchange=async()=>{e.value;a.innerHTML='<option value="">-- Pilih Kecamatan Dahulu --</option>',a.disabled=!0,n.disabled=!0,o&&(o.innerHTML='<tr><td colspan="100%" style="text-align:center; padding: 20px;">Silakan lengkapi semua filter di atas untuk menampilkan data.</td></tr>'),t.innerHTML='<option value="">Memuat...</option>',t.disabled=!0,showLoader();try{const e=await fetchWithAuth("/api/data/rekap/kecamatan");if(!e.success)throw new Error(e.message);t.innerHTML='<option value="">Pilih Kecamatan</option>',e.data.forEach(e=>{const a=new Option(e,e);t.add(a)}),t.disabled=!1}catch(e){showNotification(e.message||"Gagal memuat data kecamatan.","error"),t.innerHTML='<option value="">-- Gagal Memuat --</option>'}finally{hideLoader()}},t.onchange=async()=>{const e=t.value;if(n.disabled=!0,o&&(o.innerHTML='<tr><td colspan="100%" style="text-align:center; padding: 20px;">Silakan lengkapi semua filter di atas untuk menampilkan data.</td></tr>'),e){a.innerHTML='<option value="">Memuat...</option>',a.disabled=!0,showLoader();try{const t=await fetchWithAuth(`/api/data/rekap/sekolah/${e}`);if(!t.success)throw new Error(t.message);a.innerHTML='<option value="">Pilih Sekolah</option>',t.data.forEach(e=>{const t=new Option(e.namaSekolahLengkap,e.kodeBiasa);a.add(t)}),a.disabled=!1}catch(e){showNotification(e.message||"Gagal memuat data sekolah.","error"),a.innerHTML='<option value="">-- Gagal Memuat --</option>'}finally{hideLoader()}}else a.innerHTML='<option value="">-- Pilih Kecamatan Dahulu --</option>',a.disabled=!0},a.onchange=()=>{o&&(o.innerHTML='<tr><td colspan="100%" style="text-align:center; padding: 20px;">Silakan lengkapi semua filter di atas untuk menampilkan data.</td></tr>'),n.disabled=!a.value},n.onclick=()=>{e.value;const n=t.value,o=a.value;n&&o?(showNotification(`Mencari data untuk sekolah dengan kode: ${o}`,"info"),filterAndRenderRekapNilaiAdminTable()):showNotification("Harap pilih kecamatan dan sekolah sebelum mencari.","warning")};const i=document.getElementById("downloadRekapPdfBtn");i&&(i.onclick=()=>{downloadRekapNilaiAdminPDF()})}function initMobileMenu(){const e=document.getElementById("adminMobileMenuToggle"),t=document.getElementById("sekolahMobileMenuToggle"),a=document.getElementById("adminSidebar"),n=document.getElementById("sekolahSidebar");e&&a&&e.addEventListener("click",e=>{e.preventDefault(),e.stopPropagation(),a.classList.toggle("mobile-open"),n&&n.classList.remove("mobile-open")}),t&&n&&t.addEventListener("click",e=>{e.preventDefault(),e.stopPropagation(),n.classList.toggle("mobile-open"),a&&a.classList.remove("mobile-open")}),document.addEventListener("click",e=>{e.target.closest(".mobile-menu-toggle")||e.target.closest(".sidebar")||(a&&a.classList.remove("mobile-open"),n&&n.classList.remove("mobile-open"))}),document.addEventListener("keydown",e=>{"Escape"===e.key&&(a&&a.classList.remove("mobile-open"),n&&n.classList.remove("mobile-open"))});document.querySelectorAll(".menu-item, .submenu-item").forEach(e=>{e.addEventListener("click",()=>{window.innerWidth<=480&&setTimeout(()=>{a&&a.classList.remove("mobile-open"),n&&n.classList.remove("mobile-open")},100)})})}document.addEventListener("DOMContentLoaded",function(){if(document.getElementById("sekolahDashboard")&&window.currentUser){const e=window.currentUser?.schoolData?.[0],t=!!e&&"true"===localStorage.getItem(`kodeProActivated:${e}`);"pro"===window.currentUser?.loginType||t?disableAktivasiMenu():"biasa"!==window.currentUser?.loginType||t||enableAktivasiMenu()}}),document.addEventListener("DOMContentLoaded",()=>{initMobileMenu()});const SkeletonLoader={createTableSkeleton:(e=5,t=6)=>{let a="";for(let n=0;n<e;n++){a+='<tr class="skeleton-row">';for(let e=0;e<t;e++){a+=`<td><div class="skeleton skeleton-text table-skeleton-cell ${0===e||e===t-1?"narrow":""}"></div></td>`}a+="</tr>"}return a},createDashboardSkeleton:()=>`\n            <div class="skeleton-dashboard">\n                <div class="dashboard-left">\n                    <div class="skeleton-stats-grid">\n                        <div class="skeleton-stat-card">\n                            <div class="skeleton skeleton-title"></div>\n                            <div class="skeleton skeleton-text short"></div>\n                        </div>\n                        <div class="skeleton-stat-card">\n                            <div class="skeleton skeleton-title"></div>\n                            <div class="skeleton skeleton-text short"></div>\n                        </div>\n                    </div>\n                    <div class="skeleton-chart">\n                        <div class="skeleton skeleton-title"></div>\n                        <div class="skeleton skeleton-header" style="height: 120px; margin-top: 20px;"></div>\n                    </div>\n                    <div class="skeleton-chart">\n                        <div class="skeleton skeleton-title"></div>\n                        <div class="skeleton skeleton-header" style="height: 100px; margin-top: 20px;"></div>\n                    </div>\n                </div>\n                <div class="dashboard-right">\n                    <div class="skeleton-ranking">\n                        <div class="skeleton skeleton-title"></div>\n                        ${this.createRankingSkeleton(8)}\n                    </div>\n                </div>\n            </div>\n        `,createRankingSkeleton:(e=10)=>{let t="";for(let a=0;a<e;a++)t+='\n                <div class="skeleton-ranking-item">\n                    <div class="skeleton skeleton-ranking-number"></div>\n                    <div class="skeleton-ranking-info">\n                        <div class="skeleton skeleton-text medium"></div>\n                        <div class="skeleton skeleton-text short"></div>\n                    </div>\n                </div>\n            ';return t},createFormSkeleton:(e=6)=>{let t='<div class="form-skeleton">';for(let a=0;a<e;a++)t+='\n                <div class="form-skeleton-group">\n                    <div class="skeleton skeleton-form-label"></div>\n                    <div class="skeleton skeleton-form-input"></div>\n                </div>\n            ';return t+="</div>",t},createCardSkeleton:(e=3)=>{let t="";for(let a=0;a<e;a++)t+='\n                <div class="skeleton-card">\n                    <div class="skeleton skeleton-title"></div>\n                    <div class="skeleton skeleton-text long"></div>\n                    <div class="skeleton skeleton-text medium"></div>\n                    <div class="skeleton skeleton-text short"></div>\n                    <div class="skeleton skeleton-button"></div>\n                </div>\n            ';return t},show:(e,t="table",a={})=>{const n=document.getElementById(e);if(!n)return;let o="";switch(t){case"table":o="tbody"===n.tagName.toLowerCase()?this.createTableSkeleton(a.rows||5,a.columns||6):`<div class="table-skeleton">${this.createTableSkeleton(a.rows||5,a.columns||6)}</div>`;break;case"dashboard":o=this.createDashboardSkeleton();break;case"ranking":o=this.createRankingSkeleton(a.items||10);break;case"form":o=this.createFormSkeleton(a.fields||6);break;case"cards":o=this.createCardSkeleton(a.count||3);break;default:o='<div class="skeleton skeleton-text"></div>'}n.innerHTML=o,n.classList.add("skeleton-loading")},hide:e=>{const t=document.getElementById(e);t&&t.classList.remove("skeleton-loading")}};function showLoader(e="Memuat data...",t=!1,a=null,n="table",o={}){t&&a&&SkeletonLoader.show(a,n,o)}function hideLoader(e=null){const t=document.getElementById("loadingOverlay");if(t){t.style.display="none";const e=t.querySelector(".loading-text");e&&e.remove()}e&&SkeletonLoader.hide(e)}function renderTableWithSkeleton(e,t,a,n=!0){const o=document.getElementById(e);o&&(n&&t.length>0?(SkeletonLoader.show(e,"table",{rows:Math.min(t.length,10),columns:o.parentElement.querySelectorAll("th").length}),setTimeout(()=>{a(t),SkeletonLoader.hide(e)},500)):a(t))}function showNotification(e,t="info",a=4e3,n=!1){"error"===t&&(e.includes("Kode Aplikasi tidak ditemukan")||e.includes("tidak ditemukan"))||console["error"===t?"error":"log"](`[${t.toUpperCase()}] ${e}`);let o=document.getElementById("toast-container");o||(o=document.createElement("div"),o.id="toast-container",o.style.cssText="\n            position: fixed;\n            top: 20px;\n            right: 20px;\n            z-index: 10000;\n            display: flex;\n            flex-direction: column;\n            gap: 10px;\n            pointer-events: none;\n        ",document.body.appendChild(o));const i=document.createElement("div"),s="toast-"+Date.now();i.id=s,i.className=`toast toast-${t}`;const r={success:"✅",error:"❌",warning:"⚠️",info:"ℹ️"},l={success:{bg:"#28a745",border:"#1e7e34"},error:{bg:"#dc3545",border:"#c82333"},warning:{bg:"#ffc107",border:"#e0a800",text:"#212529"},info:{bg:"#17a2b8",border:"#117a8b"}},d=l[t]||l.info;i.innerHTML=`\n        <div style="display: flex; align-items: center; gap: 10px;">\n            <span style="font-size: 16px;">${r[t]||r.info}</span>\n            <span style="flex: 1;">${e}</span>\n            <button onclick="document.getElementById('${s}').remove()" style="\n                background: none;\n                border: none;\n                color: inherit;\n                cursor: pointer;\n                font-size: 18px;\n                padding: 0;\n                width: 20px;\n                height: 20px;\n                display: flex;\n                align-items: center;\n                justify-content: center;\n            ">×</button>\n        </div>\n    `,i.style.cssText=`\n        background: ${d.bg};\n        color: ${d.text||"#ffffff"};\n        border: 2px solid ${d.border};\n        border-radius: 6px;\n        padding: 12px 16px;\n        box-shadow: 0 4px 12px rgba(0,0,0,0.15);\n        min-width: 300px;\n        max-width: 400px;\n        font-family: 'Poppins', sans-serif;\n        font-size: 14px;\n        font-weight: 500;\n        transform: translateX(100%);\n        transition: transform 0.3s ease;\n        pointer-events: auto;\n        word-wrap: break-word;\n    `,o.appendChild(i),setTimeout(()=>{i.style.transform="translateX(0)"},100),setTimeout(()=>{document.getElementById(s)&&(i.style.transform="translateX(100%)",setTimeout(()=>{i&&i.parentNode&&i.remove()},300))},a)}const originalRenderSekolahTable=window.renderSekolahTable;function showDashboardSkeleton(){const e=document.querySelector("#dashboardSection .dashboard-grid");e&&SkeletonLoader.show(e.id||"dashboardContent","dashboard")}function hideDashboardSkeleton(){const e=document.querySelector("#dashboardSection .dashboard-grid");e&&SkeletonLoader.hide(e.id||"dashboardContent")}originalRenderSekolahTable&&(window.renderSekolahTable=function(e=null){document.getElementById("sekolahTableBody")&&e&&e.length>0?(SkeletonLoader.show("sekolahTableBody","table",{rows:Math.min(e.length,10),columns:7}),setTimeout(()=>{originalRenderSekolahTable(e),SkeletonLoader.hide("sekolahTableBody")},300)):originalRenderSekolahTable(e)});const ErrorHandler={errorMessages:{network:{title:"Koneksi Bermasalah",message:"Tidak dapat terhubung ke server. Periksa koneksi internet Anda.",icon:"🌐",retry:!0},timeout:{title:"Waktu Habis",message:"Server membutuhkan waktu terlalu lama untuk merespons.",icon:"⏱️",retry:!0},server:{title:"Kesalahan Server",message:"Terjadi kesalahan di server. Tim teknis kami akan segera memperbaikinya.",icon:"🔧",retry:!1},notfound:{title:"Data Tidak Ditemukan",message:"Data yang Anda cari tidak ditemukan atau telah dihapus.",icon:"🔍",retry:!1},validation:{title:"Data Tidak Valid",message:"Mohon periksa kembali data yang Anda masukkan.",icon:"⚠️",retry:!1},permission:{title:"Akses Ditolak",message:"Anda tidak memiliki izin untuk melakukan tindakan ini.",icon:"🔒",retry:!1},duplicate:{title:"Data Sudah Ada",message:"Data yang sama sudah ada dalam sistem.",icon:"📋",retry:!1}},showError:(e,t=null,a=null,n=null)=>{const o=ErrorHandler.errorMessages[e]||ErrorHandler.errorMessages.server,i=t||o.message;a?ErrorHandler.showErrorInContainer(a,o.title,i,o.icon,n,o.retry):showNotification(`${o.icon} ${o.title}: ${i}`,"error",5e3)},showErrorInContainer:(e,t,a,n,o=null,i=!1)=>{const s=document.getElementById(e);if(!s)return;const r=i&&o?`<button class="retry-btn" onclick="(${o.toString()})()">\n                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">\n                    <polyline points="23 4 23 10 17 10"></polyline>\n                    <path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"></path>\n                </svg>\n                Coba Lagi\n            </button>`:"";s.innerHTML=`\n            <div class="error-state">\n                <div class="error-state-icon">${n}</div>\n                <div class="error-state-title">${t}</div>\n                <div class="error-state-message">${a}</div>\n                <div class="error-state-actions">\n                    ${r}\n                </div>\n            </div>\n        `},showConnectionError:(e,t=null)=>{const a=document.getElementById(e);if(!a)return;const n=t?`<button class="retry-btn" onclick="(${t.toString()})()">\n                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">\n                    <polyline points="23 4 23 10 17 10"></polyline>\n                    <path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"></path>\n                </svg>\n                Coba Lagi\n            </button>`:"";a.innerHTML=`\n            <div class="connection-error">\n                <div class="connection-error-icon">📡</div>\n                <div class="connection-error-title">Tidak Ada Koneksi</div>\n                <div class="connection-error-message">\n                    Periksa koneksi internet Anda dan coba lagi.\n                </div>\n                <div class="connection-error-actions">\n                    ${n}\n                </div>\n            </div>\n        `},showEmptyState:(e,t,a,n=null,o=null)=>{const i=document.getElementById(e);if(!i)return;const s=n&&o?`<button class="btn btn-primary" onclick="(${o.toString()})()">\n                ${n}\n            </button>`:"";i.innerHTML=`\n            <div class="empty-state">\n                <div class="empty-state-icon">📭</div>\n                <div class="empty-state-title">${t}</div>\n                <div class="empty-state-message">${a}</div>\n                <div class="empty-state-actions">\n                    ${s}\n                </div>\n            </div>\n        `},handleApiError:(e,t="",a=null,n=null)=>{console.error(`API Error in ${t}:`,e);let o="server",i=null;"TypeError"===e.name&&e.message.includes("fetch")?o="network":e.message.includes("timeout")||e.message.includes("TimeoutError")?o="timeout":e.message.includes("404")||e.message.includes("Not Found")?o="notfound":e.message.includes("400")||e.message.includes("validation")?o="validation":e.message.includes("403")||e.message.includes("Forbidden")?o="permission":e.message.includes("409")||e.message.includes("duplicate")?o="duplicate":e.message.includes("500")&&(o="server",i="Server sedang mengalami gangguan. Tim teknis telah diberitahu."),ErrorHandler.showError(o,i,n,a)},validateField:(e,t={})=>{const a=document.getElementById(e);if(!a)return!0;const n=a.value.trim(),o=[];a.classList.remove("input-error");const i=a.parentNode.querySelector(".field-error");if(i&&i.remove(),t.required&&!n&&o.push("Field ini wajib diisi."),t.minLength&&n.length<t.minLength&&o.push(`Minimal ${t.minLength} karakter.`),t.email&&n&&!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(n)&&o.push("Format email tidak valid."),t.numeric&&n&&!/^\d+$/.test(n)&&o.push("Hanya boleh angka."),t.nisn&&n&&!/^\d{10}$/.test(n)&&o.push("NISN harus 10 digit angka."),o.length>0){a.classList.add("input-error");const e=document.createElement("div");return e.className="field-error",e.innerHTML=`<span>⚠️</span> ${o.join(" ")}`,a.parentNode.insertBefore(e,a.nextSibling),!1}return!0},clearFormErrors:e=>{const t=document.getElementById(e);t&&(t.querySelectorAll(".input-error").forEach(e=>{e.classList.remove("input-error")}),t.querySelectorAll(".field-error").forEach(e=>{e.remove()}),t.querySelectorAll(".form-error").forEach(e=>{e.remove()}))},showFormError:(e,t)=>{const a=document.getElementById(e);if(!a)return;a.querySelectorAll(".form-error").forEach(e=>e.remove());const n=document.createElement("div");n.className="form-error",n.innerHTML=`\n            <span class="form-error-icon">⚠️</span>\n            ${t}\n        `,a.insertBefore(n,a.firstChild)}};async function fetchWithErrorHandling(e,t={},a=""){try{const a=setTimeout(()=>{throw new Error("Request timeout")},t.timeout||15e3),n=await fetch(e,{...t,headers:{"Content-Type":"application/json",...t.headers}});if(clearTimeout(a),!n.ok)throw new Error(`HTTP ${n.status}: ${n.statusText}`);return await n.json()}catch(e){if("AbortError"===e.name)throw new Error("Request was cancelled");throw e}}function setupSiswaAdminModal(){const e=document.getElementById("btnTambahSiswa"),t=document.getElementById("closeSiswaAdminModalBtn"),a=document.getElementById("siswaAdminForm");e&&e.addEventListener("click",()=>{openEditModal(null)}),t&&t.addEventListener("click",closeSiswaAdminModal),a&&a.addEventListener("submit",handleSiswaAdminSubmit),window.addEventListener("click",e=>{const t=document.getElementById("siswaAdminModal");e.target===t&&closeSiswaAdminModal()})}function fillSiswaForm(e){if(!e||!Array.isArray(e))return void console.error("Invalid data passed to fillSiswaForm:",e);[{id:"editKodeBiasa",value:e[0],label:"Kode Biasa"},{id:"editKodePro",value:e[1],label:"Kode Pro"},{id:"editNamaSekolah",value:e[2],label:"Nama Sekolah"},{id:"editKecamatanSiswa",value:e[3],label:"Kecamatan"},{id:"editNoUrut",value:e[4],label:"No Urut"},{id:"editNoInduk",value:e[5],label:"No Induk"},{id:"editNisn",value:e[6],label:"NISN"},{id:"editNamaPeserta",value:e[7],label:"Nama Peserta"},{id:"editTtl",value:e[8],label:"TTL"},{id:"editNamaOrtu",value:e[9],label:"Nama Orang Tua"},{id:"editNoIjazah",value:e[10],label:"No Ijazah"}].forEach(e=>{const t=document.getElementById(e.id);t?t.value=e.value||"":console.error(`Element ${e.id} not found for ${e.label}`)}),document.getElementById("originalNisn").value=e[7]}function handleSiswaAdminSubmit(e){e.preventDefault();const t=document.getElementById("siswaAdminModalMode").value,a=collectSiswaFormData();validateSiswaData(a)&&("add"===t?addNewSiswa(a):"edit"===t&&updateSiswa(a))}function collectSiswaFormData(){return{kodeBiasa:document.getElementById("siswaKodeBiasa").value.trim(),kodePro:document.getElementById("siswaKodePro").value.trim(),namaSekolah:document.getElementById("siswaNamaSekolah").value.trim(),kecamatan:document.getElementById("siswaKecamatan").value.trim(),noUrut:document.getElementById("siswaNoUrut").value.trim(),noInduk:document.getElementById("siswaNoInduk").value.trim(),nisn:document.getElementById("siswaNisn").value.trim(),namaPeserta:document.getElementById("siswaNamaPeserta").value.trim(),tempatTglLahir:document.getElementById("siswaTempatTglLahir").value.trim(),namaOrtu:document.getElementById("siswaNamaOrtu").value.trim(),noIjazah:document.getElementById("siswaNoIjazah").value.trim()}}function validateSiswaData(e){return!!(e.kodeBiasa&&e.noInduk&&e.nisn&&e.namaPeserta)||(showNotification("Mohon lengkapi data yang wajib diisi","error"),!1)}async function addNewSiswa(e){try{const t=[e.kodeBiasa,e.kodePro,e.namaSekolah,e.kecamatan,parseInt(e.noUrut)||(database.siswa?database.siswa.length+1:1),e.noInduk,e.nisn,e.namaPeserta,e.tempatTglLahir,e.namaOrtu,e.noIjazah],a=await fetchWithAuth(apiUrl("/api/data/siswa/save"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({mode:"add",siswaData:t})});if(!a.success)throw new Error(a.message||"Gagal menyimpan data siswa");database&&database.siswa&&database.siswa.push(t),updateAdminCounters(),"function"==typeof renderAdminSiswaTable&&renderAdminSiswaTable(),refreshSiswaSearchData(),closeSiswaAdminModal(),showNotification("Data siswa berhasil ditambahkan","success")}catch(e){console.error("Error adding student:",e),showNotification("Gagal menambahkan data siswa: "+e.message,"error")}}async function updateSiswa(e){try{const t=document.getElementById("originalSiswaIndex").value,a=[e.kodeBiasa,e.kodePro,e.namaSekolah,e.kecamatan,parseInt(e.noUrut)||1,e.noInduk,e.nisn,e.namaPeserta,e.tempatTglLahir,e.namaOrtu,e.noIjazah],n=await fetchWithAuth(apiUrl("/api/data/siswa/save"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({mode:"edit",siswaData:a,originalNisn:t})});if(!n.success)throw new Error(n.message||"Gagal memperbarui data siswa");if(database&&database.siswa){const e=database.siswa.findIndex(e=>e[6]===t);-1!==e&&(database.siswa[e]=a)}"function"==typeof renderAdminTable&&renderAdminTable("siswa"),closeSiswaAdminModal(),showNotification("Data siswa berhasil diperbarui","success")}catch(e){console.error("Error updating student:",e),showNotification("Gagal memperbarui data siswa: "+e.message,"error")}}async function handleDeleteSiswa(e,t){if(confirm(`Apakah Anda yakin ingin menghapus siswa "${t}" (NISN: ${e})?\n\nData siswa dan semua nilai terkait akan dihapus secara permanen.`))try{const a=await fetchWithAuth(apiUrl("/api/data/siswa/delete"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({nisn:e})});if(!a.success)throw new Error(a.message||"Gagal menghapus siswa");database&&database.siswa&&(database.siswa=database.siswa.filter(t=>t[7]!==e)),updateAdminCounters(),"function"==typeof renderAdminTable&&renderAdminTable("siswa"),showNotification(`Siswa "${t}" berhasil dihapus`,"success")}catch(e){console.error("Error deleting student:",e),showNotification("Gagal menghapus siswa: "+e.message,"error")}}function setupTableSorting(){document.addEventListener("click",e=>{const t=e.target.closest("th.sortable");if(t){e.preventDefault();const a=t.getAttribute("data-table-id"),n=parseInt(t.getAttribute("data-key-index")),o=t.getAttribute("data-key-type");a&&null!==n&&o&&(handleSort(a,n,o),updateSortHeaders(a),rerenderActiveTable(a))}})}function rerenderActiveTable(e){switch(e){case"sekolah":"function"==typeof renderAdminTable&&renderAdminTable("sekolah");break;case"siswa":"function"==typeof renderAdminTable&&renderAdminTable("siswa");break;case"rekapNilai":"function"==typeof renderRekapNilai&&renderRekapNilai();break;case"isiNilai":const t=paginationState.isiNilai?.currentSemester,a=paginationState.isiNilai?.currentSemesterName;t&&a&&"function"==typeof renderIsiNilaiPage&&renderIsiNilaiPage(t,a);break;case"sekolahSiswa":"function"==typeof renderProfilSiswa&&renderProfilSiswa();break;case"transkripNilai":"function"==typeof renderTranskripSiswaTable&&renderTranskripSiswaTable();break;case"skl":"function"==typeof renderSklSiswaTable&&renderSklSiswaTable();break;case"skkb":"function"==typeof renderSkkbSiswaTable&&renderSkkbSiswaTable();break;case"cetakGabungan":"function"==typeof renderCetakGabunganPage&&renderCetakGabunganPage();break;default:!e.includes("dashboard")&&e.includes("Section")}}function setupPaginationControls(){document.addEventListener("change",e=>{if(e.target.classList.contains("rows-per-page")){const t=e.target.closest(".pagination-controls");if(t){const a=t.getAttribute("data-table-id");a&&paginationState[a]&&(paginationState[a].rowsPerPage=e.target.value,paginationState[a].currentPage=1,rerenderActiveTable(a))}}}),document.addEventListener("click",e=>{if(e.target.classList.contains("prev-page")){const t=e.target.closest(".pagination-controls");if(t){const e=t.getAttribute("data-table-id");e&&paginationState[e]&&paginationState[e].currentPage>1&&(paginationState[e].currentPage--,rerenderActiveTable(e))}}if(e.target.classList.contains("next-page")){const t=e.target.closest(".pagination-controls");if(t){const e=t.getAttribute("data-table-id");if(e&&paginationState[e]){const t=paginationState[e],a=getCurrentTableData(e);if(a){const n=a.length,o="all"===t.rowsPerPage?n:parseInt(t.rowsPerPage),i=o>0?Math.ceil(n/o):1;t.currentPage<i&&(t.currentPage++,rerenderActiveTable(e))}}}}})}function formatToProperCase(e){return e&&"string"==typeof e?e.toLowerCase().split(" ").map(e=>0===e.length?e:e.charAt(0).toUpperCase()+e.slice(1)).join(" "):e||""}function validateIjazahInput(e){const t=e.value,a=t.replace(/\D/g,"").substring(0,15);t!==a&&(showSmartNotification("Hanya angka yang diperbolehkan untuk Nomor Ijazah.","warning","validasi no ijazah"),e.value=a),""===t||/^\d{15}$/.test(e.value)?e.classList.remove("invalid-input"):e.classList.add("invalid-input")}function checkDuplicateIjazah(e,t){if(""===e)return!1;for(let a=0;a<database.siswa.length;a++)if(a!==t&&database.siswa[a][10]===e)return!0;return!1}function validateIjazahOnBlur(e){const t=e.value;""===t||/^\d{15}$/.test(t)||showSmartNotification("Nomor Ijazah harus berupa 15 digit angka. Harap perbaiki sebelum menyimpan.","warning","validasi no ijazah")}function getCurrentTableData(e){switch(e){case"sekolah":return database?.sekolah||[];case"siswa":return database?.siswa||[];case"rekapNilai":case"isiNilai":case"sekolahSiswa":case"transkripNilai":case"skl":case"skkb":case"cetakGabungan":if(window.currentUser?.schoolData){const e=String(window.currentUser.schoolData[0]);return database?.siswa?.filter(t=>String(t[0])===e)||[]}return[];default:return[]}}function updateBackupStatus(e,t){const a=document.getElementById("statusIndicator"),n=document.getElementById("statusText");a&&(a.textContent=e),n&&(n.textContent=t)}function showModernBackupProgress(){const e=document.getElementById("backupProgress"),t=document.getElementById("backupStats");e&&(e.style.display="block",e.classList.add("show")),t&&(t.style.display="block",updateBackupStats())}function hideBackupProgress(){const e=document.getElementById("backupProgress");e&&(e.classList.remove("show"),setTimeout(()=>{e.style.display="none"},300))}function showBackupSuccess(){const e=document.getElementById("backupBtn"),t=document.getElementById("backupBtnText");e&&t&&(e.classList.remove("loading"),e.classList.add("success"),t.textContent="✓ Backup Berhasil",updateBackupStatus("🟢","Backup berhasil dibuat"),setTimeout(()=>{e.classList.remove("success"),e.disabled=!1,t.textContent="Download Backup"},3e3))}function showBackupError(e){const t=document.getElementById("backupBtn"),a=document.getElementById("backupBtnText");t&&a&&(t.classList.remove("loading"),t.classList.add("error"),a.textContent="✗ Backup Gagal",updateBackupStatus("🔴","Backup gagal: "+e),setTimeout(()=>{t.classList.remove("error"),t.disabled=!1,a.textContent="Download Backup"},5e3)),hideBackupProgress()}function updateBackupStats(){if(!database||!window.currentUser?.schoolData)return;const e=String(window.currentUser.schoolData[0]),t=database.siswa?database.siswa.filter(t=>String(t[0])===e).length:0,a=database.nilai?Object.keys(database.nilai).length:0,n=database.semester?database.semester.length:0,o=document.getElementById("totalSekolah"),i=document.getElementById("totalSiswa"),s=document.getElementById("totalNilai"),r=document.getElementById("totalSemester");o&&(o.textContent="1"),i&&(i.textContent=t),s&&(s.textContent=a),r&&(r.textContent=n)}function showModernRestoreProgress(){const e=document.getElementById("restoreProgress");e&&(e.style.display="block",e.classList.add("show"))}function hideRestoreProgress(){const e=document.getElementById("restoreProgress");e&&(e.classList.remove("show"),setTimeout(()=>{e.style.display="none"},300))}function showRestoreSuccess(){const e=document.getElementById("restoreBtn"),t=document.getElementById("restoreBtnText");e&&t&&(e.classList.remove("loading"),e.classList.add("success"),t.textContent="✓ Restore Berhasil",setTimeout(()=>{e.classList.remove("success"),e.disabled=!1,t.textContent="Pilih File Untuk Restore"},3e3))}function showRestoreError(e){const t=document.getElementById("restoreBtn"),a=document.getElementById("restoreBtnText");t&&a&&(t.classList.remove("loading"),t.classList.add("error"),a.textContent="✗ Restore Gagal",setTimeout(()=>{t.classList.remove("error"),t.disabled=!1,a.textContent="Pilih File Untuk Restore"},5e3)),hideRestoreProgress()}async function handleModernBackup(){if("sekolah"!==window.currentUser.role||!window.currentUser.schoolData)return void showNotification("Akses ditolak: Hanya sekolah yang dapat membuat backup","error");const e=document.getElementById("backupBtn"),t=document.getElementById("backupBtnText");e.classList.add("loading"),e.disabled=!0,t.textContent="Memproses...",showModernBackupProgress(),updateBackupStatus("🟡","Sedang memproses backup...");try{updateBackupProgress(10,"Mempersiapkan data backup...");const e=String(window.currentUser.schoolData[0]),t=(window.currentUser.schoolData[5]||"sekolah").replace(/ /g,"_");updateBackupProgress(25,"Mengumpulkan data sekolah...");const a={appVersion:"2.6-server",backupDate:(new Date).toISOString(),schoolCode:e,schoolName:window.currentUser.schoolData[4],siswa:database.siswa.filter(t=>String(t[0])===e),nilai:{},settings:database.settings&&database.settings[e]||{},sklPhotos:{},mulokNames:database.nilai&&database.nilai._mulokNames&&database.nilai._mulokNames[e]||{}};updateBackupProgress(40,"Mengumpulkan data siswa...");const n=new Set(a.siswa.map(e=>e[7]));let o=0;const i=n.size;updateBackupProgress(50,"Mengumpulkan data nilai dan foto...");for(const e of n)if(database.nilai&&database.nilai[e]&&(a.nilai[e]=database.nilai[e]),database.sklPhotos&&database.sklPhotos[e]&&(a.sklPhotos[e]=database.sklPhotos[e]),o++,o%50==0||o===i){updateBackupProgress(50+Math.floor(o/i*30),`Memproses data siswa ${o}/${i}...`),await new Promise(e=>setTimeout(e,1))}if(updateBackupProgress(85,"Membuat file backup..."),0===a.siswa.length)throw new Error("Tidak ada data siswa untuk di-backup.");await new Promise(e=>setTimeout(e,100));const s=JSON.stringify(a,null,2),r=new Blob([s],{type:"application/json"});updateBackupProgress(95,"Menyiapkan unduhan...");const l=(new Date).toISOString().slice(0,10),d=`backup_${t}_${l}_${(new Date).toTimeString().slice(0,5).replace(":","-")}.json`,c=URL.createObjectURL(r),u=document.createElement("a");u.href=c,u.download=d,u.style.display="none",document.body.appendChild(u),u.click(),document.body.removeChild(u),URL.revokeObjectURL(c),updateBackupProgress(100,"Backup selesai!"),showNotification("Backup berhasil diunduh!","success"),setTimeout(()=>{hideBackupProgress(),showBackupSuccess()},500),window.auditManager&&window.auditManager.log("backup_success","backup",{fileName:d,siswaCount:a.siswa.length,nilaiCount:Object.keys(a.nilai).length})}catch(e){console.error("Backup failed:",e),showBackupError(e.message),showNotification("Backup gagal: "+e.message,"error"),window.auditManager&&window.auditManager.log("backup_failed","backup",{error:e.message})}}async function handleModernRestore(e){const t=e.target.files[0];if(!t)return;if(document.getElementById("restoreProgress")?.classList.contains("show"))return;const a=document.getElementById("restoreBtn"),n=document.getElementById("restoreBtnText");a.classList.add("loading"),a.disabled=!0,n.textContent="Memproses...",showModernRestoreProgress();const o=new FileReader;o.onload=async o=>{try{updateRestoreProgress(10,"Membaca file backup...");const t=JSON.parse(o.target.result);if(updateRestoreProgress(25,"Memvalidasi file backup..."),!t.schoolCode||!t.siswa)throw new Error("Format file backup tidak valid");if(!Array.isArray(t.siswa)||0===t.siswa.length)throw new Error("File backup tidak mengandung data siswa");updateRestoreProgress(40,"Memverifikasi kompatibilitas...");const i=`Restore backup dari ${new Date(t.backupDate).toLocaleString()}?\n\nData yang akan di-restore:\n- ${t.siswa.length} siswa\n- ${Object.keys(t.nilai||{}).length} nilai\n- ${Object.keys(t.sklPhotos||{}).length} foto\n\n⚠️ PERINGATAN: Semua data saat ini akan diganti!`;if(!confirm(i))return hideRestoreProgress(),a.classList.remove("loading"),a.disabled=!1,void(n.textContent="Pilih File Untuk Restore");updateRestoreProgress(60,"Membackup data saat ini..."),window.BackupManager&&await window.BackupManager.createBackup("pre_restore"),updateRestoreProgress(75,"Mengembalikan data...");const s=String(window.currentUser.schoolData[0]);t.siswa&&(database.siswa=database.siswa.filter(e=>String(e[0])!==s),database.siswa.push(...t.siswa),refreshSiswaSearchData()),t.nilai&&Object.assign(database.nilai,t.nilai),t.sklPhotos&&Object.assign(database.sklPhotos,t.sklPhotos),t.settings&&(database.settings||(database.settings={}),database.settings[s]=t.settings),t.mulokNames&&(database.nilai._mulokNames||(database.nilai._mulokNames={}),database.nilai._mulokNames[s]=t.mulokNames),updateRestoreProgress(90,"Menyinkronkan interface...");try{localStorage.setItem("database",JSON.stringify(database))}catch(e){}"function"==typeof renderProfilSiswa&&renderProfilSiswa(),"function"==typeof renderAdminTable&&renderAdminTable("siswa"),updateRestoreProgress(100,"Restore selesai!"),e.target.value="",setTimeout(()=>{hideRestoreProgress(),showRestoreSuccess()},500),showNotification("Data berhasil direstore!","success"),window.auditManager&&window.auditManager.log("restore_success","backup",{backupDate:t.backupDate,siswaCount:t.siswa.length,nilaiCount:Object.keys(t.nilai||{}).length})}catch(e){console.error("Restore failed:",e),showRestoreError(e.message),showNotification("Restore gagal: "+e.message,"error"),window.auditManager&&window.auditManager.log("restore_failed","backup",{error:e.message,fileName:t.name})}},o.onerror=()=>{showRestoreError("Gagal membaca file backup"),showNotification("Gagal membaca file backup","error")},o.readAsText(t)}function openSiswaAdminModal(e,t=null){const a=document.getElementById("siswaAdminModal"),n=document.getElementById("siswaAdminModalTitle"),o=document.getElementById("siswaAdminModalMode");a&&n&&o&&(o.value=e,"edit"===e&&t&&(n.innerHTML='\n            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">\n                <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>\n                <circle cx="12" cy="7" r="4"></circle>\n            </svg>\n            Edit Data Siswa\n        ',document.getElementById("editKodeBiasa").value=t[0]||"",document.getElementById("editKodePro").value=t[1]||"",document.getElementById("editNamaSekolah").value=t[2]||"",document.getElementById("editKecamatanSiswa").value=t[3]||"",document.getElementById("editNoUrut").value=t[4]||"",document.getElementById("editNoInduk").value=t[5]||"",document.getElementById("adminEditNoPeserta").value="",document.getElementById("adminEditNisn").value=t[7]||"",document.getElementById("adminEditNamaPeserta").value=t[8]||"",document.getElementById("editTtl").value=t[9]||"",document.getElementById("adminEditNamaOrtu").value=t[10]||"",document.getElementById("editNoIjazah").value=t[11]||"",document.getElementById("originalNisn").value=t[7]||""),a.style.display="flex")}function closeSiswaAdminModal(){const e=document.getElementById("siswaAdminModal"),t=document.getElementById("siswaAdminForm");e&&(e.style.display="none"),t&&t.reset()}async function handleSiswaAdminSubmit(e){e.preventDefault();const t=document.getElementById("siswaAdminModalMode").value,a=document.getElementById("originalNisn").value;if("edit"===t&&!a)return void showNotification("Error: NISN original tidak ditemukan. Silakan tutup modal dan coba lagi.","error");const n={kodeBiasa:document.getElementById("editKodeBiasa").value.trim(),kodePro:document.getElementById("editKodePro").value.trim(),namaSekolah:document.getElementById("editNamaSekolah").value.trim(),kecamatan:document.getElementById("editKecamatanSiswa").value.trim(),noUrut:document.getElementById("editNoUrut").value.trim(),noInduk:document.getElementById("editNoInduk").value.trim(),noPeserta:"",nisn:document.getElementById("adminEditNisn").value.trim(),namaPeserta:document.getElementById("adminEditNamaPeserta").value.trim(),ttl:document.getElementById("editTtl").value.trim(),namaOrtu:document.getElementById("adminEditNamaOrtu").value.trim(),noIjazah:document.getElementById("editNoIjazah").value.trim()||""},o=[{key:"kodeBiasa",label:"Kode Biasa"},{key:"kodePro",label:"Kode PRO"},{key:"namaSekolah",label:"Nama Sekolah"},{key:"kecamatan",label:"Kecamatan"},{key:"noUrut",label:"No Urut"},{key:"noInduk",label:"No Induk"},{key:"nisn",label:"NISN"},{key:"namaPeserta",label:"Nama Peserta"},{key:"ttl",label:"Tempat & Tanggal Lahir"},{key:"namaOrtu",label:"Nama Orang Tua"}].filter(e=>!n[e.key]);if(o.length>0){return void showNotification(`Field berikut wajib diisi: ${o.map(e=>e.label).join(", ")}`,"warning")}try{let e;if(showLoader(),"edit"===t){const t={originalNisn:a,...n};e=await fetchWithAuth(apiUrl("/api/data/siswa/update-admin"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)})}else e=await fetchWithAuth(apiUrl("/api/data/siswa/add"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(n)});if(!e.success)throw new Error(e.message||"Gagal memperbarui data siswa");if("edit"===t){const e=database.siswa.findIndex(e=>e[6]===a);-1!==e&&(database.siswa[e]=[n.kodeBiasa,n.kodePro,n.namaSekolah,n.kecamatan,n.noUrut,n.noInduk,n.nisn,n.namaPeserta,n.ttl,n.namaOrtu,n.noIjazah,database.siswa[e][11]])}else database.siswa.push([n.kodeBiasa,n.kodePro,n.namaSekolah,n.kecamatan,n.noUrut,n.noInduk,n.nisn,n.namaPeserta,n.ttl,n.namaOrtu,n.noIjazah,null]);"function"==typeof renderAdminTable&&renderAdminTable("siswa"),refreshSiswaSearchData(),closeSiswaAdminModal(),showNotification("Data siswa berhasil diperbarui","success")}catch(e){console.error("Error updating student:",e),showNotification("Gagal memperbarui data siswa: "+e.message,"error")}finally{hideLoader()}}function openPhotoModal(e,t){const a=document.getElementById("photoModal"),n=document.getElementById("photoModalImage"),o=document.getElementById("photoModalNama"),i=document.getElementById("photoModalNisn");if(!(a&&n&&o&&i))return;const s=database.sklPhotos&&database.sklPhotos[e];s?(n.src=s,o.textContent=t||"Tidak diketahui",i.textContent=e||"Tidak diketahui",a.style.display="flex",setTimeout(()=>{a.classList.add("show")},10)):showNotification("Foto tidak ditemukan","warning")}function closePhotoModal(){const e=document.getElementById("photoModal");e&&(e.classList.remove("show"),setTimeout(()=>{e.style.display="none"},300))}function renderInfoTerbaru(){const e=document.getElementById("infoTerbaruList");e?(e.innerHTML='<div style="text-align: center; padding: 40px; color: #6b7280;"><div style="margin-bottom: 12px;">⏳</div><p style="margin: 0;">Memuat pengumuman...</p></div>',fetchInfoTerbaruData()):console.error("Info list container not found")}async function fetchInfoTerbaruData(){try{const e=localStorage.getItem("jwtToken");if(!e)return void showFallbackMessage();const t=await fetch("/api/notifications",{headers:{Authorization:`Bearer ${e}`,"Content-Type":"application/json"}});if(!t.ok)throw new Error("Failed to fetch");const a=await t.json();a.success&&a.data&&a.data.length>0?renderInfoFeed(a.data):showFallbackMessage()}catch(e){console.error("Error fetching info:",e),showErrorMessage()}}function renderInfoFeed(e){const t=document.getElementById("infoTerbaruList");if(!t)return;const a=e.map((e,t)=>{const a=new Date(e.created_at),n=0===t;return`\n            <div style="padding: 20px; border-bottom: 1px solid #f3f4f6; ${n?"background: #fefefe;":""}">\n                <div style="display: flex; align-items: flex-start; gap: 12px;">\n                    <div style="flex-shrink: 0; width: 40px; height: 40px; background: #3b82f6; border-radius: 50%; display: flex; align-items: center; justify-content: center;">\n                        <svg width="20" height="20" viewBox="0 0 24 24" fill="white">\n                            <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path>\n                            <polyline points="22,6 12,13 2,6" stroke="white" stroke-width="2" fill="none"></polyline>\n                        </svg>\n                    </div>\n                    <div style="flex: 1; min-width: 0;">\n                        <div style="display: flex; align-items: center; gap: 16px; margin-bottom: 8px;">\n                            <span style="font-size: 14px; color: #3b82f6; font-weight: 500;">Admin</span>\n                            <span style="font-size: 13px; color: #6b7280;">\n                                ${a.toLocaleDateString("id-ID",{timeZone:"Asia/Jakarta"})} ${a.toLocaleTimeString("id-ID",{hour:"2-digit",minute:"2-digit",timeZone:"Asia/Jakarta"})} WIB\n                            </span>\n                            ${n?'<span style="background: #16a34a; color: white; padding: 2px 8px; border-radius: 10px; font-size: 11px;">Terbaru</span>':""}\n                        </div>\n                        <p style="margin: 0; font-size: 14px; color: #4b5563; line-height: 1.5;">\n                            ${e.message}\n                        </p>\n                    </div>\n                </div>\n            </div>\n        `}).join("");t.innerHTML=a}function showFallbackMessage(){const e=document.getElementById("infoTerbaruList");e&&(e.innerHTML='\n            <div style="text-align: center; padding: 40px; color: #6b7280;">\n                <div style="margin-bottom: 12px;">📄</div>\n                <p style="margin: 0;">Belum ada pengumuman terbaru dari admin.</p>\n            </div>\n        ')}function showErrorMessage(){const e=document.getElementById("infoTerbaruList");e&&(e.innerHTML='\n            <div style="text-align: center; padding: 40px; color: #ef4444;">\n                <div style="margin-bottom: 12px;">⚠️</div>\n                <p style="margin: 0;">Gagal memuat pengumuman. Silakan refresh halaman.</p>\n            </div>\n        ')}async function handleChangeAdminCode(e){e.preventDefault();const t=new FormData(e.target).get("newLoginCode");if(!t||t.trim().length<3)return void showNotification("Kode login baru minimal 3 karakter","error");const a=e.target.querySelector('button[type="submit"]'),n=a.innerHTML;a.disabled=!0,a.innerHTML='\n        <svg class="animate-spin" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">\n            <path d="M21 12a9 9 0 11-6.219-8.56"/>\n        </svg>\n        Mengubah Kode...\n    ';try{const a=localStorage.getItem("jwtToken");if(!a)return showNotification("Anda belum login. Silakan login terlebih dahulu.","error"),void setTimeout(()=>{window.location.href="/"},2e3);const n=await fetch("/api/data/account/change-admin-code",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${a}`},body:JSON.stringify({newLoginCode:t.trim()})});if(401===n.status||403===n.status)return showNotification("Session telah berakhir. Silakan login ulang.","error"),localStorage.removeItem("jwtToken"),void setTimeout(()=>{window.location.href="/"},2e3);if(400===n.status){return void showNotification((await n.json()).message||"Gagal mengubah kode login","error")}if(!n.ok){const e=await n.text();return void showNotification(`Server error (${n.status}): ${e}`,"error")}const o=await n.json();o.success?(showNotification(o.message,"success"),addToActivityLog(`Admin berhasil mengubah kode login menjadi "${o.newLoginCode}".`),e.target.reset()):showNotification(o.message||"Gagal mengubah kode login","error")}catch(e){console.error("Change admin code error:",e),showNotification("Terjadi kesalahan saat mengubah kode login","error")}finally{a.disabled=!1,a.innerHTML=n}}function resetChangeAdminCodeForm(){const e=document.getElementById("changeAdminCodeForm");e&&e.reset()}function addToActivityLog(e){const t=document.querySelector(".activity-log");if(!t)return;const a=document.createElement("div");a.className="log-item";const n=new Date,o=`Hari ini, ${n.getHours().toString().padStart(2,"0")}:${n.getMinutes().toString().padStart(2,"0")}`;a.innerHTML=`\n        <div class="log-time">${o}</div>\n        <div class="log-action">${e}</div>\n    `,t.insertBefore(a,t.firstChild);const i=t.querySelectorAll(".log-item");if(i.length>5)for(let e=5;e<i.length;e++)i[e].remove()}function loadAccountInfo(){const e=localStorage.getItem("jwtToken");if(e)try{const t=JSON.parse(atob(e.split(".")[1])),a=document.getElementById("currentUsername");a&&(a.textContent=t.userIdentifier||"PRASETYA LUKMANA");const n=document.getElementById("currentRole");n&&(n.textContent=t.role||"Dinas Kab/Kota");const o=document.getElementById("lastLoginTime");if(o&&t.iat){const e=new Date(1e3*t.iat);o.textContent=e.toLocaleString("id-ID",{year:"numeric",month:"long",day:"numeric",hour:"2-digit",minute:"2-digit"})}}catch(e){console.error("Error decoding token:",e)}}async function checkForUpdatesManual(){try{if(window.updateChecker){const e=await window.updateChecker.manualCheck();e&&!e.updateAvailable&&showSmartNotification("Aplikasi sudah menggunakan versi terbaru!","success","update")}else showSmartNotification("Update checker belum siap, coba lagi sebentar...","warning","update")}catch(e){console.error("Error checking for updates:",e),showSmartNotification("Gagal memeriksa update. Periksa koneksi internet Anda.","error","update")}}function showAppVersion(){showSmartNotification("Aplikasi E-Ijazah v2.6.0","info","version")}async function showChangelog(){try{const e=await fetch("/api/updates/changelog");(await e.json()).success&&window.updateChecker&&showSmartNotification("Changelog dimuat. Lihat console untuk detail.","info","changelog")}catch(e){console.error("Error fetching changelog:",e),showSmartNotification("Gagal memuat changelog","error","changelog")}}function toggleUserDropdown(e){const t="admin"===e?"adminUserProfile":"sekolahUserProfile",a=document.getElementById(t);a&&(document.querySelectorAll(".user-profile-dropdown").forEach(e=>{e.id!==t&&e.classList.remove("active")}),a.classList.toggle("active"),a.classList.contains("active")&&updateUserProfileInfo(e))}function updateUserProfileInfo(e){if("admin"===e){const e=document.getElementById("adminUserName");e&&(e.textContent="Administrator")}else if("sekolah"===e){const e=document.getElementById("sekolahUserName"),t=document.getElementById("sekolahUserRole");if(e&&window.currentUser&&(e.textContent=window.currentUser.namaSekolah||"Sekolah"),t&&window.currentUser){const e=window.currentUser.loginType;t.textContent="pro"===e?"Kode Pro":"Kode Biasa"}}}function showUserProfile(e){toggleUserDropdown(e),"admin"===e?showNotification("Fitur profil admin akan segera tersedia","info"):"sekolah"===e&&(window.loginInfoModalShown=!1,showLoginInfoModal())}function showLoginInfo(e){toggleUserDropdown(e),window.loginInfoModalShown=!1,showLoginInfoModal()}function showAccountSettings(e){toggleUserDropdown(e),"admin"===e?switchContent("pengaturanAkun"):"sekolah"===e&&switchContentSekolah("settingSection")}function initializeUserProfile(){updateUserProfileInfo("admin"),updateUserProfileInfo("sekolah")}function toggleHeaderDropdown(){const e=document.getElementById("headerUserProfile");e&&(document.querySelectorAll(".user-profile-dropdown").forEach(e=>{"headerUserProfile"!==e.id&&e.classList.remove("active")}),e.classList.toggle("active"))}function toggleActionDropdown(e,t){e.stopPropagation();const a=document.getElementById(`dropdown-${t}`);if(!a)return void console.error("Dropdown not found for nisn:",t);const n=a.classList.contains("show");closeAllDropdowns(),n||a.classList.add("show")}function closeAllDropdowns(){document.querySelectorAll(".action-dropdown-content").forEach(e=>{e.classList.remove("show")})}function showUpgradePrompt(e){alert(`Fitur "${e}" hanya tersedia untuk Kode PRO.\n\nUpgrade ke Kode PRO untuk mendapatkan:\n✅ Edit Data Siswa\n✅ Upload & Hapus Foto Profil\n✅ Akses Penuh Semua Fitur\n\nHubungi admin untuk upgrade ke Kode PRO.`)}document.addEventListener("DOMContentLoaded",()=>{window.addEventListener("error",e=>{console.error("Global error:",e.error),ErrorHandler.handleApiError(e.error,"Global Error Handler")}),window.addEventListener("unhandledrejection",e=>{console.error("Unhandled promise rejection:",e.reason),ErrorHandler.handleApiError(e.reason,"Promise Rejection")}),setTimeout(()=>{},1e3),setupSiswaAdminModal()}),document.addEventListener("DOMContentLoaded",()=>{setupTableSorting(),setupPaginationControls()}),"loading"!==document.readyState&&(setupTableSorting(),setupPaginationControls()),document.addEventListener("DOMContentLoaded",function(){if(document.getElementById("backupBtn")){setTimeout(updateBackupStats,1e3);const e=document.getElementById("backupBtn"),t=document.getElementById("restoreInput");e&&(e.removeEventListener("click",handleBackup),e.addEventListener("click",handleModernBackup)),t&&(t.removeEventListener("change",handleRestore),t.addEventListener("change",handleModernRestore))}const e=document.querySelector(".menu-item[onclick*=\"showSection('aktivasiKodePro')\"]");function t(){if(!window.currentUser||!window.currentUser.schoolData||!window.currentUser.schoolData[4])return;const e=window.currentUser.schoolData[4];document.querySelectorAll(".school-name-top-row").forEach(e=>e.remove());document.querySelectorAll(".content-section").forEach(t=>{if(t.querySelector(".school-name-top-row"))return;const a=document.createElement("div");a.className="school-name-top-row";const n=document.createElement("div");n.className="e-ijazah-logo-container",n.innerHTML='\n                <div class="logo-wrapper">\n                    <img src="/assets/logo-e-ijazah.svg" alt="E-Ijazah Logo" class="e-ijazah-logo">\n                    <div class="logo-text">\n                        <h1>APLIKASI NILAI E-IJAZAH</h1>\n                        <p>Platform Pendidikan Digital Indonesia</p>\n                    </div>\n                </div>\n            ',n.title=e,a.appendChild(n);const o=t.querySelector("#version-info-badge");o&&(o.remove(),a.appendChild(o)),t.insertBefore(a,t.firstChild);const i=t.querySelector("#dashboardSchoolName");i&&i.remove()})}function a(e){if(!window.currentUser||!window.currentUser.schoolData||!window.currentUser.schoolData[4])return;if(e.querySelector(".school-name-top-row"))return;const t=window.currentUser.schoolData[4],a=document.createElement("div");a.className="school-name-top-row";const n=document.createElement("div");n.className="e-ijazah-logo-container",n.innerHTML='\n                <div class="logo-wrapper">\n                    <img src="/assets/logo-e-ijazah.svg" alt="E-Ijazah Logo" class="e-ijazah-logo">\n                    <div class="logo-text">\n                        <h1>APLIKASI NILAI E-IJAZAH</h1>\n                        <p>Platform Pendidikan Digital Indonesia</p>\n                    </div>\n                </div>\n            ',n.title=t,a.appendChild(n);const o=e.querySelector("#version-info-badge");o&&(o.remove(),a.appendChild(o)),e.insertBefore(a,e.firstChild);const i=e.querySelector("#dashboardSchoolName");i&&i.remove()}e&&(e.classList.add("disabled"),e.onclick=function(e){return e.preventDefault(),e.stopPropagation(),!1},e.style.opacity="0.5",e.style.pointerEvents="none",e.style.cursor="not-allowed",e.style.backgroundColor="#f0f0f0"),window.currentUser&&window.currentUser.schoolData&&(t(),function(){const e=new MutationObserver(function(e){e.forEach(function(e){if("attributes"===e.type&&"class"===e.attributeName){const t=e.target;t.classList.contains("content-section")&&t.classList.contains("active")&&setTimeout(()=>a(t),100)}})});document.querySelectorAll(".content-section").forEach(t=>{e.observe(t,{attributes:!0,attributeFilter:["class"]})})}(),window.addEventListener("userDataUpdated",t))}),document.addEventListener("DOMContentLoaded",function(){const e=document.getElementById("closeSiswaAdminModalBtn"),t=document.getElementById("cancelSiswaAdminBtn"),a=document.getElementById("siswaAdminForm");e&&e.addEventListener("click",closeSiswaAdminModal),t&&t.addEventListener("click",closeSiswaAdminModal),a&&a.addEventListener("submit",handleSiswaAdminSubmit),window.addEventListener("click",e=>{const t=document.getElementById("siswaAdminModal");e.target===t&&closeSiswaAdminModal()})}),document.addEventListener("click",e=>{const t=document.getElementById("photoModal");e.target===t&&closePhotoModal()}),document.addEventListener("keydown",e=>{if("Escape"===e.key){const e=document.getElementById("photoModal");e&&"flex"===e.style.display&&closePhotoModal()}}),document.addEventListener("DOMContentLoaded",()=>{const e=document.querySelector('[data-target="infoTerbaruSection"]');e&&e.addEventListener("click",e=>{e.preventDefault();document.querySelectorAll(".content-section").forEach(e=>e.classList.remove("active"));const t=document.getElementById("infoTerbaruSection");t&&(t.classList.add("active"),setTimeout(()=>{renderInfoTerbaru()},100))})}),document.addEventListener("DOMContentLoaded",function(){document.querySelectorAll(".password-toggle").forEach(e=>{e.addEventListener("click",function(){const e=this.getAttribute("data-target"),t=document.getElementById(e),a=this.querySelector(".eye-icon");"password"===t.type?(t.type="text",a.innerHTML='\n                    <path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"></path>\n                    <line x1="1" y1="1" x2="23" y2="23"></line>\n                '):(t.type="password",a.innerHTML='\n                    <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>\n                    <circle cx="12" cy="12" r="3"></circle>\n                ')})});const e=document.getElementById("changeAdminCodeForm");e&&e.addEventListener("submit",handleChangeAdminCode)}),document.addEventListener("DOMContentLoaded",function(){document.querySelectorAll(".menu-item").forEach(e=>{e.addEventListener("click",function(e){"pengaturanAkun"===this.getAttribute("data-target")&&setTimeout(()=>{loadAccountInfo()},100)})})}),document.addEventListener("click",function(e){document.querySelectorAll(".user-profile-dropdown").forEach(t=>{t.contains(e.target)||t.classList.remove("active")})}),document.addEventListener("keydown",function(e){"Escape"===e.key&&document.querySelectorAll(".user-profile-dropdown").forEach(e=>{e.classList.remove("active")})}),window.addEventListener("userLoggedIn",()=>{setTimeout(()=>{initializeUserProfile()},100)}),document.addEventListener("click",function(e){const t=document.getElementById("headerUserProfile");t&&(t.contains(e.target)||t.classList.remove("active"))}),window.forceClearCacheAndReload=async function(){try{Object.keys(tableDataCache).forEach(e=>{invalidateTableCache(e)});return Object.keys(localStorage).filter(e=>e.includes("database")||e.includes("cache")||e.includes("data")).forEach(e=>localStorage.removeItem(e)),await fetchDataFromServer(),showNotification("Data berhasil dimuat ulang dari server","success"),!0}catch(e){return console.error("Failed to force reload data:",e),showNotification("Gagal memuat ulang data: "+e.message,"error"),!1}},document.addEventListener("click",function(e){e.target.matches(".action-dropdown-btn")||closeAllDropdowns()});